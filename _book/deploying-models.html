<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 18 Deploying models | Telling Stories With Data</title>
<meta name="author" content="Rohan Alexander">
<meta name="description" content="STATUS: Under construction. Required reading Read Machine learning is going real-time, (Huyen 2020) Read Real-time machine learning: challenges and solutions, (Huyen 2022) Key concepts/skills/etc...">
<meta name="generator" content="bookdown 0.24 with bs4_book()">
<meta property="og:title" content="Chapter 18 Deploying models | Telling Stories With Data">
<meta property="og:type" content="book">
<meta property="og:image" content="/tellingstorieswithdatapainting.png">
<meta property="og:description" content="STATUS: Under construction. Required reading Read Machine learning is going real-time, (Huyen 2020) Read Real-time machine learning: challenges and solutions, (Huyen 2022) Key concepts/skills/etc...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 18 Deploying models | Telling Stories With Data">
<meta name="twitter:description" content="STATUS: Under construction. Required reading Read Machine learning is going real-time, (Huyen 2020) Read Real-time machine learning: challenges and solutions, (Huyen 2022) Key concepts/skills/etc...">
<meta name="twitter:image" content="/tellingstorieswithdatapainting.png">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.11/header-attrs.js"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><link href="libs/_Atkinson%20Hyperlegible-0.4.0/font.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=IBM%20Plex%20Mono&amp;display=swap" rel="stylesheet">
<script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script><link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet">
<script src="libs/leaflet-1.3.1/leaflet.js"></script><link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet">
<script src="libs/proj4-2.6.2/proj4.min.js"></script><script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script><link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet">
<script src="libs/leaflet-binding-2.0.4.1/leaflet.js"></script><script src="libs/mapdeck-binding-0.3.4/mapdeck.js"></script><script src="libs/mpadeck_functions-0.0.1/mapdeck_functions.js"></script><script src="libs/deckgl-8.1.6/deckgl.min.js"></script><script src="libs/legend-0.0.1/legend.js"></script><script src="libs/title-0.0.1/title.js"></script><script src="libs/mapdeck_location-0.0.1/mapdeck_location.js"></script><script src="libs/mapdeck_colours-0.0.1/mapdeck_colours.js"></script><script src="libs/mapdeck_coordinates-0.0.1/mapdeck_coordinates.js"></script><link href="libs/mapboxgl-1.10.0/mapbox-gl.css" rel="stylesheet">
<script src="libs/mapboxgl-1.10.0/mapbox-gl.js"></script><link href="libs/mapdeck-0.0.1/mapdeck.css" rel="stylesheet">
<script src="libs/mpadeck-binding-0.3.4/mapdeck.js"></script><script src="libs/scatterplot-1.0.0/scatterplot.js"></script><script src="libs/viz-1.8.2/viz.js"></script><link href="libs/DiagrammeR-styles-0.2/styles.css" rel="stylesheet">
<script src="libs/grViz-binding-1.0.6.1/grViz.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><link rel="stylesheet" href="bs4_style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Telling Stories With Data</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Preface</a></li>
<li><a class="" href="about-the-author.html">About the author</a></li>
<li class="book-part">Foundations</li>
<li><a class="" href="telling-stories-with-data.html"><span class="header-section-number">1</span> Telling stories with data</a></li>
<li><a class="" href="drinking-from-a-fire-hose.html"><span class="header-section-number">2</span> Drinking from a fire hose</a></li>
<li><a class="" href="r-essentials.html"><span class="header-section-number">3</span> R essentials</a></li>
<li><a class="" href="reproducible-workflows.html"><span class="header-section-number">4</span> Reproducible workflows</a></li>
<li class="book-part">Communication</li>
<li><a class="" href="on-writing.html"><span class="header-section-number">5</span> On writing</a></li>
<li><a class="" href="static-communication.html"><span class="header-section-number">6</span> Static communication</a></li>
<li><a class="" href="interactive-communication.html"><span class="header-section-number">7</span> Interactive communication</a></li>
<li class="book-part">Acquisition</li>
<li><a class="" href="farm-data.html"><span class="header-section-number">8</span> Farm data</a></li>
<li><a class="" href="gather-data.html"><span class="header-section-number">9</span> Gather data</a></li>
<li><a class="" href="hunt-data.html"><span class="header-section-number">10</span> Hunt data</a></li>
<li class="book-part">Preparation</li>
<li><a class="" href="clean-and-prepare.html"><span class="header-section-number">11</span> Clean and prepare</a></li>
<li><a class="" href="store-and-share.html"><span class="header-section-number">12</span> Store and share</a></li>
<li class="book-part">Modelling</li>
<li><a class="" href="exploratory-data-analysis.html"><span class="header-section-number">13</span> Exploratory data analysis</a></li>
<li><a class="" href="ijalm.html"><span class="header-section-number">14</span> It’s Just A Linear Model</a></li>
<li><a class="" href="causality.html"><span class="header-section-number">15</span> Causality from observational data</a></li>
<li><a class="" href="mrp.html"><span class="header-section-number">16</span> Multilevel regression with post-stratification</a></li>
<li><a class="" href="text-as-data.html"><span class="header-section-number">17</span> Text as data</a></li>
<li class="book-part">Enrichment</li>
<li><a class="active" href="deploying-models.html"><span class="header-section-number">18</span> Deploying models</a></li>
<li><a class="" href="efficiency.html"><span class="header-section-number">19</span> Efficiency</a></li>
<li><a class="" href="concludingremarks.html"><span class="header-section-number">20</span> Concluding remarks</a></li>
<li class="book-part">Appendix</li>
<li><a class="" href="oh-you-think-and-shoulders-and-datasets.html"><span class="header-section-number">A</span> Oh you think and shoulders and datasets</a></li>
<li><a class="" href="papers.html"><span class="header-section-number">B</span> Papers</a></li>
<li><a class="" href="cocktails.html"><span class="header-section-number">C</span> Cocktails</a></li>
<li><a class="" href="references-1.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/rstudio/bookdown-demo">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="deploying-models" class="section level1" number="18">
<h1>
<span class="header-section-number">18</span> Deploying models<a class="anchor" aria-label="anchor" href="#deploying-models"><i class="fas fa-link"></i></a>
</h1>
<p><strong>STATUS: Under construction.</strong></p>
<p><strong>Required reading</strong></p>
<ul>
<li>Read <em>Machine learning is going real-time</em>, <span class="citation">(<a href="references-1.html#ref-chiphuyenone" role="doc-biblioref">Huyen 2020</a>)</span>
</li>
<li>Read <em>Real-time machine learning: challenges and solutions</em>, <span class="citation">(<a href="references-1.html#ref-chiphuyentwo" role="doc-biblioref">Huyen 2022</a>)</span>
</li>
</ul>
<!-- **Required viewing** --><!-- - Blair, James, 2019, 'Democratizing R with Plumber APIs', RStudio Conference, 24 January, https://www.rstudio.com/resources/rstudioconf-2019/democratizing-r-with-plumber-apis/. --><!-- - Nolis, Heather, and Jacqueline Nolis, 'We're hitting R a million times a day so we made a talk about it', RStudio Conference, 30 January, https://www.rstudio.com/resources/rstudioconf-2020/we-re-hitting-r-a-million-times-a-day-so-we-made-a-talk-about-it/. --><!-- **Recommended reading** --><!-- - Edmondson, Mark, 2020, 'googleComputeEngineR documentation', version 0.3.0.9000, freely available at: https://cloudyr.github.io/googleComputeEngineR/. --><!-- - McDermott, Grant R., 2020, 'Cloud computing with Google Compute Engine', *Data Science for Economists*, freely available at: https://raw.githack.com/uo-ec607/lectures/master/14-gce/14-gce.html. --><!-- - Morris, Mitzi, 2020, 'Stan Notebooks in the Cloud', freely available at: https://mc-stan.org/users/documentation/case-studies/jupyter_colab_notebooks_2020.html. --><p><strong>Key concepts/skills/etc</strong></p>
<ul>
<li>Benefits/costs of cloud.</li>
<li>Getting started in the cloud.</li>
<li>Starting virtual machines with R Studio.</li>
<li>Stopping virtual machines.</li>
<li>Putting models into production requires a different set of skills to building a model. We need a familiarity with some cloud provider, APIs, and of course modelling. But the biggest difficulty, for me, is getting things set-up.</li>
</ul>
<p><strong>Key libraries</strong></p>
<ul>
<li>
<code>plumber</code> <span class="citation">(<a href="references-1.html#ref-plumber" role="doc-biblioref">Schloerke and Allen 2021</a>)</span>
</li>
<li><code>shiny</code></li>
</ul>
<div id="introduction-15" class="section level2" number="18.1">
<h2>
<span class="header-section-number">18.1</span> Introduction<a class="anchor" aria-label="anchor" href="#introduction-15"><i class="fas fa-link"></i></a>
</h2>
<p>A key troupe against R is that it’s not for production. I’m not here to convince you one way or another, however in this section we will go through a bunch of different tools that would allow you to do a lot in R if you wanted. The topics that we cover are:</p>
<ul>
<li>SQL databases.</li>
<li>Docker.</li>
<li>Plumber and APIs for models.</li>
<li>Shiny</li>
<li>Packages</li>
</ul>
<p>The general idea here is that you need to know the whole workflow. To this point, you’ve been able to scrape some data from a website, bring some order to that chaos, make some charts, appropriately model it, and write this all up. In most academic settings that is more than enough. But in many industry settings we’re going to want to use the model to do something. For instance, set-up a website that allows your model to be used to generate an insurance quote given several inputs.</p>
<p>One way to deploy your model is to use Shiny, and we have seen examples of this earlier in the notes. That enables an individual to use your model. But it doesn’t really scale very well. For instance, if we wanted to sell our model forecasts to other businesses, then they might have their own way in which they would like users to interact with the results. The general problem is that we want our model results available to other machines and for that we will want to make an APIs.</p>
<p>Cloud benefits:
- Costs can be reduced, or more easily amortized.
- Can scale as you need.
- Many platforms are already sorted out e.g. R Studio just works.</p>
<p>I stole this from someone and I can’t remember who, but the cloud is another name for ‘someone else’s computer.’ That’s it. Nonetheless, learning to use someone else’s computer can be great for a number of reasons including:</p>
<ol style="list-style-type: decimal">
<li>Scalability: It can be quite expensive to buy a new computer, especially if you only need it to run something every now and then, but by using someone else’s computer, you can just rent for a few hours or days.</li>
<li>Portability: If you can shift your analysis workflow from your laptop to the cloud, then that suggests that you are likely doing good things in terms of reproducibility and portability. At the very least, your code is capable of running on your laptop and the cloud.</li>
<li>Set-and-forget: If you are doing something that will take a while, then it can be great to not have to worry about your laptop’s fan running overnight, or your partner/baby/pet/housemate/etc accidently closing your computer, or not being able to watch Netflix on that same computer.</li>
</ol>
<p>When you use the cloud you are running your code on a ‘virtual machine.’ This is a part of a larger bunch of computers that has been designed to act like a computer with specific features. For instance you may specify that your virtual machine has 8 GB RAM, 128 storage, and 4 CPUs. Your VM would then act like a computer with those specifications. The cost to use cloud options increases based on the specifications of the virtual machine that you choose.</p>
<p>There are a few downsides:</p>
<ul>
<li>Cost: While most cloud options are cheap, they are rarely free. (While there are free options, they tend to not be very powerful, and so you end up having to pay to get a computer that is better than your laptop.) To give you an idea of cost, when I use AWS, I typically end up spending five to ten dollars for a couple of days. So it’s fairly cheap, but it’s not nothing. It’s also pretty easy to accidently forget about something and run up an unexpected bill, especially initially.</li>
<li>Public: It is pretty easy to make mistakes and accidently make everything public.</li>
<li>Time: It takes time to get set-up and comfortable on the cloud.</li>
</ul>
<p>In these notes we are going to introduce the cloud starting with some options that pretty much anyone can (and should) take advantage of: Google Colab; and then moving to more general cloud options including Google Compute Engine, AWS, and Azure, which may be useful to some of you in some cases. If you want to get a job in industry, then the advice of pretty much every speaker from industry at the Toronto Data Workshop is that you learn at least one of those cloud options. For instance, Munich Re is an Azure shop, Receptiviti uses AWS, etc.</p>
</div>
<div id="using-the-cloud" class="section level2" number="18.2">
<h2>
<span class="header-section-number">18.2</span> Using the cloud<a class="anchor" aria-label="anchor" href="#using-the-cloud"><i class="fas fa-link"></i></a>
</h2>
<div id="google-colab" class="section level3" number="18.2.1">
<h3>
<span class="header-section-number">18.2.1</span> Google Colab<a class="anchor" aria-label="anchor" href="#google-colab"><i class="fas fa-link"></i></a>
</h3>
<p>Google Colab is similar to R Studio Cloud, in that it is set-up to allow you to just log in and get started. In this case, you need a Google account. It’s better than R Studio because they have more resources to put into its development and you can use GPUs, but but on the other hand it is designed for Python, and while we can use it for R, it’s not really focused on that.</p>
<p>To get started you need to tell Google Colab that you want to use R. You can do this by using this: <a href="https://colab.research.google.com/notebook#create=true&amp;language=r" class="uri">https://colab.research.google.com/notebook#create=true&amp;language=r</a>.</p>
<p>At this point you have a Jupyter notebook open that will run R. (But it is not a R Markdown document.) You can install packages as normal, e.g. <code>install.packages("tidyverse")</code>, and then call the package e.g. <code><a href="https://tidyverse.tidyverse.org">library(tidyverse)</a></code>.</p>
<p>Google Colab is a good option if you have a good reason for using the broader capabilities that it has. If you want to go deeper into that then the Morris reading has a bunch of options that you can explore, but as Morris puts it ‘Colab is a gateway drug - for large-scale processing pipelines you’ll need to move up to Google Cloud Platform or one of its competitors AWS, Azure, etc.’ and that is what we will do now.</p>
</div>
<div id="aws" class="section level3" number="18.2.2">
<h3>
<span class="header-section-number">18.2.2</span> AWS<a class="anchor" aria-label="anchor" href="#aws"><i class="fas fa-link"></i></a>
</h3>
<p>Amazon Web Services is a cloud service from Amazon. To get started you need an AWS Developer account which you can create here: <a href="https://aws.amazon.com/developer/" class="uri">https://aws.amazon.com/developer/</a>.</p>
<p>After you have created an account, you need to select a region where the computer that you will access is located. After this, you will want to “Launch a virtual machine” (with EC2).</p>
<p>The first step is to choose an Amazon Machine Image (AMI). This provides the details of the computer that you will be using. For instance, your local computer may be a MacBook running Catalina. Helpfully, Louis Aslett provides a bunch of these already set up - <a href="http://www.louisaslett.com/RStudio_AMI/" class="uri">http://www.louisaslett.com/RStudio_AMI/</a>. You can either select the code for the region that you registered for, or you can click on the link. The benefit of this AMI is that they are set-up specifically for R Studio, however the trade-off is that they are a little out-dated, as they were compiled in May 2019.</p>
<p>In the next step you can choose how powerful the computer will be. The free tier has a fairly basic computer, but you can choose better ones when you need them. At this point you can pretty much just launch the instance. If you start using AWS more seriously then you should look into different security settings.</p>
<p>Your instance is now running. You can go to it by pasting the ‘public DNS’ into a browser. The username is ‘rstudio’ and the password is your instance ID.</p>
<p>You should have R Studio running, which is exciting. The first thing to do is probably to change the default password using the instructions in the instance.</p>
<p>You don’t need to install, say, the tidyverse, instead you can just call the library and keep going. You can see the list of packages that are installed with <code><a href="https://rdrr.io/r/utils/installed.packages.html">installed.packages()</a></code>. For instance, <code>rstan</code> is already installed. And you can use GPUs if you want.</p>
<p>Perhaps as important as being able to start an AWS instance is being able to stop it (so that you don’t get billed). The free tier is pretty great, but you do need to turn it off. To stop an instance, in the AWS instances page, select it, then ‘Actions -&gt; Instance State -&gt; Terminate.’</p>
</div>
<div id="google-compute-engine" class="section level3" number="18.2.3">
<h3>
<span class="header-section-number">18.2.3</span> Google Compute Engine<a class="anchor" aria-label="anchor" href="#google-compute-engine"><i class="fas fa-link"></i></a>
</h3>
<p>The main R package related to Google Compute Engine seems to be: <code>googleComputeEngineR</code>.</p>
<p>The reading from Grant McDermott is a pretty good walk-through.</p>
</div>
</div>
<div id="r-packages" class="section level2" number="18.3">
<h2>
<span class="header-section-number">18.3</span> R packages<a class="anchor" aria-label="anchor" href="#r-packages"><i class="fas fa-link"></i></a>
</h2>
<p>To this point we’ve largely been using R Packages to do things for us. However, another way is to have them loaded</p>
<p>DoSS Toolkit</p>
</div>
<div id="shiny-1" class="section level2" number="18.4">
<h2>
<span class="header-section-number">18.4</span> Shiny<a class="anchor" aria-label="anchor" href="#shiny-1"><i class="fas fa-link"></i></a>
</h2>
</div>
<div id="plumber-and-model-apis" class="section level2" number="18.5">
<h2>
<span class="header-section-number">18.5</span> Plumber and model APIs<a class="anchor" aria-label="anchor" href="#plumber-and-model-apis"><i class="fas fa-link"></i></a>
</h2>
<div id="hello-toronto" class="section level3" number="18.5.1">
<h3>
<span class="header-section-number">18.5.1</span> Hello Toronto<a class="anchor" aria-label="anchor" href="#hello-toronto"><i class="fas fa-link"></i></a>
</h3>
<p>The general idea behind the <code>plumber</code> package <span class="citation">(<a href="references-1.html#ref-plumber" role="doc-biblioref">Schloerke and Allen 2021</a>)</span> is that we can train a model and make it available via an API that we can call when we want a forecast. It’s pretty great.</p>
<p>Just to get something working, let’s make a function that returns ‘Hello Toronto’ regardless of the output. Open a new R file, add the following, and then save it as ‘plumber.R’ (you may need to install the <code>plumber</code> package if you’ve not done that yet).</p>
<div class="sourceCode" id="cb576"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://www.rplumber.io">plumber</a></span><span class="op">)</span>

<span class="co">#* @get /print_toronto</span>
<span class="va">print_toronto</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">result</span> <span class="op">&lt;-</span> <span class="st">"Hello Toronto"</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>After that is saved, in the top right of the editor you should get a button to ‘Run API.’ Click that, and your API should load. It’ll be a ‘Swagger’ application, which provides a GUI around our API. Expand the GET method, and then click ‘Try it out’ and ‘Execute.’ In the response body, you should get ‘Toronto.’</p>
<p>To more closely reflect the fact that this is an API designed for computers, you can copy/paste the ‘request HTML’ into a browser and it should return ‘Hello Toronto.’</p>
</div>
<div id="local-model" class="section level3" number="18.5.2">
<h3>
<span class="header-section-number">18.5.2</span> Local model<a class="anchor" aria-label="anchor" href="#local-model"><i class="fas fa-link"></i></a>
</h3>
<p>Now, we’re going to update the API so that it serves a model output, given some input. We’re going to follow <span class="citation"><a href="references-1.html#ref-buhrplumber" role="doc-biblioref">Buhr</a> (<a href="references-1.html#ref-buhrplumber" role="doc-biblioref">2017</a>)</span> fairly closely.</p>
<p>At this point, I’d recommend starting a new R Project. To get started, let’s simulate some data and then train a model on it. In this case we’re interested in forecasting how long a baby may sleep overnight, given we know how long they slept during their afternoon nap.</p>
<div class="sourceCode" id="cb577"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">853</span><span class="op">)</span>

<span class="va">number_of_observations</span> <span class="op">&lt;-</span> <span class="fl">1000</span>

<span class="va">baby_sleep</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>afternoon_nap_length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">number_of_observations</span>, <span class="fl">120</span>, <span class="fl">5</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="op">)</span>,
         noise <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">number_of_observations</span>, <span class="fl">0</span>, <span class="fl">120</span><span class="op">)</span>,
         night_sleep_length <span class="op">=</span> <span class="va">afternoon_nap_length</span> <span class="op">*</span> <span class="fl">4</span> <span class="op">+</span> <span class="va">noise</span>,
         <span class="op">)</span>

<span class="va">baby_sleep</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">afternoon_nap_length</span>, y <span class="op">=</span> <span class="va">night_sleep_length</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Baby's afternoon nap length (minutes)"</span>,
       y <span class="op">=</span> <span class="st">"Baby's overnight sleep length (minutes)"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>Let’s now use <code>tidymodels</code> to quickly make a dodgy model.</p>
<div class="sourceCode" id="cb578"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">853</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidymodels.tidymodels.org">tidymodels</a></span><span class="op">)</span>

<span class="va">baby_sleep_split</span> <span class="op">&lt;-</span> <span class="fu">rsample</span><span class="fu">::</span><span class="fu"><a href="https://rsample.tidymodels.org/reference/initial_split.html">initial_split</a></span><span class="op">(</span><span class="va">baby_sleep</span>, prop <span class="op">=</span> <span class="fl">0.80</span><span class="op">)</span>
<span class="va">baby_sleep_train</span> <span class="op">&lt;-</span> <span class="fu">rsample</span><span class="fu">::</span><span class="fu"><a href="https://rsample.tidymodels.org/reference/initial_split.html">training</a></span><span class="op">(</span><span class="va">baby_sleep_split</span><span class="op">)</span>
<span class="va">baby_sleep_test</span> <span class="op">&lt;-</span> <span class="fu">rsample</span><span class="fu">::</span><span class="fu"><a href="https://rsample.tidymodels.org/reference/initial_split.html">testing</a></span><span class="op">(</span><span class="va">baby_sleep_split</span><span class="op">)</span>

<span class="va">model</span> <span class="op">&lt;-</span> 
  <span class="fu">parsnip</span><span class="fu">::</span><span class="fu"><a href="https://parsnip.tidymodels.org/reference/linear_reg.html">linear_reg</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu">parsnip</span><span class="fu">::</span><span class="fu"><a href="https://parsnip.tidymodels.org/reference/set_engine.html">set_engine</a></span><span class="op">(</span>engine <span class="op">=</span> <span class="st">"lm"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">parsnip</span><span class="fu">::</span><span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span><span class="va">night_sleep_length</span> <span class="op">~</span> <span class="va">afternoon_nap_length</span>, 
               data <span class="op">=</span> <span class="va">baby_sleep_train</span>
               <span class="op">)</span>

<span class="fu"><a href="https://readr.tidyverse.org/reference/read_rds.html">write_rds</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">model</span>, file <span class="op">=</span> <span class="st">"baby_sleep.rds"</span><span class="op">)</span></code></pre></div>
<p>At this point, we have a model. One difference from what you might be used to is that we’ve saved the model as an ‘.rds’ file. We are going to read that in.</p>
<p>Now that we have our model we want to put that into a file that we will use the API to access, again called ‘plumber.R.’ And we also want a file that sets up the API, called ‘server.R.’ So make an R script called ‘server.R’ and add the following content:</p>
<div class="sourceCode" id="cb579"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://www.rplumber.io">plumber</a></span><span class="op">)</span>

<span class="va">serve_model</span> <span class="op">&lt;-</span> <span class="fu">plumb</span><span class="op">(</span><span class="st">"plumber.R"</span><span class="op">)</span>
<span class="va">serve_model</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span>port <span class="op">=</span> <span class="fl">8000</span><span class="op">)</span></code></pre></div>
<p>Then in ‘plumber.R’ add the following content:</p>
<div class="sourceCode" id="cb580"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://www.rplumber.io">plumber</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>

<span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"baby_sleep.rds"</span><span class="op">)</span>

<span class="va">version_number</span> <span class="op">&lt;-</span> <span class="st">"0.0.1"</span>

<span class="va">variables</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    afternoon_nap_length <span class="op">=</span> <span class="st">"A value in minutes, likely between 0 and 240."</span>,
    night_sleep_length <span class="op">=</span> <span class="st">"A forecast, in minutes, likely between 0 and 1000."</span>
  <span class="op">)</span>

<span class="co">#* @param afternoon_nap_length</span>
<span class="co">#* @get /survival</span>
<span class="va">predict_sleep</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">afternoon_nap_length</span><span class="op">=</span><span class="fl">0</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">afternoon_nap_length</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">afternoon_nap_length</span><span class="op">)</span>
  
  <span class="va">payload</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>afternoon_nap_length<span class="op">=</span><span class="va">afternoon_nap_length</span><span class="op">)</span>
  
  <span class="va">prediction</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">payload</span><span class="op">)</span>

  <span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    input <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">payload</span><span class="op">)</span>,
    response <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"estimated_night_sleep"</span> <span class="op">=</span> <span class="va">prediction</span><span class="op">)</span>,
    status <span class="op">=</span> <span class="fl">200</span>,
    model_version <span class="op">=</span> <span class="va">version_number</span><span class="op">)</span>

  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Again, after you save the ‘plumber.R’ file you should have an option to ‘Run API.’ Click that and you can try out the API locally in the same way as before.</p>
</div>
<div id="cloud-model" class="section level3" number="18.5.3">
<h3>
<span class="header-section-number">18.5.3</span> Cloud model<a class="anchor" aria-label="anchor" href="#cloud-model"><i class="fas fa-link"></i></a>
</h3>
<p>To this point, we’ve got an API working on our own machine, but what we really want to do is to get it working on a computer such that the API can be accessed by anyone. To do this we are going to use DigitalOcean - <a href="https://www.digitalocean.com" class="uri">https://www.digitalocean.com</a>. It is a charged service, but when you create an account, it will come with $100 in credit, which will be enough to get started.</p>
<p>This set-up process will be a pain and take some time, but you only need to do it once. Install two additional packages that will assist here:</p>
<ul>
<li>
<code>plumberDeploy</code> <span class="citation">(<a href="references-1.html#ref-plumberdeploy" role="doc-biblioref">Allen 2021</a>)</span>.</li>
<li>
<code>analogsea</code> <span class="citation">(<a href="references-1.html#ref-citeanalogsea" role="doc-biblioref">Chamberlain, Wickham, and Chang 2021</a>)</span>.</li>
</ul>
<div class="sourceCode" id="cb581"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"plumberDeploy"</span><span class="op">)</span>
<span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html">install_github</a></span><span class="op">(</span><span class="st">"sckott/analogsea"</span><span class="op">)</span></code></pre></div>
<p>Now we need to connect your local computer with your DigitalOcean account. Get started with:</p>
<div class="sourceCode" id="cb582"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">analogsea</span><span class="fu">::</span><span class="fu">account</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>Now you need to authenticate the connection and this is done using a SSH public key. You can do this using:</p>
<div class="sourceCode" id="cb583"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">analogsea</span><span class="fu">::</span><span class="fu">key_create</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>But if this is your first time doing this then it may be more useful to have a visual process, in which case follow the instructions here: <a href="https://docs.digitalocean.com/products/droplets/how-to/add-ssh-keys/to-account/" class="uri">https://docs.digitalocean.com/products/droplets/how-to/add-ssh-keys/to-account/</a>. What you want is to have a ‘.pub’ file on your computer. Then copy the public key aspect in that file, and add it to the SSH keys section in the account security settings. When you have the key on your local computer then you can check this using:</p>
<div class="sourceCode" id="cb584"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ssh</span><span class="fu">::</span><span class="fu">ssh_key_info</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>Again, this will all take a while to validate. DigitalOcean calls every computer that you start a ‘droplet.’ So if you start three computers, then you’ll have started three droplets. You can check the droplets that you have running using:</p>
<div class="sourceCode" id="cb585"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">analogsea</span><span class="fu">::</span><span class="fu">droplets</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>If everything is set-up properly, then this will print the information about all droplets that you have associated with your account (which at this point, is probably none).</p>
<p>To create a droplet, you run:</p>
<div class="sourceCode" id="cb586"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">id</span> <span class="op">&lt;-</span> <span class="fu">plumberDeploy</span><span class="fu">::</span><span class="fu">do_provision</span><span class="op">(</span>example <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p>Then you’ll get asked for your SSH passphrase and then it’ll just set-up a bunch of things. After this we’re going to need to install a whole bunch of things onto our droplet:</p>
<div class="sourceCode" id="cb587"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">analogsea</span><span class="fu">::</span><span class="fu">install_r_package</span><span class="op">(</span>droplet <span class="op">=</span> <span class="va">id</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"plumber"</span>, 
                                             <span class="st">"remotes"</span>, 
                                             <span class="st">"here"</span><span class="op">)</span><span class="op">)</span>
<span class="fu">analogsea</span><span class="fu">::</span><span class="fu">debian_apt_get_install</span><span class="op">(</span><span class="va">id</span>, <span class="st">"libssl-dev"</span>, 
                                  <span class="st">"libsodium-dev"</span>, 
                                  <span class="st">"libcurl4-openssl-dev"</span><span class="op">)</span>
<span class="fu">analogsea</span><span class="fu">::</span><span class="fu">debian_apt_get_install</span><span class="op">(</span><span class="va">id</span>, 
                                  <span class="st">"libxml2-dev"</span><span class="op">)</span>

<span class="fu">analogsea</span><span class="fu">::</span><span class="fu">install_r_package</span><span class="op">(</span><span class="va">id</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"config"</span>,
                                   <span class="st">"httr"</span>,
                                   <span class="st">"urltools"</span>,
                                   <span class="st">"plumber"</span><span class="op">)</span><span class="op">)</span>

<span class="fu">analogsea</span><span class="fu">::</span><span class="fu">install_r_package</span><span class="op">(</span><span class="va">id</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"xml2"</span><span class="op">)</span><span class="op">)</span>
<span class="fu">analogsea</span><span class="fu">::</span><span class="fu">install_r_package</span><span class="op">(</span><span class="va">id</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"tidyverse"</span><span class="op">)</span><span class="op">)</span>

<span class="fu">analogsea</span><span class="fu">::</span><span class="fu">install_r_package</span><span class="op">(</span><span class="va">id</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"tidymodels"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>And then when that is finally set-up (it’ll seriously take 30 min or so) we can deploy our API!</p>
<div class="sourceCode" id="cb588"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">plumberDeploy</span><span class="fu">::</span><span class="fu">do_deploy_api</span><span class="op">(</span>droplet <span class="op">=</span> <span class="va">id</span>, 
                             path <span class="op">=</span> <span class="st">"example"</span>, 
                             localPath <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/getwd.html">getwd</a></span><span class="op">(</span><span class="op">)</span>, 
                             port <span class="op">=</span> <span class="fl">8000</span>, 
                             docs <span class="op">=</span> <span class="cn">TRUE</span>, 
                             overwrite<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="exercises-and-tutorial-17" class="section level2" number="18.6">
<h2>
<span class="header-section-number">18.6</span> Exercises and tutorial<a class="anchor" aria-label="anchor" href="#exercises-and-tutorial-17"><i class="fas fa-link"></i></a>
</h2>
<div id="exercises-17" class="section level3" number="18.6.1">
<h3>
<span class="header-section-number">18.6.1</span> Exercises<a class="anchor" aria-label="anchor" href="#exercises-17"><i class="fas fa-link"></i></a>
</h3>
</div>
<div id="tutorial-17" class="section level3" number="18.6.2">
<h3>
<span class="header-section-number">18.6.2</span> Tutorial<a class="anchor" aria-label="anchor" href="#tutorial-17"><i class="fas fa-link"></i></a>
</h3>

</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="text-as-data.html"><span class="header-section-number">17</span> Text as data</a></div>
<div class="next"><a href="efficiency.html"><span class="header-section-number">19</span> Efficiency</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#deploying-models"><span class="header-section-number">18</span> Deploying models</a></li>
<li><a class="nav-link" href="#introduction-15"><span class="header-section-number">18.1</span> Introduction</a></li>
<li>
<a class="nav-link" href="#using-the-cloud"><span class="header-section-number">18.2</span> Using the cloud</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#google-colab"><span class="header-section-number">18.2.1</span> Google Colab</a></li>
<li><a class="nav-link" href="#aws"><span class="header-section-number">18.2.2</span> AWS</a></li>
<li><a class="nav-link" href="#google-compute-engine"><span class="header-section-number">18.2.3</span> Google Compute Engine</a></li>
</ul>
</li>
<li><a class="nav-link" href="#r-packages"><span class="header-section-number">18.3</span> R packages</a></li>
<li><a class="nav-link" href="#shiny-1"><span class="header-section-number">18.4</span> Shiny</a></li>
<li>
<a class="nav-link" href="#plumber-and-model-apis"><span class="header-section-number">18.5</span> Plumber and model APIs</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#hello-toronto"><span class="header-section-number">18.5.1</span> Hello Toronto</a></li>
<li><a class="nav-link" href="#local-model"><span class="header-section-number">18.5.2</span> Local model</a></li>
<li><a class="nav-link" href="#cloud-model"><span class="header-section-number">18.5.3</span> Cloud model</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#exercises-and-tutorial-17"><span class="header-section-number">18.6</span> Exercises and tutorial</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#exercises-17"><span class="header-section-number">18.6.1</span> Exercises</a></li>
<li><a class="nav-link" href="#tutorial-17"><span class="header-section-number">18.6.2</span> Tutorial</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/rstudio/bookdown-demo/blob/master/50-deploy.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/rstudio/bookdown-demo/edit/master/50-deploy.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Telling Stories With Data</strong>" was written by Rohan Alexander. It was last built on 23 February, 2022.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
