<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 8 Gather data | Telling Stories With Data</title>
<meta name="author" content="Rohan Alexander">
<meta name="description" content="STATUS: Under construction. Recommended reading Benoit, Kenneth, 2019, ‘Text as data: An overview,’ 17 July, https://kenbenoit.net/pdfs/28%20Benoit%20Text%20as%20Data%20draft%202.pdf. Bolton,...">
<meta name="generator" content="bookdown 0.24 with bs4_book()">
<meta property="og:title" content="Chapter 8 Gather data | Telling Stories With Data">
<meta property="og:type" content="book">
<meta property="og:image" content="/tellingstorieswithdatapainting.png">
<meta property="og:description" content="STATUS: Under construction. Recommended reading Benoit, Kenneth, 2019, ‘Text as data: An overview,’ 17 July, https://kenbenoit.net/pdfs/28%20Benoit%20Text%20as%20Data%20draft%202.pdf. Bolton,...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 8 Gather data | Telling Stories With Data">
<meta name="twitter:description" content="STATUS: Under construction. Recommended reading Benoit, Kenneth, 2019, ‘Text as data: An overview,’ 17 July, https://kenbenoit.net/pdfs/28%20Benoit%20Text%20as%20Data%20draft%202.pdf. Bolton,...">
<meta name="twitter:image" content="/tellingstorieswithdatapainting.png">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.11/header-attrs.js"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><link href="libs/_Atkinson%20Hyperlegible-0.4.0/font.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=IBM%20Plex%20Mono&amp;display=swap" rel="stylesheet">
<script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script><link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet">
<script src="libs/leaflet-1.3.1/leaflet.js"></script><link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet">
<script src="libs/proj4-2.6.2/proj4.min.js"></script><script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script><link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet">
<script src="libs/leaflet-binding-2.0.4.1/leaflet.js"></script><script src="libs/mapdeck-binding-0.3.4/mapdeck.js"></script><script src="libs/mpadeck_functions-0.0.1/mapdeck_functions.js"></script><script src="libs/deckgl-8.1.6/deckgl.min.js"></script><script src="libs/legend-0.0.1/legend.js"></script><script src="libs/title-0.0.1/title.js"></script><script src="libs/mapdeck_location-0.0.1/mapdeck_location.js"></script><script src="libs/mapdeck_colours-0.0.1/mapdeck_colours.js"></script><script src="libs/mapdeck_coordinates-0.0.1/mapdeck_coordinates.js"></script><link href="libs/mapboxgl-1.10.0/mapbox-gl.css" rel="stylesheet">
<script src="libs/mapboxgl-1.10.0/mapbox-gl.js"></script><link href="libs/mapdeck-0.0.1/mapdeck.css" rel="stylesheet">
<script src="libs/mpadeck-binding-0.3.4/mapdeck.js"></script><script src="libs/scatterplot-1.0.0/scatterplot.js"></script><script src="libs/viz-1.8.2/viz.js"></script><link href="libs/DiagrammeR-styles-0.2/styles.css" rel="stylesheet">
<script src="libs/grViz-binding-1.0.6.1/grViz.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><link rel="stylesheet" href="bs4_style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Telling Stories With Data</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Preface</a></li>
<li><a class="" href="about-the-author.html">About the author</a></li>
<li class="book-part">Foundations</li>
<li><a class="" href="telling-stories-with-data.html"><span class="header-section-number">1</span> Telling Stories with Data</a></li>
<li><a class="" href="drinking-from-a-fire-hose.html"><span class="header-section-number">2</span> Drinking from a fire hose</a></li>
<li><a class="" href="r-essentials.html"><span class="header-section-number">3</span> R Essentials</a></li>
<li><a class="" href="workflow.html"><span class="header-section-number">4</span> Workflow</a></li>
<li class="book-part">Communication</li>
<li><a class="" href="on-writing.html"><span class="header-section-number">5</span> On writing</a></li>
<li><a class="" href="static-communication.html"><span class="header-section-number">6</span> Static communication</a></li>
<li><a class="" href="interactive-communication.html"><span class="header-section-number">7</span> Interactive communication</a></li>
<li class="book-part">Measure and acquire</li>
<li><a class="active" href="gather-data.html"><span class="header-section-number">8</span> Gather data</a></li>
<li><a class="" href="hunt-data.html"><span class="header-section-number">9</span> Hunt data</a></li>
<li><a class="" href="farm-data.html"><span class="header-section-number">10</span> Farm data</a></li>
<li class="book-part">Preparation</li>
<li><a class="" href="cleaning-and-preparing-data.html"><span class="header-section-number">11</span> Cleaning and preparing data</a></li>
<li><a class="" href="storing-and-retrieving-data.html"><span class="header-section-number">12</span> Storing and retrieving data</a></li>
<li><a class="" href="disseminating-and-protecting-data.html"><span class="header-section-number">13</span> Disseminating and protecting data</a></li>
<li class="book-part">Modelling</li>
<li><a class="" href="exploratory-data-analysis.html"><span class="header-section-number">14</span> Exploratory data analysis</a></li>
<li><a class="" href="ijalm.html"><span class="header-section-number">15</span> It’s Just A Linear Model</a></li>
<li><a class="" href="causality.html"><span class="header-section-number">16</span> Causality from observational data</a></li>
<li><a class="" href="mrp.html"><span class="header-section-number">17</span> Multilevel regression with post-stratification</a></li>
<li><a class="" href="text-as-data.html"><span class="header-section-number">18</span> Text as data</a></li>
<li class="book-part">Enrichment</li>
<li><a class="" href="using-the-cloud.html"><span class="header-section-number">19</span> Using the cloud</a></li>
<li><a class="" href="deploying-models.html"><span class="header-section-number">20</span> Deploying models</a></li>
<li><a class="" href="efficiency.html"><span class="header-section-number">21</span> Efficiency</a></li>
<li><a class="" href="concludingremarks.html"><span class="header-section-number">22</span> Concluding remarks, open issues, next steps</a></li>
<li class="book-part">Appendix</li>
<li><a class="" href="oh-you-think-and-shoulders.html"><span class="header-section-number">A</span> Oh you think and shoulders</a></li>
<li><a class="" href="papers.html"><span class="header-section-number">B</span> Papers</a></li>
<li><a class="" href="references-1.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/rstudio/bookdown-demo">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="gather-data" class="section level1" number="8">
<h1>
<span class="header-section-number">8</span> Gather data<a class="anchor" aria-label="anchor" href="#gather-data"><i class="fas fa-link"></i></a>
</h1>
<p><strong>STATUS: Under construction.</strong></p>
<p><strong>Recommended reading</strong></p>
<ul>
<li>Benoit, Kenneth, 2019, ‘Text as data: An overview,’ 17 July, <a href="https://kenbenoit.net/pdfs/28%20Benoit%20Text%20as%20Data%20draft%202.pdf" class="uri">https://kenbenoit.net/pdfs/28%20Benoit%20Text%20as%20Data%20draft%202.pdf</a>.</li>
<li>Bolton, Liza, 2019, ‘A quick look at museums per capita,’ 26 March, <a href="http://blog.dataembassy.co.nz/museums-per-capita/" class="uri">http://blog.dataembassy.co.nz/museums-per-capita/</a>.</li>
<li>Bryan, Jennifer, and Jim Hester, 2020, <em>What They Forgot to Teach You About R</em>, Chapter 7, <a href="https://rstats.wtf/index.html" class="uri">https://rstats.wtf/index.html</a>.</li>
<li>Cardoso, Tom, 2019, ‘Introduction to scraping,’ <a href="https://github.com/tomcardoso/intro-to-scraping" class="uri">https://github.com/tomcardoso/intro-to-scraping</a>.</li>
<li>Clavelle, Tyler, 2017, ‘Using R to extract data from web APIs,’ 5 June, <a href="https://www.tylerclavelle.com/code/2017/randapis/" class="uri">https://www.tylerclavelle.com/code/2017/randapis/</a>.</li>
<li>Cooksey, Brian, 2014, ‘An Introduction to APIs,’ Zapier, 22 April, <a href="https://zapier.com/learn/apis/" class="uri">https://zapier.com/learn/apis/</a>.</li>
<li>Dogucu, Mine, and Mine Çetinkaya-Runde, 2020 ,‘Web Scraping in the Statistics and Data Science Curriculum: Challenges and Opportunities,’ 6 May.</li>
<li>Gelfand, Sharla, 2019, ‘Crying @ Sephora,’ 8 November, <a href="https://sharla.party/post/crying-sephora/" class="uri">https://sharla.party/post/crying-sephora/</a>.</li>
<li>Goldman, Shayna, 2019, ‘How Much Do NHL Players Really Make? Part 2: Taxes,’ <a href="https://hockey-graphs.com/2019/01/08/how-much-do-nhl-players-really-make-part-2-taxes/" class="uri">https://hockey-graphs.com/2019/01/08/how-much-do-nhl-players-really-make-part-2-taxes/</a>.</li>
<li>Graham, Shawn, 2019, ‘Scraping with rvest,’ 7 November, <a href="https://electricarchaeology.ca/2019/11/07/scraping-with-rvest/" class="uri">https://electricarchaeology.ca/2019/11/07/scraping-with-rvest/</a>.</li>
<li>Henze, Martin, 2020, ‘Web Scraping with rvest + Astro Throwback,’ 23 January, <a href="https://heads0rtai1s.github.io/2020/01/23/rvest-intro-astro/" class="uri">https://heads0rtai1s.github.io/2020/01/23/rvest-intro-astro/</a>.</li>
<li>Hudon, Caitlin, 2017, ‘’Blue Christmas: A data-driven search for the most depressing Christmas song,’ 22 December, <a href="https://caitlinhudon.com/2017/12/22/blue-christmas/" class="uri">https://caitlinhudon.com/2017/12/22/blue-christmas/</a>.</li>
<li>Luscombe, Alex, 2020, ‘A Gentle Introduction to Tesseract OCR,’ 3 June, <a href="https://alexluscombe.ca/post/ocr-tutorial/" class="uri">https://alexluscombe.ca/post/ocr-tutorial/</a>.</li>
<li>Luscombe, Alex, 2020, ‘Getting your .pdfs into R,’ 5 August, <a href="https://alexluscombe.ca/post/r-pdftools/" class="uri">https://alexluscombe.ca/post/r-pdftools/</a>.</li>
<li>Luscombe, Alex, 2020, ‘Parsing your .pdfs in R,’ 10 August, <a href="https://alexluscombe.ca/post/parsing-pdfs/" class="uri">https://alexluscombe.ca/post/parsing-pdfs/</a>.</li>
<li>Marshall, James, ‘HTML Made Really Easy,’ <a href="https://www.jmarshall.com/easy/html/" class="uri">https://www.jmarshall.com/easy/html/</a>.</li>
<li>Marshall, James, ‘HTTP Made Really Easy,’ <a href="https://www.jmarshall.com/easy/http/" class="uri">https://www.jmarshall.com/easy/http/</a>.</li>
<li>Nakagawara, Ryo, 2020, ‘Intro to {polite} Web Scraping of Soccer Data with R!’ 14 May, <a href="https://ryo-n7.github.io/2020-05-14-webscrape-soccer-data-with-R/" class="uri">https://ryo-n7.github.io/2020-05-14-webscrape-soccer-data-with-R/</a>.</li>
<li>Pavlik, Kaylin, 2020, ‘How do fiber types appear together in yarn blends?’ 17 February, <a href="https://www.kaylinpavlik.com/ravelry-yarn-fibers/" class="uri">https://www.kaylinpavlik.com/ravelry-yarn-fibers/</a>.</li>
<li>Silge, Julia and David Robinson, 2020, <em>Text Mining with R</em>, Chapters 1, 3, and 6, <a href="https://www.tidytextmining.com/" class="uri">https://www.tidytextmining.com/</a>.</li>
<li>Silge, Julia, 2017, ‘Scraping CRAN with rvest,’ 5 March, <a href="https://juliasilge.com/blog/scraping-cran/" class="uri">https://juliasilge.com/blog/scraping-cran/</a>.</li>
<li>Smale, David, 2020, ‘Daniel Johnston,’ <a href="https://davidsmale.netlify.com/portfolio/daniel-johnston/" class="uri">https://davidsmale.netlify.com/portfolio/daniel-johnston/</a>.</li>
<li>Taddy, Matt, 2019, <em>Business Data Science</em>, Chapter 8, pp. 231-259.</li>
<li>Wickham, Hadley, ‘Managing Secrets,’ <a href="https://cran.r-project.org/web/packages/httr/vignettes/secrets.html" class="uri">https://cran.r-project.org/web/packages/httr/vignettes/secrets.html</a>.</li>
<li>Wickham, Hadley, 2014, ‘rvest: easy web scraping with R,’ 24 November, <a href="https://blog.rstudio.com/2014/11/24/rvest-easy-web-scraping-with-r/" class="uri">https://blog.rstudio.com/2014/11/24/rvest-easy-web-scraping-with-r/</a>.</li>
<li>Wickham, Hadley, nd, ‘Getting started with httr,’ <a href="https://cran.r-project.org/web/packages/httr/vignettes/quickstart.html" class="uri">https://cran.r-project.org/web/packages/httr/vignettes/quickstart.html</a>.</li>
</ul>
<p><strong>Recommended viewing</strong></p>
<ul>
<li>D’Agostino McGowan, Lucy, 2020 ‘Harnessing the Power of the Web via R Clients for Web APIs,’ talk at ASA Joint Statistical Meeting 2018, <a href="https://www.lucymcgowan.com/talk/asa_joint_statistical_meeting_2018/" class="uri">https://www.lucymcgowan.com/talk/asa_joint_statistical_meeting_2018/</a>.</li>
<li>Tatman, Rachel, 2018, ‘Character Encoding and You,’ 21 February, <a href="https://youtu.be/2U9EHYqc59Y" class="uri">https://youtu.be/2U9EHYqc59Y</a>.</li>
</ul>
<p><strong>Key concepts/skills/etc</strong></p>
<ul>
<li>Use APIs where possible because the data provider has specified the data they would like to make available to you, and the conditions under which they are making it available.</li>
<li>Often R packages have been written to make it easier to use APIs.</li>
<li>Use R environments to manage your keys.</li>
<li>Using the verb GET (‘a GET request’) means providing a URL and the server will return something, using the verb POST (a POST request’) means providing some data and the server will deal with that data.</li>
<li>Cleaning data</li>
<li>Graphing data to tell a story</li>
<li>Respectfully scraping data</li>
<li>Approaching extracting text from PDFs as a workflow.</li>
<li>Planning what is needed at the start.</li>
<li>Starting small and then iterating.</li>
<li>Putting in place checks.</li>
<li>Gathering text data.</li>
<li>Preparing text datasets.</li>
</ul>
<p><strong>Key libraries</strong></p>
<ul>
<li><code>babynames</code></li>
<li><code>broom</code></li>
<li><code>dplyr</code></li>
<li><code>ggplot2</code></li>
<li><code>gutenbergr</code></li>
<li><code>janitor</code></li>
<li><code>jsonlite</code></li>
<li><code>pdftools</code></li>
<li><code>purrr</code></li>
<li><code>rtweet</code></li>
<li><code>rvest</code></li>
<li><code>spotifyr</code></li>
<li><code>stringi</code></li>
<li><code>tidymodels</code></li>
<li><code>tidytext</code></li>
<li><code>tidyverse</code></li>
<li><code>usethis</code></li>
</ul>
<p><strong>Key functions/etc</strong></p>
<ul>
<li><code><a href="https://forcats.tidyverse.org/reference/as_factor.html">as_factor()</a></code></li>
<li><code><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble()</a></code></li>
<li><code><a href="https://rdrr.io/pkg/tidytext/man/bind_tf_idf.html">bind_tf_idf()</a></code></li>
<li><code><a href="https://rdrr.io/r/base/c.html">c()</a></code></li>
<li><code><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when()</a></code></li>
<li><code><a href="https://rdrr.io/r/base/cat.html">cat()</a></code></li>
<li><code><a href="https://usethis.r-lib.org/reference/edit.html">edit_r_environ()</a></code></li>
<li><code><a href="https://rdrr.io/r/base/connections.html">file()</a></code></li>
<li><code><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html">fromJSON()</a></code></li>
<li><code>function()</code></li>
<li><code><a href="https://httr.r-lib.org/reference/GET.html">GET()</a></code></li>
<li><code><a href="https://rdrr.io/pkg/spotifyr/man/get_artist_audio_features.html">get_artist_audio_features()</a></code></li>
<li><code><a href="https://rdrr.io/pkg/rtweet/man/get_favorites.html">get_favorites()</a></code></li>
<li><code><a href="https://rdrr.io/pkg/spotifyr/man/get_my_top_artists_or_tracks.html">get_my_top_artists_or_tracks()</a></code></li>
<li><code><a href="https://rvest.tidyverse.org/reference/rename.html">html_node()</a></code></li>
<li><code><a href="https://rvest.tidyverse.org/reference/rename.html">html_nodes()</a></code></li>
<li><code><a href="https://rvest.tidyverse.org/reference/html_text.html">html_text()</a></code></li>
<li><code><a href="https://docs.ropensci.org/pdftools/reference/pdftools.html">pdf_data()</a></code></li>
<li><code><a href="https://docs.ropensci.org/pdftools/reference/pdftools.html">pdf_text()</a></code></li>
<li><code><a href="https://purrr.tidyverse.org/reference/map2.html">pmap_dfr()</a></code></li>
<li><code><a href="http://xml2.r-lib.org/reference/read_xml.html">read_html()</a></code></li>
<li><code><a href="https://rdrr.io/r/base/readRDS.html">readRDS()</a></code></li>
<li><code><a href="https://purrr.tidyverse.org/reference/safely.html">safely()</a></code></li>
<li><code><a href="https://rdrr.io/pkg/rtweet/man/search_tweets.html">search_tweets()</a></code></li>
<li><code><a href="https://rdrr.io/r/datasets/sleep.html">sleep()</a></code></li>
<li><code><a href="https://docs.ropensci.org/tesseract/reference/tesseract.html">tesseract()</a></code></li>
<li><code><a href="https://rdrr.io/pkg/tidytext/man/unnest_tokens.html">unnest_tokens()</a></code></li>
<li><code><a href="https://purrr.tidyverse.org/reference/map2.html">walk2()</a></code></li>
<li><code>write_html()</code></li>
<li><code><a href="https://readr.tidyverse.org/reference/read_lines.html">write_lines()</a></code></li>
</ul>
<div id="apis" class="section level2" number="8.1">
<h2>
<span class="header-section-number">8.1</span> APIs<a class="anchor" aria-label="anchor" href="#apis"><i class="fas fa-link"></i></a>
</h2>
<p>In everyday language, and for our purposes, an Application Programming Interface (API) is simply a situation in which someone has set up specific files on their computer such that you can follow their instructions to get them. For instance, when you use a gif on Slack, Slack asks Giphy’s server for the appropriate gif, Giphy’s server gives that gif to Slack and then Slack inserts it into your chat. The way in which Slack and Giphy interact is determined by Giphy’s API. More strictly, an API is just an application that runs on a server that we access using the HTTP protocol.</p>
<p>In our case, we are going to focus on using APIs for gathering data. I’ll tailor the language that I use toward that:</p>
<blockquote>
<p>[a]n API is the tool that makes a website’s data digestible for a computer. Through it, a computer can view and edit data, just like a person can by loading pages and submitting forms.</p>
<p><span class="citation"><a href="references-1.html#ref-zapierapis" role="doc-biblioref">Cooksey</a> (<a href="references-1.html#ref-zapierapis" role="doc-biblioref">2014</a>)</span>, Chapter 1.</p>
</blockquote>
<p>For instance, you could go to <a href="https://www.google.ca/maps">Google Maps</a> and then scroll and click and drag to center the map on Canberra, Australia, or you could just paste this into your browser: <a href="https://www.google.ca/maps/@-35.2812958,149.1248113,16z" class="uri">https://www.google.ca/maps/@-35.2812958,149.1248113,16z</a>. You just used the Google Maps API.<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;There are at least six great coffee shops shown just in this section of map including: Mocan &amp;amp; Green Grout; The Cupping Room; Barrio Collective Coffee; Lonsdale Street Cafe; Two Before Ten; and Red Brick. There are also two coffee shops that I love but that most wouldn’t classify as ‘great’ including: The Street Theatre Cafe; and the CBE Cafe.&lt;/p&gt;"><sup>3</sup></a> The result should be a map that looks something like Figure <a href="gather-data.html#fig:focuson2020">8.1</a> .</p>
<div class="figure">
<span style="display:block;" id="fig:focuson2020"></span>
<img src="figures/googlemaps.png" alt="Example of Google Maps, as at 25 January 2021." width="90%"><p class="caption">
Figure 8.1: Example of Google Maps, as at 25 January 2021.
</p>
</div>
<p>The advantage of using an API is that the data provider specifies exactly the data that they are willing to provide, and the terms under which they will provide it. These terms may include things like rate limits (i.e. how often you can ask for data), and what you can do with the data (e.g. maybe you’re not allowed to use it for commercial purposes, or to republish it, or whatever). Additionally, because the API is being provided specifically for you to use it, it is less likely to be subject to unexpected changes. Because of this it is ethically and legally clear that when an API is available you should try to use it.</p>
<p>We’re going to run through some case studies interacting with APIs in R. In the first we will deal directly with an API. That works and is a handy skill to have, but there are a lot of R packages that wrap around APIs making it easier for you to use an API within ‘familiar surroundings.’ I’ll also run through two fun APIs that have R packages built around them.</p>
</div>
<div id="case-study---arxiv" class="section level2" number="8.2">
<h2>
<span class="header-section-number">8.2</span> Case study - arXiv<a class="anchor" aria-label="anchor" href="#case-study---arxiv"><i class="fas fa-link"></i></a>
</h2>
<p>In this section we introduce GET requests in which we use an API directly. We will use the <code>httr</code> package <span class="citation">(<a href="references-1.html#ref-citehttr" role="doc-biblioref">Wickham 2019c</a>)</span>. A GET request tries to obtain some specific data and the main argument is <code>url</code>. Exactly as before with the Google Maps example! In that case, the specific information was a map and some information about it.</p>
<p>For this example we’ll look at <a href="https://arxiv.org">arXiv</a>, which is a repository for academic articles before they go through peer-review. I’ll ask arXiv to return some information about a paper that I recently uploaded with a former student. The content that is returned will be a series of information about that paper.</p>
<div class="sourceCode" id="cb176"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># install.packages('httr')</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://httr.r-lib.org/">httr</a></span><span class="op">)</span>
<span class="va">arxiv</span> <span class="op">&lt;-</span> <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/GET.html">GET</a></span><span class="op">(</span><span class="st">'http://export.arxiv.org/api/query?id_list=2101.05225'</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">arxiv</span><span class="op">)</span>
<span class="co">#&gt; [1] "response"</span>
<span class="fu"><a href="https://httr.r-lib.org/reference/content.html">content</a></span><span class="op">(</span><span class="va">arxiv</span>, <span class="st">"text"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"\n"</span><span class="op">)</span>
<span class="co">#&gt; &lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="co">#&gt; &lt;feed xmlns="http://www.w3.org/2005/Atom"&gt;</span>
<span class="co">#&gt;   &lt;link href="http://arxiv.org/api/query?search_query%3D%26id_list%3D2101.05225%26start%3D0%26max_results%3D10" rel="self" type="application/atom+xml"/&gt;</span>
<span class="co">#&gt;   &lt;title type="html"&gt;ArXiv Query: search_query=&amp;amp;id_list=2101.05225&amp;amp;start=0&amp;amp;max_results=10&lt;/title&gt;</span>
<span class="co">#&gt;   &lt;id&gt;http://arxiv.org/api/p9UZyl2Vt0cHwPSKinDSThE23qI&lt;/id&gt;</span>
<span class="co">#&gt;   &lt;updated&gt;2022-01-02T00:00:00-05:00&lt;/updated&gt;</span>
<span class="co">#&gt;   &lt;opensearch:totalResults xmlns:opensearch="http://a9.com/-/spec/opensearch/1.1/"&gt;1&lt;/opensearch:totalResults&gt;</span>
<span class="co">#&gt;   &lt;opensearch:startIndex xmlns:opensearch="http://a9.com/-/spec/opensearch/1.1/"&gt;0&lt;/opensearch:startIndex&gt;</span>
<span class="co">#&gt;   &lt;opensearch:itemsPerPage xmlns:opensearch="http://a9.com/-/spec/opensearch/1.1/"&gt;10&lt;/opensearch:itemsPerPage&gt;</span>
<span class="co">#&gt;   &lt;entry&gt;</span>
<span class="co">#&gt;     &lt;id&gt;http://arxiv.org/abs/2101.05225v1&lt;/id&gt;</span>
<span class="co">#&gt;     &lt;updated&gt;2021-01-13T17:37:07Z&lt;/updated&gt;</span>
<span class="co">#&gt;     &lt;published&gt;2021-01-13T17:37:07Z&lt;/published&gt;</span>
<span class="co">#&gt;     &lt;title&gt;On consistency scores in text data with an implementation in R&lt;/title&gt;</span>
<span class="co">#&gt;     &lt;summary&gt;  In this paper, we introduce a reproducible cleaning process for the text</span>
<span class="co">#&gt; extracted from PDFs using n-gram models. Our approach compares the originally</span>
<span class="co">#&gt; extracted text with the text generated from, or expected by, these models using</span>
<span class="co">#&gt; earlier text as stimulus. To guide this process, we introduce the notion of a</span>
<span class="co">#&gt; consistency score, which refers to the proportion of text that is expected by</span>
<span class="co">#&gt; the model. This is used to monitor changes during the cleaning process, and</span>
<span class="co">#&gt; across different corpuses. We illustrate our process on text from the book Jane</span>
<span class="co">#&gt; Eyre and introduce both a Shiny application and an R package to make our</span>
<span class="co">#&gt; process easier for others to adopt.</span>
<span class="co">#&gt; &lt;/summary&gt;</span>
<span class="co">#&gt;     &lt;author&gt;</span>
<span class="co">#&gt;       &lt;name&gt;Ke-Li Chiu&lt;/name&gt;</span>
<span class="co">#&gt;     &lt;/author&gt;</span>
<span class="co">#&gt;     &lt;author&gt;</span>
<span class="co">#&gt;       &lt;name&gt;Rohan Alexander&lt;/name&gt;</span>
<span class="co">#&gt;     &lt;/author&gt;</span>
<span class="co">#&gt;     &lt;arxiv:comment xmlns:arxiv="http://arxiv.org/schemas/atom"&gt;13 pages, 0 figures&lt;/arxiv:comment&gt;</span>
<span class="co">#&gt;     &lt;link href="http://arxiv.org/abs/2101.05225v1" rel="alternate" type="text/html"/&gt;</span>
<span class="co">#&gt;     &lt;link title="pdf" href="http://arxiv.org/pdf/2101.05225v1" rel="related" type="application/pdf"/&gt;</span>
<span class="co">#&gt;     &lt;arxiv:primary_category xmlns:arxiv="http://arxiv.org/schemas/atom" term="cs.CL" scheme="http://arxiv.org/schemas/atom"/&gt;</span>
<span class="co">#&gt;     &lt;category term="cs.CL" scheme="http://arxiv.org/schemas/atom"/&gt;</span>
<span class="co">#&gt;   &lt;/entry&gt;</span>
<span class="co">#&gt; &lt;/feed&gt;</span>
<span class="co">#&gt; </span></code></pre></div>
<p>We get a variety of information about this paper including the title, abstract, and authors.</p>
</div>
<div id="case-study---rtweet" class="section level2" number="8.3">
<h2>
<span class="header-section-number">8.3</span> Case study - rtweet<a class="anchor" aria-label="anchor" href="#case-study---rtweet"><i class="fas fa-link"></i></a>
</h2>
<p>Twitter is a rich source of text and other data. The Twitter API is the way in which Twitter ask that you interact with Twitter in order to gather these data. The <code>rtweet</code> package <span class="citation">(<a href="references-1.html#ref-rtweet-package" role="doc-biblioref">Kearney 2019</a>)</span> is built around this API and allows us to interact with it in ways that are similar to using any other R package. Initially all you need a regular Twitter account.</p>
<p>Get started by install the library if you need and then calling it.</p>
<div class="sourceCode" id="cb177"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># install.packages('rtweet')</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://CRAN.R-project.org/package=rtweet">rtweet</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></code></pre></div>
<p>To get started we need to authorise rtweet. We start that process by calling a function from the package.</p>
<div class="sourceCode" id="cb178"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/rtweet/man/get_favorites.html">get_favorites</a></span><span class="op">(</span>user <span class="op">=</span> <span class="st">"RohanAlexander"</span><span class="op">)</span></code></pre></div>
<p>This will open a browser on your computer, and you will then have to log into your regular Twitter account as shown in Figure <a href="gather-data.html#fig:rtweetlogin">8.2</a>.</p>
<div class="figure">
<span style="display:block;" id="fig:rtweetlogin"></span>
<img src="figures/rtweet.png" alt="rtweet authorisation page" width="90%"><p class="caption">
Figure 8.2: rtweet authorisation page
</p>
</div>
<p>Once that is done we can actually get my favourites and then save them.</p>
<div class="sourceCode" id="cb179"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rohans_favs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rtweet/man/get_favorites.html">get_favorites</a></span><span class="op">(</span><span class="st">"RohanAlexander"</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">rohans_favs</span>, <span class="st">"dont_push/rohans_favs.rds"</span><span class="op">)</span></code></pre></div>
<p>And then looking at the most recent favourite, we can see it was when Professor Bolton tweeted about one of the stellar students in ISSC.</p>
<div class="sourceCode" id="cb180"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rohans_favs</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">created_at</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">screen_name</span>, <span class="va">text</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 1 × 2</span>
<span class="co">#&gt;   screen_name text                                                              </span>
<span class="co">#&gt;   &lt;chr&gt;       &lt;chr&gt;                                                             </span>
<span class="co">#&gt; 1 les_ja      I've signed an offer letter, so I think I can formally announce: …</span></code></pre></div>
<p>Let’s look at who is tweeting about R, using one of the common R hashtags: #rstats. I’ve removed retweets so that we hopefully get some actual interesting projects.</p>
<div class="sourceCode" id="cb181"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rstats_tweets</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rtweet/man/search_tweets.html">search_tweets</a></span><span class="op">(</span>
  q <span class="op">=</span> <span class="st">"#rstats"</span>,
  include_rts <span class="op">=</span> <span class="cn">FALSE</span>
<span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">rstats_tweets</span>, <span class="st">"dont_push/rstats_tweets.rds"</span><span class="op">)</span></code></pre></div>
<p>And then have a look at them.</p>
<div class="sourceCode" id="cb182"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">rstats_tweets</span><span class="op">)</span>
<span class="co">#&gt;  [1] "user_id"                 "status_id"              </span>
<span class="co">#&gt;  [3] "created_at"              "screen_name"            </span>
<span class="co">#&gt;  [5] "text"                    "source"                 </span>
<span class="co">#&gt;  [7] "display_text_width"      "reply_to_status_id"     </span>
<span class="co">#&gt;  [9] "reply_to_user_id"        "reply_to_screen_name"   </span>
<span class="co">#&gt; [11] "is_quote"                "is_retweet"             </span>
<span class="co">#&gt; [13] "favorite_count"          "retweet_count"          </span>
<span class="co">#&gt; [15] "quote_count"             "reply_count"            </span>
<span class="co">#&gt; [17] "hashtags"                "symbols"                </span>
<span class="co">#&gt; [19] "urls_url"                "urls_t.co"              </span>
<span class="co">#&gt; [21] "urls_expanded_url"       "media_url"              </span>
<span class="co">#&gt; [23] "media_t.co"              "media_expanded_url"     </span>
<span class="co">#&gt; [25] "media_type"              "ext_media_url"          </span>
<span class="co">#&gt; [27] "ext_media_t.co"          "ext_media_expanded_url" </span>
<span class="co">#&gt; [29] "ext_media_type"          "mentions_user_id"       </span>
<span class="co">#&gt; [31] "mentions_screen_name"    "lang"                   </span>
<span class="co">#&gt; [33] "quoted_status_id"        "quoted_text"            </span>
<span class="co">#&gt; [35] "quoted_created_at"       "quoted_source"          </span>
<span class="co">#&gt; [37] "quoted_favorite_count"   "quoted_retweet_count"   </span>
<span class="co">#&gt; [39] "quoted_user_id"          "quoted_screen_name"     </span>
<span class="co">#&gt; [41] "quoted_name"             "quoted_followers_count" </span>
<span class="co">#&gt; [43] "quoted_friends_count"    "quoted_statuses_count"  </span>
<span class="co">#&gt; [45] "quoted_location"         "quoted_description"     </span>
<span class="co">#&gt; [47] "quoted_verified"         "retweet_status_id"      </span>
<span class="co">#&gt; [49] "retweet_text"            "retweet_created_at"     </span>
<span class="co">#&gt; [51] "retweet_source"          "retweet_favorite_count" </span>
<span class="co">#&gt; [53] "retweet_retweet_count"   "retweet_user_id"        </span>
<span class="co">#&gt; [55] "retweet_screen_name"     "retweet_name"           </span>
<span class="co">#&gt; [57] "retweet_followers_count" "retweet_friends_count"  </span>
<span class="co">#&gt; [59] "retweet_statuses_count"  "retweet_location"       </span>
<span class="co">#&gt; [61] "retweet_description"     "retweet_verified"       </span>
<span class="co">#&gt; [63] "place_url"               "place_name"             </span>
<span class="co">#&gt; [65] "place_full_name"         "place_type"             </span>
<span class="co">#&gt; [67] "country"                 "country_code"           </span>
<span class="co">#&gt; [69] "geo_coords"              "coords_coords"          </span>
<span class="co">#&gt; [71] "bbox_coords"             "status_url"             </span>
<span class="co">#&gt; [73] "name"                    "location"               </span>
<span class="co">#&gt; [75] "description"             "url"                    </span>
<span class="co">#&gt; [77] "protected"               "followers_count"        </span>
<span class="co">#&gt; [79] "friends_count"           "listed_count"           </span>
<span class="co">#&gt; [81] "statuses_count"          "favourites_count"       </span>
<span class="co">#&gt; [83] "account_created_at"      "verified"               </span>
<span class="co">#&gt; [85] "profile_url"             "profile_expanded_url"   </span>
<span class="co">#&gt; [87] "account_lang"            "profile_banner_url"     </span>
<span class="co">#&gt; [89] "profile_background_url"  "profile_image_url"</span>

<span class="va">rstats_tweets</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">screen_name</span>, <span class="va">text</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 × 2</span>
<span class="co">#&gt;   screen_name    text                                                           </span>
<span class="co">#&gt;   &lt;chr&gt;          &lt;chr&gt;                                                          </span>
<span class="co">#&gt; 1 RahaPhD        "#WFH multitasking woes:  I was just sitting here, working on …</span>
<span class="co">#&gt; 2 AmandaKMontoya "Teaching with the #PublishingPaidMe data this week in my intr…</span>
<span class="co">#&gt; 3 digitalke1     "130 #MachineLearning ProjectsSolved and Explained\n@ruben_arc…</span>
<span class="co">#&gt; 4 digitalke1     "#Infographic: 6 simple steps to effectively analyse data.\nVi…</span>
<span class="co">#&gt; 5 dataclaudius   "When Did the US Senate Best Reflect the US Population? via #r…</span>
<span class="co">#&gt; 6 alexpghayes    "has anyone written an #rstats package to interface with SNAP …</span></code></pre></div>
<p>There is a bunch of other things that you can do just using a regular user account, and if you’re interested then you should try the examples in the <code>rtweet</code> package documentation: <a href="https://rtweet.info/index.html" class="uri">https://rtweet.info/index.html</a>. But more is available once you register as a developer (<a href="https://developer.twitter.com/en/apply-for-access" class="uri">https://developer.twitter.com/en/apply-for-access</a>). The Twitter API document is surprisingly readable, and you may enjoy some of it: <a href="https://developer.twitter.com/en/docs" class="uri">https://developer.twitter.com/en/docs</a>.</p>
<p>When I introduced APIs I said that the ‘data provider specifies exactly the data that they are willing to provide…’ and we have certainly been able to take advantage of what they provide But I continued ‘…and the terms under which they will provide it’ and here we haven’t done our part. In particular, I took some tweets and saved them. If I had pushed these to GitHub, then it’s possible I may have accidently stored sensitive information if there happened to be some in the tweets. Or if I had taken enough tweets to start to do some reasonable statistical analysis then even if there wasn’t sensitive information, I may have violated the terms if I had pushed those saved tweets to GitHub. Finally, I linked a Twitter username, in this case <code>@Liza_Bolton</code> with Professor Bolton. I happened to ask her if this was okay, but if I hadn’t done that then I would have been violating the Twitter terms of service.</p>
<p>If you use Twitter data, please take a moment to look at the terms: <a href="https://developer.twitter.com/en/developer-terms/more-on-restricted-use-cases" class="uri">https://developer.twitter.com/en/developer-terms/more-on-restricted-use-cases</a>.</p>
</div>
<div id="case-study---spotifyr" class="section level2" number="8.4">
<h2>
<span class="header-section-number">8.4</span> Case study - spotifyr<a class="anchor" aria-label="anchor" href="#case-study---spotifyr"><i class="fas fa-link"></i></a>
</h2>
<p>For the next example I will introduce the <code>spotifyr</code> package <span class="citation">(<a href="references-1.html#ref-spotifyr" role="doc-biblioref">Thompson et al. 2020</a>)</span>. Again, this is a wrapper that has been developed around an API, in this case the Spotify API. You should install the package from the developer’s GitHub repo using <code>devtools</code> <span class="citation">(<a href="references-1.html#ref-citeDevtools" role="doc-biblioref">Wickham, Hester, and Chang 2020</a>)</span>.</p>
<div class="sourceCode" id="cb183"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># devtools::install_github('charlie86/spotifyr')</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/charlie86/spotifyr">spotifyr</a></span><span class="op">)</span></code></pre></div>
<p>In order to use this account, you need a Spotify Developer Account, which you can set-up here: <a href="https://developer.spotify.com/dashboard/" class="uri">https://developer.spotify.com/dashboard/</a>. That’ll have you log in with your Spotify details and then accept their terms (it’s worth looking at some of these and I’ll follow up on a few below) as in Figure <a href="gather-data.html#fig:spotifyaccept">8.3</a>.</p>
<div class="figure">
<span style="display:block;" id="fig:spotifyaccept"></span>
<img src="figures/spotify.png" alt="rtweet authorisation page" width="90%"><p class="caption">
Figure 8.3: rtweet authorisation page
</p>
</div>
<p>What we need from here is a ‘Client ID’ and you can just fill out some basic details. In our case we probably ‘don’t know’ what we’re building, which means that Spotify requires us to use a non-commercial agreement, which is fine. In order to use the Spotify API we need a Client ID and a Client Secret.</p>
<p>These are things that you want to keep to yourself. There are a variety of ways of keeping this secret, (and my understanding is that a helpful package is on its way) but we’ll keep them in our System Environment. In this way, when we push to GitHub they won’t be included. To do this we need to be careful about the naming, because <code>spotifyr</code> will look in our environment for specifically named keys.</p>
<p>To do this we are going to use the <code>usethis</code> package <span class="citation">(<a href="references-1.html#ref-citeusethis" role="doc-biblioref">Wickham and Bryan 2020</a>)</span>. If you don’t have that then please install it. There is a file called ‘.Renviron’ which we will open and add our secrets to. This file also controls things like your default library location and more information is available at <span class="citation"><a href="references-1.html#ref-renvironrstudio" role="doc-biblioref">Lopp</a> (<a href="references-1.html#ref-renvironrstudio" role="doc-biblioref">2017</a>)</span> and <span class="citation"><a href="references-1.html#ref-whattheyforgot" role="doc-biblioref">Jennifer Bryan and Hester</a> (<a href="references-1.html#ref-whattheyforgot" role="doc-biblioref">2020</a>)</span>.</p>
<div class="sourceCode" id="cb184"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">usethis</span><span class="fu">::</span><span class="fu"><a href="https://usethis.r-lib.org/reference/edit.html">edit_r_environ</a></span><span class="op">(</span><span class="op">)</span> </code></pre></div>
<p>When you run that function it will open a file. There you can add your Spotify secrets.</p>
<div class="sourceCode" id="cb185"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">SPOTIFY_CLIENT_ID</span> <span class="op">=</span> <span class="st">'PUT_YOUR_CLIENT_ID_HERE'</span>
<span class="va">SPOTIFY_CLIENT_SECRET</span> <span class="op">=</span> <span class="st">'PUT_YOUR_SECRET_HERE'</span></code></pre></div>
<p>Save your ‘.Renviron’ file, and then restart R (Session -&gt; Restart R). You can now draw on that variable when you need.</p>
<p>Some functions that require your secrets as arguments will now just work. For instance, we will get information about Radiohead using <code><a href="https://rdrr.io/pkg/spotifyr/man/get_artist_audio_features.html">get_artist_audio_features()</a></code>. One of the arguments is <code>authorization</code>, but as that is set to default to look at the R Environment, we don’t need to do anything further.</p>
<div class="sourceCode" id="cb186"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">radiohead</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/spotifyr/man/get_artist_audio_features.html">get_artist_audio_features</a></span><span class="op">(</span><span class="st">'radiohead'</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">radiohead</span>, <span class="st">"inputs/radiohead.rds"</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb187"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">radiohead</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"inputs/radiohead.rds"</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">radiohead</span><span class="op">)</span>
<span class="co">#&gt;  [1] "artist_name"                  "artist_id"                   </span>
<span class="co">#&gt;  [3] "album_id"                     "album_type"                  </span>
<span class="co">#&gt;  [5] "album_images"                 "album_release_date"          </span>
<span class="co">#&gt;  [7] "album_release_year"           "album_release_date_precision"</span>
<span class="co">#&gt;  [9] "danceability"                 "energy"                      </span>
<span class="co">#&gt; [11] "key"                          "loudness"                    </span>
<span class="co">#&gt; [13] "mode"                         "speechiness"                 </span>
<span class="co">#&gt; [15] "acousticness"                 "instrumentalness"            </span>
<span class="co">#&gt; [17] "liveness"                     "valence"                     </span>
<span class="co">#&gt; [19] "tempo"                        "track_id"                    </span>
<span class="co">#&gt; [21] "analysis_url"                 "time_signature"              </span>
<span class="co">#&gt; [23] "artists"                      "available_markets"           </span>
<span class="co">#&gt; [25] "disc_number"                  "duration_ms"                 </span>
<span class="co">#&gt; [27] "explicit"                     "track_href"                  </span>
<span class="co">#&gt; [29] "is_local"                     "track_name"                  </span>
<span class="co">#&gt; [31] "track_preview_url"            "track_number"                </span>
<span class="co">#&gt; [33] "type"                         "track_uri"                   </span>
<span class="co">#&gt; [35] "external_urls.spotify"        "album_name"                  </span>
<span class="co">#&gt; [37] "key_name"                     "mode_name"                   </span>
<span class="co">#&gt; [39] "key_mode"</span>

<span class="va">radiohead</span> <span class="op"><a href="https://rdrr.io/pkg/spotifyr/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">artist_name</span>, <span class="va">track_name</span>, <span class="va">album_name</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/spotifyr/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt;   artist_name                               track_name</span>
<span class="co">#&gt; 1   Radiohead                      Airbag - Remastered</span>
<span class="co">#&gt; 2   Radiohead            Paranoid Android - Remastered</span>
<span class="co">#&gt; 3   Radiohead Subterranean Homesick Alien - Remastered</span>
<span class="co">#&gt; 4   Radiohead     Exit Music (For a Film) - Remastered</span>
<span class="co">#&gt; 5   Radiohead                    Let Down - Remastered</span>
<span class="co">#&gt; 6   Radiohead                Karma Police - Remastered</span>
<span class="co">#&gt;                      album_name</span>
<span class="co">#&gt; 1 OK Computer OKNOTOK 1997 2017</span>
<span class="co">#&gt; 2 OK Computer OKNOTOK 1997 2017</span>
<span class="co">#&gt; 3 OK Computer OKNOTOK 1997 2017</span>
<span class="co">#&gt; 4 OK Computer OKNOTOK 1997 2017</span>
<span class="co">#&gt; 5 OK Computer OKNOTOK 1997 2017</span>
<span class="co">#&gt; 6 OK Computer OKNOTOK 1997 2017</span></code></pre></div>
<p>Let’s just make a quick graph looking at track length over time.</p>
<div class="sourceCode" id="cb188"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">radiohead</span> <span class="op"><a href="https://rdrr.io/pkg/spotifyr/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">album_release_year</span>, y <span class="op">=</span> <span class="va">duration_ms</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="20-gather_files/figure-html/unnamed-chunk-10-1.png" width="672"></div>
<p>Just because we can, let’s settle an argument. I’ve always said that Radiohead of quite depressing, but they’re my wife’s favourite band. Let’s see how depressing they are. Spotify provides various information about each track, including ‘valence,’ which Spotify <a href="https://developer.spotify.com/documentation/web-api/reference/tracks/get-audio-features/">define</a> as ‘(a) measure from 0.0 to 1.0 describing the musical positiveness conveyed by a track. Tracks with high valence sound more positive (e.g. happy, cheerful, euphoric), while tracks with low valence sound more negative (e.g. sad, depressed, angry).’ Higher values are happier. Let’s compare someone who we know it likely to be happy - Taylor Swift - with Radiohead.</p>
<div class="sourceCode" id="cb189"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">swifty</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/spotifyr/man/get_artist_audio_features.html">get_artist_audio_features</a></span><span class="op">(</span><span class="st">'taylor swift'</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">swifty</span>, <span class="st">"inputs/swifty.rds"</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb190"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">swifty</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"inputs/swifty.rds"</span><span class="op">)</span>

<span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">swifty</span><span class="op">$</span><span class="va">artist_name</span>, <span class="va">radiohead</span><span class="op">$</span><span class="va">artist_name</span><span class="op">)</span>,
       year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">swifty</span><span class="op">$</span><span class="va">album_release_year</span>, <span class="va">radiohead</span><span class="op">$</span><span class="va">album_release_year</span><span class="op">)</span>,
       valence <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">swifty</span><span class="op">$</span><span class="va">valence</span>, <span class="va">radiohead</span><span class="op">$</span><span class="va">valence</span><span class="op">)</span>
               <span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/spotifyr/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">year</span>, y <span class="op">=</span> <span class="va">valence</span>, color <span class="op">=</span> <span class="va">name</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Year"</span>,
       y <span class="op">=</span> <span class="st">"Valence"</span>,
       color <span class="op">=</span> <span class="st">"Name"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_color_brewer</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Set1"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="20-gather_files/figure-html/unnamed-chunk-12-1.png" width="672"></div>
<p>Finally, for the sake of embarrassment, let’s look at our most played artists.</p>
<div class="sourceCode" id="cb191"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">top_artists</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/spotifyr/man/get_my_top_artists_or_tracks.html">get_my_top_artists_or_tracks</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">'artists'</span>, time_range <span class="op">=</span> <span class="st">'long_term'</span>, limit <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">top_artists</span>, <span class="st">"inputs/top_artists.rds"</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb192"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">top_artists</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"inputs/top_artists.rds"</span><span class="op">)</span>

<span class="va">top_artists</span> <span class="op"><a href="https://rdrr.io/pkg/spotifyr/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">name</span>, <span class="va">popularity</span><span class="op">)</span>
<span class="co">#&gt;                   name popularity</span>
<span class="co">#&gt; 1            Radiohead         81</span>
<span class="co">#&gt; 2  Bombay Bicycle Club         66</span>
<span class="co">#&gt; 3                Drake        100</span>
<span class="co">#&gt; 4        Glass Animals         74</span>
<span class="co">#&gt; 5                JAY-Z         85</span>
<span class="co">#&gt; 6        Laura Marling         65</span>
<span class="co">#&gt; 7       Sufjan Stevens         75</span>
<span class="co">#&gt; 8      Vampire Weekend         73</span>
<span class="co">#&gt; 9     Sturgill Simpson         65</span>
<span class="co">#&gt; 10          Nick Drake         66</span>
<span class="co">#&gt; 11        Dire Straits         78</span>
<span class="co">#&gt; 12               Lorde         80</span>
<span class="co">#&gt; 13         Marian Hill         65</span>
<span class="co">#&gt; 14       José González         68</span>
<span class="co">#&gt; 15       Stevie Wonder         79</span>
<span class="co">#&gt; 16          Disclosure         82</span>
<span class="co">#&gt; 17      Ben Folds Five         52</span>
<span class="co">#&gt; 18       Ainslie Wills         40</span>
<span class="co">#&gt; 19            Coldplay         89</span>
<span class="co">#&gt; 20               alt-J         75</span></code></pre></div>
<p>So pretty much my wife and I like what everyone else likes, with the exception of Ainslie Wills, who is an Australian and I suspect we used to listen to her when we were homesick.</p>
<p>How amazing that we live in a world that all that information is available with very little effort or cost.</p>
<p>Again, there is a lot more at the package’s website: <a href="https://www.rcharlie.com/spotifyr/" class="uri">https://www.rcharlie.com/spotifyr/</a>. A very nice little application of the Spotify API using some statistical analysis is <span class="citation"><a href="references-1.html#ref-kaylinpavlik" role="doc-biblioref">Pavlik</a> (<a href="references-1.html#ref-kaylinpavlik" role="doc-biblioref">2019</a>)</span>.</p>
<!-- ## NBA statistics -->
<!-- NBA: https://github.com/toddwschneider/ballr -->
<!-- ## tidyquant -->
<!-- Financial markets data: tidyquant -->
<!-- ## Danish statistics -->
<!-- https://cran.r-project.org/web/packages/danstat/vignettes/Introduction_to_danstat.html -->
</div>
<div id="scraping" class="section level2" number="8.5">
<h2>
<span class="header-section-number">8.5</span> Scraping<a class="anchor" aria-label="anchor" href="#scraping"><i class="fas fa-link"></i></a>
</h2>
<div id="introduction-6" class="section level3" number="8.5.1">
<h3>
<span class="header-section-number">8.5.1</span> Introduction<a class="anchor" aria-label="anchor" href="#introduction-6"><i class="fas fa-link"></i></a>
</h3>
<p>Web-scraping is a way to get data from websites into R. Rather than going to a website ourselves through a browser, we write code that does it for us. This opens up a lot of data to us, but on the other hand, it is not typically data that is being made available for these purposes and so it is important to be respectful of it. While generally not illegal, the specifics with regard to the legality of web-scraping depends on jurisdictions and the specifics of what you’re doing, and so it is also important to be mindful of this. And finally, web-scraping imposes a cost on the website host, and so it is important to reduce this to the extent that it’s possible.</p>
<p>That all said, web-scraping is an invaluable source of data. But they are typically datasets that can be created as a by-product of someone trying to achieve another aim. For instance, a retailer may have a website with their products and their prices. That has not been created deliberately as a source of data, but we can scrape it to create a dataset. As such, the following principles guide my web-scraping.</p>
<ol style="list-style-type: decimal">
<li>Avoid it. Try to use an API wherever possible.</li>
<li>Abide by their desires. Some websites have a file ‘robots.txt’ that contains information about what they are comfortable with scrapers doing, for instance ‘<a href="https://www.google.com/robots.txt" class="uri">https://www.google.com/robots.txt</a>.’ If they have one of these then you should read it and abide by it.</li>
<li>Reduce the impact.
<ul>
<li>Firstly, slow down your scraper, for instance, rather than having it visit the website every second, slow it down (using <code>sys.sleep()</code>). If you’re only after a few hundred files then why not just have it visit once a minute, running in the background overnight?</li>
<li>Secondly, consider the timing of when you run the scraper. For instance, if it’s a retailer then why not set your script to run from 10pm through to the morning, when fewer customers are likely to need the site? If it’s a government website and they have a big monthly release then why not avoid that day?</li>
</ul>
</li>
<li>Take only what you need. For instance, don’t scrape the entire of Wikipedia if all you need is to know the names of the 10 largest cities in Canada. This reduces the impact on their website and allows you to more easily justify what you are doing.</li>
<li>Only scrape once. Save everything as you go so that you don’t have to re-collect data. Similarly, once you have the data, you should keep that separate and not modify it. Of course, if you need data over time then you will need to go back, but this is different to needlessly re-scraping a page.</li>
<li>Don’t republish the pages that you scraped. (This is in contrast to datasets that you create from it.)</li>
<li>Take ownership and ask permission if possible. At a minimum level your scripts should have your contact details in them. Depending on the circumstances, it may be worthwhile asking for permission before you scrape.</li>
</ol>
</div>
<div id="getting-started-2" class="section level3" number="8.5.2">
<h3>
<span class="header-section-number">8.5.2</span> Getting started<a class="anchor" aria-label="anchor" href="#getting-started-2"><i class="fas fa-link"></i></a>
</h3>
<p>Web-scraping is possible by taking advantage of the underlying structure of a webpage. We use patterns in the HTML/CSS to get the data that we want. To look at the underlying HTML/CSS you can either: 1) open a browser, right-click, and choose something like ‘Inspect’; or 2) save the website and then open it with a text editor rather than a browser.</p>
<p>HTML/CSS is a markup language comprised of matching tags. If you want text to be bold then you would use something like:</p>
<div class="sourceCode" id="cb193"><pre class="sourceCode css"><code class="sourceCode css"><span id="cb193-1"><a href="gather-data.html#cb193-1" aria-hidden="true" tabindex="-1"></a>&lt;b<span class="op">&gt;</span>My bold text&lt;/b<span class="op">&gt;</span></span></code></pre></div>
<p>Similarly, if you want a list then you start and end the list as well as each item.</p>
<div class="sourceCode" id="cb194"><pre class="sourceCode css"><code class="sourceCode css"><span id="cb194-1"><a href="gather-data.html#cb194-1" aria-hidden="true" tabindex="-1"></a>&lt;ul<span class="op">&gt;</span></span>
<span id="cb194-2"><a href="gather-data.html#cb194-2" aria-hidden="true" tabindex="-1"></a>  &lt;li<span class="op">&gt;</span>Learn webscraping&lt;/li<span class="op">&gt;</span></span>
<span id="cb194-3"><a href="gather-data.html#cb194-3" aria-hidden="true" tabindex="-1"></a>  &lt;li<span class="op">&gt;</span>Do data science&lt;/li<span class="op">&gt;</span></span>
<span id="cb194-4"><a href="gather-data.html#cb194-4" aria-hidden="true" tabindex="-1"></a>  &lt;li<span class="op">&gt;</span>Proft&lt;/li<span class="op">&gt;</span></span>
<span id="cb194-5"><a href="gather-data.html#cb194-5" aria-hidden="true" tabindex="-1"></a>&lt;/ul<span class="op">&gt;</span></span></code></pre></div>
<p>When scraping we will search for these tags.</p>
<p>To get started, this is some HTML/CSS from my website. Let’s say that we want to grab my name from it. We can see that the name is in bold, so we want to probably focus on that feature and extract it.</p>
<div class="sourceCode" id="cb195"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">website_extract</span> <span class="op">&lt;-</span> <span class="st">"&lt;p&gt;Hi, I’m &lt;b&gt;Rohan&lt;/b&gt; Alexander.&lt;/p&gt;"</span></code></pre></div>
<p>We will use the <code>rvest</code> package <span class="citation"><a href="references-1.html#ref-citervest" role="doc-biblioref">Wickham</a> (<a href="references-1.html#ref-citervest" role="doc-biblioref">2019d</a>)</span>.</p>
<div class="sourceCode" id="cb196"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># install.packages("rvest")</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rvest.tidyverse.org/">rvest</a></span><span class="op">)</span>

<span class="va">rohans_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/read_xml.html">read_html</a></span><span class="op">(</span><span class="va">website_extract</span><span class="op">)</span>

<span class="va">rohans_data</span>
<span class="co">#&gt; {html_document}</span>
<span class="co">#&gt; &lt;html&gt;</span>
<span class="co">#&gt; [1] &lt;body&gt;&lt;p&gt;Hi, I’m &lt;b&gt;Rohan&lt;/b&gt; Alexander.&lt;/p&gt;&lt;/body&gt;</span></code></pre></div>
<p>The language used by <code>rvest</code> to look for tags is ‘node,’ so we will focus on bold nodes. By default <code><a href="https://rvest.tidyverse.org/reference/rename.html">html_nodes()</a></code> returns the tags as well. We can focus on the text that they contain, using <code><a href="https://rvest.tidyverse.org/reference/html_text.html">html_text()</a></code>.</p>
<div class="sourceCode" id="cb197"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rohans_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rvest.tidyverse.org/reference/rename.html">html_nodes</a></span><span class="op">(</span><span class="st">"b"</span><span class="op">)</span>
<span class="co">#&gt; {xml_nodeset (1)}</span>
<span class="co">#&gt; [1] &lt;b&gt;Rohan&lt;/b&gt;</span>

<span class="va">first_name</span> <span class="op">&lt;-</span> 
  <span class="va">rohans_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rvest.tidyverse.org/reference/rename.html">html_nodes</a></span><span class="op">(</span><span class="st">"b"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://rvest.tidyverse.org/reference/html_text.html">html_text</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">first_name</span>
<span class="co">#&gt; [1] "Rohan"</span></code></pre></div>
<p>The result is that we learn my first name.</p>
</div>
</div>
<div id="case-study---rohans-books" class="section level2" number="8.6">
<h2>
<span class="header-section-number">8.6</span> Case study - Rohan’s books<a class="anchor" aria-label="anchor" href="#case-study---rohans-books"><i class="fas fa-link"></i></a>
</h2>
<div id="introduction-7" class="section level3" number="8.6.1">
<h3>
<span class="header-section-number">8.6.1</span> Introduction<a class="anchor" aria-label="anchor" href="#introduction-7"><i class="fas fa-link"></i></a>
</h3>
<p>In this case study we are going to scrape a list of books that I own, clean it, and look at the distribution of the first letters of author surnames. It is slightly more complicated than the example above, but the underlying approach is the same - download the website, look for the nodes of interest, extract the information, clean it.</p>
</div>
<div id="gather" class="section level3" number="8.6.2">
<h3>
<span class="header-section-number">8.6.2</span> Gather<a class="anchor" aria-label="anchor" href="#gather"><i class="fas fa-link"></i></a>
</h3>
<p>Again, the key library that we are using is the <code>rvest</code> library. This makes it easier to download a website, and to then navigate the html to find the aspects that we are interested in. You should create a new project in a new folder (File -&gt; New Project). Within that new folder you should make three new folders: <code>inputs</code>, <code>outputs</code>, and <code>scripts.</code></p>
<p>In the scripts folder you should write and save a script along these lines. This script loads the libraries that we need, then visits my website, and saves a local copy.</p>
<div class="sourceCode" id="cb198"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#### Contact details ####</span>
<span class="co"># Title: Get data from rohanalexander.com</span>
<span class="co"># Purpose: This script gets data from Rohan's website about the books that he </span>
<span class="co"># owns. It calls his website and then saves the dataset to inputs.</span>
<span class="co"># Author: Rohan Alexander</span>
<span class="co"># Contact: rohan.alexander@utoronto.ca</span>
<span class="co"># Last updated: 20 May 2020</span>


<span class="co">#### Set up workspace ####</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rvest.tidyverse.org/">rvest</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>


<span class="co">#### Get html ####</span>
<span class="va">rohans_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/read_xml.html">read_html</a></span><span class="op">(</span><span class="st">"https://rohanalexander.com/bookshelf.html"</span><span class="op">)</span>
<span class="co"># This takes a website as an input and will read it into R, in the same way that we </span>
<span class="co"># can read a, say, CSV into R.</span>

<span class="fu">write_html</span><span class="op">(</span><span class="va">rohans_data</span>, <span class="st">"inputs/my_website/raw_data.html"</span><span class="op">)</span> 
<span class="co"># Always save your raw dataset as soon as you get it so that you have a record </span>
<span class="co"># of it. This is the equivalent of, say, write_csv() that we have used earlier.</span></code></pre></div>
</div>
<div id="clean" class="section level3" number="8.6.3">
<h3>
<span class="header-section-number">8.6.3</span> Clean<a class="anchor" aria-label="anchor" href="#clean"><i class="fas fa-link"></i></a>
</h3>
<p>Now we need to navigate the HTML to get the aspects that we want, and to then put them into some sensible structure. I always try to get the data into a tibble as early as possible. While it’s possible to work with the nested data, I move to a tibble so that the usual verbs that I’m used to can be used.</p>
<p>In the scripts folder you should write and save a new R script along these lines. First, we need to add the top matter, read in the libraries and the data that we scraped.</p>
<div class="sourceCode" id="cb199"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#### Contact details ####</span>
<span class="co"># Title: Clean data from rohanaledander.com</span>
<span class="co"># Purpose: This script cleans data that was downloaded in 01-get_data.R.</span>
<span class="co"># Author: Rohan Alexander</span>
<span class="co"># Contact: rohan.alexander@utoronto.ca</span>
<span class="co"># Pre-requisites: Need to have run 01_get_data.R and have saved the data.</span>
<span class="co"># Last updated: 20 May 2020</span>


<span class="co">#### Set up workspace ####</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rvest.tidyverse.org/">rvest</a></span><span class="op">)</span>

<span class="va">rohans_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/read_xml.html">read_html</a></span><span class="op">(</span><span class="st">"inputs/my_website/raw_data.html"</span><span class="op">)</span>

<span class="va">rohans_data</span>
<span class="co">#&gt; {html_document}</span>
<span class="co">#&gt; &lt;html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang=""&gt;</span>
<span class="co">#&gt; [1] &lt;head&gt;\n&lt;meta http-equiv="Content-Type" content="text/html; charset=UTF-8 ...</span>
<span class="co">#&gt; [2] &lt;body&gt;\n\n&lt;!--radix_placeholder_front_matter--&gt;\n\n&lt;script id="distill-fr ...</span></code></pre></div>
<p>Now we need to identify the data that we are interested in using html tags and convert it to a tibble. If you look at the website, then you should notice that we are likely trying to focus on list items (Figure <a href="gather-data.html#fig:rohansbooks">8.4</a>).</p>
<div class="figure">
<span style="display:block;" id="fig:rohansbooks"></span>
<img src="figures/rohansbooks.png" alt="Some of Rohan's books" width="90%"><p class="caption">
Figure 8.4: Some of Rohan’s books
</p>
</div>
<p>Let’s look at the source (Figure <a href="gather-data.html#fig:rohanssourceone">8.5</a>).</p>
<div class="figure">
<span style="display:block;" id="fig:rohanssourceone"></span>
<img src="figures/sourcetop.png" alt="Source code for top of the page" width="90%"><p class="caption">
Figure 8.5: Source code for top of the page
</p>
</div>
<p>There’s a lot of debris, but scrolling down we eventually get to a list (Figure <a href="gather-data.html#fig:rohanssourcetwo">8.6</a>).</p>
<div class="figure">
<span style="display:block;" id="fig:rohanssourcetwo"></span>
<img src="figures/sourcelist.png" alt="Source code for list" width="90%"><p class="caption">
Figure 8.6: Source code for list
</p>
</div>
<p>The tag for a list item is ‘li,’ so we modify the earlier code to focus on that and to get the text.</p>
<div class="sourceCode" id="cb200"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#### Clean data ####</span>
<span class="co"># Identify the lines that have books on them based on the list html tag</span>
<span class="va">text_data</span> <span class="op">&lt;-</span> <span class="va">rohans_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://rvest.tidyverse.org/reference/rename.html">html_nodes</a></span><span class="op">(</span><span class="st">"li"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://rvest.tidyverse.org/reference/html_text.html">html_text</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">all_books</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>books <span class="op">=</span> <span class="va">text_data</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">all_books</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 × 1</span>
<span class="co">#&gt;   books                                                                         </span>
<span class="co">#&gt;   &lt;chr&gt;                                                                         </span>
<span class="co">#&gt; 1 "-“A Little Life”, Hanya Yanighara. Recommended by Lauren."                   </span>
<span class="co">#&gt; 2 "“The Andromeda Strain”, Michael Crichton."                                   </span>
<span class="co">#&gt; 3 "“Is There Life After Housework”, Don Aslett.\nGot given this at the Museum o…</span>
<span class="co">#&gt; 4 "“The Chosen”, Chaim Potok."                                                  </span>
<span class="co">#&gt; 5 "“The Forsyth Saga”, John Galsworthy."                                        </span>
<span class="co">#&gt; 6 "“Freakonomics”, Steven Levitt and Stephen Dubner."</span></code></pre></div>
<p>We now need to clean the data. First we want to separate the title and the author</p>
<div class="sourceCode" id="cb201"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># All content is just one string, so need to separate title and author</span>
<span class="va">all_books</span> <span class="op">&lt;-</span>
  <span class="va">all_books</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate.html">separate</a></span><span class="op">(</span><span class="va">books</span>, into <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"title"</span>, <span class="st">"author"</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"”"</span><span class="op">)</span>

<span class="co"># Remove leading comma and clean up the titles a little</span>
<span class="va">all_books</span> <span class="op">&lt;-</span>
  <span class="va">all_books</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>author <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove_all</a></span><span class="op">(</span><span class="va">author</span>, <span class="st">"^, "</span><span class="op">)</span>,
         author <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_trim.html">str_squish</a></span><span class="op">(</span><span class="va">author</span><span class="op">)</span>,
         title <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove</a></span><span class="op">(</span><span class="va">title</span>, <span class="st">"“"</span><span class="op">)</span>,
         title <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove</a></span><span class="op">(</span><span class="va">title</span>, <span class="st">"^-"</span><span class="op">)</span>
         <span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">all_books</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 × 2</span>
<span class="co">#&gt;   title                         author                                          </span>
<span class="co">#&gt;   &lt;chr&gt;                         &lt;chr&gt;                                           </span>
<span class="co">#&gt; 1 A Little Life                 Hanya Yanighara. Recommended by Lauren.         </span>
<span class="co">#&gt; 2 The Andromeda Strain          Michael Crichton.                               </span>
<span class="co">#&gt; 3 Is There Life After Housework Don Aslett. Got given this at the Museum of Cle…</span>
<span class="co">#&gt; 4 The Chosen                    Chaim Potok.                                    </span>
<span class="co">#&gt; 5 The Forsyth Saga              John Galsworthy.                                </span>
<span class="co">#&gt; 6 Freakonomics                  Steven Levitt and Stephen Dubner.</span></code></pre></div>
<p>Finally, some specific cleaning is needed.</p>
<div class="sourceCode" id="cb202"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Some authors have comments after their name, so need to get rid of them, although there are some exceptions that will not work</span>
<span class="co"># J. K. Rowling.</span>
<span class="co"># M. Mitchell Waldrop.</span>
<span class="co"># David A. Price</span>
<span class="va">all_books</span> <span class="op">&lt;-</span>
  <span class="va">all_books</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>author <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op">(</span><span class="va">author</span>,
                              <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"J. K. Rowling."</span> <span class="op">=</span> <span class="st">"J K Rowling."</span>,
                                <span class="st">"M. Mitchell Waldrop."</span> <span class="op">=</span> <span class="st">"M Mitchell Waldrop."</span>,
                                <span class="st">"David A. Price"</span> <span class="op">=</span> <span class="st">"David A Price"</span><span class="op">)</span>
                              <span class="op">)</span>
         <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate.html">separate</a></span><span class="op">(</span><span class="va">author</span>, into <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"author_correct"</span>, <span class="st">"throw_away"</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"\\."</span>, extra <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">throw_away</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>author <span class="op">=</span> <span class="va">author_correct</span><span class="op">)</span>

<span class="co"># Some books have multiple authors, so need to separate them</span>
<span class="co"># One has multiple authors:</span>
<span class="co"># "Daniela Witten, Gareth James, Robert Tibshirani, and Trevor Hastie"</span>
<span class="va">all_books</span> <span class="op">&lt;-</span>
  <span class="va">all_books</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>author <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace</a></span><span class="op">(</span><span class="va">author</span>,
                              <span class="st">"Daniela Witten, Gareth James, Robert Tibshirani, and Trevor Hastie"</span>,
                              <span class="st">"Daniela Witten and Gareth James and Robert Tibshirani and Trevor Hastie"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate.html">separate</a></span><span class="op">(</span><span class="va">author</span>, into <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"author_first"</span>, <span class="st">"author_second"</span>, <span class="st">"author_third"</span>, <span class="st">"author_fourth"</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">" and "</span>, fill <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"author_"</span><span class="op">)</span>,
               names_to <span class="op">=</span> <span class="st">"author_position"</span>,
               values_to <span class="op">=</span> <span class="st">"author"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">author_position</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">author</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">all_books</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 × 2</span>
<span class="co">#&gt;   title                         author          </span>
<span class="co">#&gt;   &lt;chr&gt;                         &lt;chr&gt;           </span>
<span class="co">#&gt; 1 A Little Life                 Hanya Yanighara </span>
<span class="co">#&gt; 2 The Andromeda Strain          Michael Crichton</span>
<span class="co">#&gt; 3 Is There Life After Housework Don Aslett      </span>
<span class="co">#&gt; 4 The Chosen                    Chaim Potok     </span>
<span class="co">#&gt; 5 The Forsyth Saga              John Galsworthy </span>
<span class="co">#&gt; 6 Freakonomics                  Steven Levitt</span></code></pre></div>
<p>It looks there is some at the end because I have a best of. I’ll just get rid of those manually because it’s not the focus.</p>
<div class="sourceCode" id="cb203"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">all_books</span> <span class="op">&lt;-</span> 
  <span class="va">all_books</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">118</span><span class="op">)</span></code></pre></div>
</div>
<div id="explore-3" class="section level3" number="8.6.4">
<h3>
<span class="header-section-number">8.6.4</span> Explore<a class="anchor" aria-label="anchor" href="#explore-3"><i class="fas fa-link"></i></a>
</h3>
<p>Finally, just because we have the data now, so we may as well try to do something with it, let’s look at the distribution of the first letter of the author names.</p>
<div class="sourceCode" id="cb204"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">all_books</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
    first_letter <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op">(</span><span class="va">author</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>
    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">first_letter</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 21 × 2</span>
<span class="co">#&gt; # Groups:   first_letter [21]</span>
<span class="co">#&gt;    first_letter     n</span>
<span class="co">#&gt;    &lt;chr&gt;        &lt;int&gt;</span>
<span class="co">#&gt;  1 ""               1</span>
<span class="co">#&gt;  2 "A"              8</span>
<span class="co">#&gt;  3 "B"              5</span>
<span class="co">#&gt;  4 "C"              4</span>
<span class="co">#&gt;  5 "D"             10</span>
<span class="co">#&gt;  6 "E"              3</span>
<span class="co">#&gt;  7 "F"              1</span>
<span class="co">#&gt;  8 "G"             10</span>
<span class="co">#&gt;  9 "H"              6</span>
<span class="co">#&gt; 10 "I"              1</span>
<span class="co">#&gt; # … with 11 more rows</span></code></pre></div>
</div>
</div>
<div id="case-study---canadian-prime-ministers" class="section level2" number="8.7">
<h2>
<span class="header-section-number">8.7</span> Case study - Canadian Prime Ministers<a class="anchor" aria-label="anchor" href="#case-study---canadian-prime-ministers"><i class="fas fa-link"></i></a>
</h2>
<div id="introduction-8" class="section level3" number="8.7.1">
<h3>
<span class="header-section-number">8.7.1</span> Introduction<a class="anchor" aria-label="anchor" href="#introduction-8"><i class="fas fa-link"></i></a>
</h3>
<p>In this case study we are interested in how long Canadian prime ministers lived, based on the year that they were born. We will scrape data from Wikipedia, clean it, and then make a graph.</p>
<p>The key library that we will use for scraping is <code>rvest</code>. This adds a lot of functions that will make life easier. That said, every time you scrape a website things will change. Each scrape will largely be bespoke, even if you can borrow some code from earlier projects that you have completed. It is completely normal to feel frustrated at times. It helps to begin with an end in mind.</p>
<p>To that end, let’s generate some simulated data. Ideally, we want a table that has a row for each prime minister, a column for their name, and a column each for the birth and death years. If they are still alive, then that death year can be empty. We know that birth and death years should be somewhere between 1700 and 1990, and that death year should be larger than birth year. Finally, we also know that the years should be integers, and the names should be characters. So, we want something that looks roughly like this:</p>
<div class="sourceCode" id="cb205"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/hadley/babynames">babynames</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>

<span class="va">simulated_dataset</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>prime_minister <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">babynames</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">prop</span> <span class="op">&gt;</span> <span class="fl">0.01</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
                                   <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">name</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="op">)</span>, 
                                 size <span class="op">=</span> <span class="fl">10</span>, replace <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,
         birth_year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1700</span><span class="op">:</span><span class="fl">1990</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">10</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
         years_lived <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">50</span><span class="op">:</span><span class="fl">100</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">10</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
         death_year <span class="op">=</span> <span class="va">birth_year</span> <span class="op">+</span> <span class="va">years_lived</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">prime_minister</span>, <span class="va">birth_year</span>, <span class="va">death_year</span>, <span class="va">years_lived</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">birth_year</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">simulated_dataset</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 × 4</span>
<span class="co">#&gt;   prime_minister birth_year death_year years_lived</span>
<span class="co">#&gt;   &lt;chr&gt;               &lt;int&gt;      &lt;int&gt;       &lt;int&gt;</span>
<span class="co">#&gt; 1 Judith               1712       1772          60</span>
<span class="co">#&gt; 2 Joshua               1713       1802          89</span>
<span class="co">#&gt; 3 Jeremy               1778       1856          78</span>
<span class="co">#&gt; 4 Helen                1788       1840          52</span>
<span class="co">#&gt; 5 Mildred              1809       1860          51</span>
<span class="co">#&gt; 6 Emma                 1810       1862          52</span></code></pre></div>
<p>One of the advantages of generating a simulated dataset is that if you are working in groups then one person can start making the graph, using the simulated dataset, while the other person gathers the data. In terms of a graph, we want something like Figure <a href="gather-data.html#fig:pmsgraphexample">8.7</a>.</p>
<div class="figure">
<span style="display:block;" id="fig:pmsgraphexample"></span>
<img src="figures/IMG_4185.jpeg" alt="Sketch of planned graph." width="90%"><p class="caption">
Figure 8.7: Sketch of planned graph.
</p>
</div>
</div>
<div id="gather-1" class="section level3" number="8.7.2">
<h3>
<span class="header-section-number">8.7.2</span> Gather<a class="anchor" aria-label="anchor" href="#gather-1"><i class="fas fa-link"></i></a>
</h3>
<p>We are starting with a question that is of interest, which how long each Canadian prime minister lived. As such, we need to identify a source of data While there are likely to be plenty of data sources that have the births and deaths of each prime minister, we want one that we can trust, and as we are going to be scraping, we want one that has some structure to it. The Wikipedia page (<a href="https://en.wikipedia.org/wiki/List_of_prime_ministers_of_Canada" class="uri">https://en.wikipedia.org/wiki/List_of_prime_ministers_of_Canada</a>) fits both these criteria. As it is a popular page the information is more likely to be correct, and the data are available in a table.</p>
<p>We load the library and then we read in the data from the relevant page. The key function here is <code><a href="http://xml2.r-lib.org/reference/read_xml.html">read_html()</a></code>, which you can use in the same way as, say, <code><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv()</a></code>, except that it takes a html page as an input. Once you call <code><a href="http://xml2.r-lib.org/reference/read_xml.html">read_html()</a></code> then the page is downloaded to your own computer, and it is usually a good idea to save this, using <code>write_html()</code> as it is your raw data. Saving it also means that we don’t have to keep visiting the website when we want to start again with our cleaning, and so it is part of being polite. However, it is likely not our property (in the case of Wikipedia, we might be okay), and so you should probably not share it.</p>
<div class="sourceCode" id="cb206"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rvest.tidyverse.org/">rvest</a></span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb207"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">raw_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/read_xml.html">read_html</a></span><span class="op">(</span><span class="st">"https://en.wikipedia.org/wiki/List_of_prime_ministers_of_Canada"</span><span class="op">)</span>
<span class="fu">write_html</span><span class="op">(</span><span class="va">raw_data</span>, <span class="st">"inputs/wiki/pms.html"</span><span class="op">)</span> <span class="co"># Note that we save the file as a html file.</span></code></pre></div>
</div>
<div id="clean-1" class="section level3" number="8.7.3">
<h3>
<span class="header-section-number">8.7.3</span> Clean<a class="anchor" aria-label="anchor" href="#clean-1"><i class="fas fa-link"></i></a>
</h3>
<p>Websites are made up of html, which is a markup language. We are looking for patterns in the mark-up that we can use to help us get closer to the data that we want. This is an iterative process and requires a lot of trial and error. Even simple examples will take time. You can look at the html by using a browser, right clicking, and then selecting <code>view page source</code>. Similarly, you could open the html file using a text editor.</p>
<div id="by-inspection" class="section level4" number="8.7.3.1">
<h4>
<span class="header-section-number">8.7.3.1</span> By inspection<a class="anchor" aria-label="anchor" href="#by-inspection"><i class="fas fa-link"></i></a>
</h4>
<p>We are looking for patterns that we can use to select the information that is of interest - names, birth year, and death year. When we look at the html it looks like there is something going on with <code>&lt;tr&gt;</code>, and then <code>&lt;td&gt;</code> (thanks to Thomas Rosenthal for identifying this). We select those nodes using <code><a href="https://rvest.tidyverse.org/reference/rename.html">html_nodes()</a></code>, which takes the tags as an input. If you only want the first one then there is a singular version, <code><a href="https://rvest.tidyverse.org/reference/rename.html">html_node()</a></code>.</p>
<div class="sourceCode" id="cb208"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Read in our saved data</span>
<span class="va">raw_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/read_xml.html">read_html</a></span><span class="op">(</span><span class="st">"inputs/wiki/pms.html"</span><span class="op">)</span>

<span class="co"># We can parse tags in order</span>
<span class="va">parse_data_inspection</span> <span class="op">&lt;-</span> 
  <span class="va">raw_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rvest.tidyverse.org/reference/rename.html">html_nodes</a></span><span class="op">(</span><span class="st">"tr"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rvest.tidyverse.org/reference/rename.html">html_nodes</a></span><span class="op">(</span><span class="st">"td"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rvest.tidyverse.org/reference/html_text.html">html_text</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># html_text removes any remaining html tags</span>

<span class="co"># But this code does exactly the same thing - the nodes are just pushed into </span>
<span class="co"># the one function call</span>
<span class="va">parse_data_inspection</span> <span class="op">&lt;-</span> 
  <span class="va">raw_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rvest.tidyverse.org/reference/rename.html">html_nodes</a></span><span class="op">(</span><span class="st">"tr td"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rvest.tidyverse.org/reference/html_text.html">html_text</a></span><span class="op">(</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">parse_data_inspection</span><span class="op">)</span>
<span class="co">#&gt; [1] "Abbreviation key:"                                                                                                                                                                                                                              </span>
<span class="co">#&gt; [2] "No.: Incumbent number, Min.: Ministry, Refs: References\n"                                                                                                                                                                                      </span>
<span class="co">#&gt; [3] "Colour key:"                                                                                                                                                                                                                                    </span>
<span class="co">#&gt; [4] "\n\n  Liberal Party of Canada\n \n  Historical Conservative parties (including Liberal-Conservative, Conservative (Historical),     Unionist, National Liberal and Conservative, Progressive Conservative) \n  Conservative Party of Canada\n\n"</span>
<span class="co">#&gt; [5] "Provinces key:"                                                                                                                                                                                                                                 </span>
<span class="co">#&gt; [6] "AB: Alberta, BC: British Columbia, MB: Manitoba, NS: Nova Scotia,ON: Ontario, QC: Quebec, SK: Saskatchewan\n"</span></code></pre></div>
<p>At this point our data is in a character vector, we want to convert it to a table, and reduce the data down to just the information that we want. The key that is going to allow us to do this is the fact that there seems to be a blank line (which in html is denoted by <code>\n</code>) before the key information that we need. So, once we identify that line then we can filter to just the line below it!</p>
<div class="sourceCode" id="cb209"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">parsed_data</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>raw_text <span class="op">=</span> <span class="va">parse_data_inspection</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># Convert the character vector to a table</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>is_PM <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">raw_text</span> <span class="op">==</span> <span class="st">"\n\n"</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>, <span class="co"># Look for the blank line that is </span>
         <span class="co"># above the row that we want</span>
         is_PM <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">is_PM</span>, n <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># Identify the actual row that we want</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">is_PM</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="co"># Just get the rows that we want</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">parsed_data</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 × 2</span>
<span class="co">#&gt;   raw_text                                                                 is_PM</span>
<span class="co">#&gt;   &lt;chr&gt;                                                                    &lt;dbl&gt;</span>
<span class="co">#&gt; 1 "\nSir John A. MacDonald(1815–1891)MP for Kingston, ON\n"                    1</span>
<span class="co">#&gt; 2 "\nAlexander Mackenzie(1822–1892)MP for Lambton, ON\n"                       1</span>
<span class="co">#&gt; 3 "\nSir John A. MacDonald(1815–1891)MP for Victoria, BC until 1882MP for…     1</span>
<span class="co">#&gt; 4 "\nSir John Abbott(1821–1893)Senator for Quebec\n"                           1</span>
<span class="co">#&gt; 5 "\nSir John Thompson(1845–1894)MP for Antigonish, NS\n"                      1</span>
<span class="co">#&gt; 6 "\nSir Mackenzie Bowell(1823–1917)Senator for Ontario\n"                     1</span></code></pre></div>
</div>
<div id="using-the-selector-gadget" class="section level4" number="8.7.3.2">
<h4>
<span class="header-section-number">8.7.3.2</span> Using the selector gadget<a class="anchor" aria-label="anchor" href="#using-the-selector-gadget"><i class="fas fa-link"></i></a>
</h4>
<p>If you are comfortable with html then you might be able to see patterns, but one tool that may help is the SelectorGadget: <a href="https://cran.r-project.org/web/packages/rvest/vignettes/selectorgadget.html" class="uri">https://cran.r-project.org/web/packages/rvest/vignettes/selectorgadget.html</a>. This allows you to pick and choose the elements that you want, and then gives you the input to give to <code><a href="https://rvest.tidyverse.org/reference/rename.html">html_nodes()</a></code> (Figure <a href="gather-data.html#fig:selectorgadget">8.8</a>)</p>
<div class="figure">
<span style="display:block;" id="fig:selectorgadget"></span>
<img src="figures/selectorgadget.png" alt="Using the Selector Gadget to identify the tag, as at 13 March 2020." width="90%"><p class="caption">
Figure 8.8: Using the Selector Gadget to identify the tag, as at 13 March 2020.
</p>
</div>
<div class="sourceCode" id="cb210"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Read in our saved data</span>
<span class="va">raw_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/read_xml.html">read_html</a></span><span class="op">(</span><span class="st">"inputs/wiki/pms.html"</span><span class="op">)</span>

<span class="co"># We can parse tags in order</span>
<span class="va">parse_data_selector_gadget</span> <span class="op">&lt;-</span> 
  <span class="va">raw_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rvest.tidyverse.org/reference/rename.html">html_nodes</a></span><span class="op">(</span><span class="st">"td:nth-child(3)"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rvest.tidyverse.org/reference/html_text.html">html_text</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># html_text removes any remaining html tags</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">parse_data_selector_gadget</span><span class="op">)</span>
<span class="co">#&gt; [1] "\nSir John A. MacDonald(1815–1891)MP for Kingston, ON\n"                                                            </span>
<span class="co">#&gt; [2] "\nAlexander Mackenzie(1822–1892)MP for Lambton, ON\n"                                                               </span>
<span class="co">#&gt; [3] "\nSir John A. MacDonald(1815–1891)MP for Victoria, BC until 1882MP for Carleton, ON until 1887MP for Kingston, ON\n"</span>
<span class="co">#&gt; [4] "\nSir John Abbott(1821–1893)Senator for Quebec\n"                                                                   </span>
<span class="co">#&gt; [5] "\nSir John Thompson(1845–1894)MP for Antigonish, NS\n"                                                              </span>
<span class="co">#&gt; [6] "\nSir Mackenzie Bowell(1823–1917)Senator for Ontario\n"</span></code></pre></div>
<p>In this case there is one prime minister - Robert Borden - who changed party and we would need to filter away that row: <code>\nUnionist Party\n"</code>.</p>
</div>
<div id="clean-data" class="section level4" number="8.7.3.3">
<h4>
<span class="header-section-number">8.7.3.3</span> Clean data<a class="anchor" aria-label="anchor" href="#clean-data"><i class="fas fa-link"></i></a>
</h4>
<p>Now that we have the parsed data, we need to clean it to match what we wanted. In particular we want a names column, as well as columns for birth year and death year. We will use <code><a href="https://tidyr.tidyverse.org/reference/separate.html">separate()</a></code> to take advantage of the fact that it looks like the dates are distinguished by brackets.</p>
<div class="sourceCode" id="cb211"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">initial_clean</span> <span class="op">&lt;-</span> 
  <span class="va">parsed_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate.html">separate</a></span><span class="op">(</span><span class="va">raw_text</span>, 
            into <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Name"</span>, <span class="st">"not_name"</span><span class="op">)</span>, 
            sep <span class="op">=</span> <span class="st">"\\("</span>,
            remove <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># The remove = FALSE option here means that we </span>
  <span class="co"># keep the original column that we are separating.</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate.html">separate</a></span><span class="op">(</span><span class="va">not_name</span>, 
            into <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Date"</span>, <span class="st">"all_the_rest"</span><span class="op">)</span>, 
            sep <span class="op">=</span> <span class="st">"\\)"</span>,
            remove <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">initial_clean</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 × 6</span>
<span class="co">#&gt;   raw_text           Name     not_name          Date  all_the_rest         is_PM</span>
<span class="co">#&gt;   &lt;chr&gt;              &lt;chr&gt;    &lt;chr&gt;             &lt;chr&gt; &lt;chr&gt;                &lt;dbl&gt;</span>
<span class="co">#&gt; 1 "\nSir John A. Ma… "\nSir … "1815–1891)MP fo… 1815… "MP for Kingston, O…     1</span>
<span class="co">#&gt; 2 "\nAlexander Mack… "\nAlex… "1822–1892)MP fo… 1822… "MP for Lambton, ON…     1</span>
<span class="co">#&gt; 3 "\nSir John A. Ma… "\nSir … "1815–1891)MP fo… 1815… "MP for Victoria, B…     1</span>
<span class="co">#&gt; 4 "\nSir John Abbot… "\nSir … "1821–1893)Senat… 1821… "Senator for Quebec…     1</span>
<span class="co">#&gt; 5 "\nSir John Thomp… "\nSir … "1845–1894)MP fo… 1845… "MP for Antigonish,…     1</span>
<span class="co">#&gt; 6 "\nSir Mackenzie … "\nSir … "1823–1917)Senat… 1823… "Senator for Ontari…     1</span></code></pre></div>
<p>Finally, we need to clean up the columns.</p>
<div class="sourceCode" id="cb212"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cleaned_data</span> <span class="op">&lt;-</span> 
  <span class="va">initial_clean</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">Name</span>, <span class="va">Date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate.html">separate</a></span><span class="op">(</span><span class="va">Date</span>, into <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Birth"</span>, <span class="st">"Died"</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"–"</span>, remove <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># The </span>
  <span class="co"># PMs who have died have their birth and death years separated by a hyphen, but </span>
  <span class="co"># you need to be careful with the hyphen as it seems to be a slightly odd type of </span>
  <span class="co"># hyphen and you need to copy/paste it.</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Birth <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove</a></span><span class="op">(</span><span class="va">Birth</span>, <span class="st">"b. "</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># Alive PMs have slightly different format</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">Date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Name <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove</a></span><span class="op">(</span><span class="va">Name</span>, <span class="st">"\n"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># Remove some html tags that remain</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html">mutate_at</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html">vars</a></span><span class="op">(</span><span class="va">Birth</span>, <span class="va">Died</span><span class="op">)</span>, <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># Change birth and death to integers</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Age_at_Death <span class="op">=</span> <span class="va">Died</span> <span class="op">-</span> <span class="va">Birth</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  <span class="co"># Add column of the number of years they lived</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># Some of the PMs had two goes at it.</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">cleaned_data</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 × 4</span>
<span class="co">#&gt;   Name                  Birth  Died Age_at_Death</span>
<span class="co">#&gt;   &lt;chr&gt;                 &lt;int&gt; &lt;int&gt;        &lt;int&gt;</span>
<span class="co">#&gt; 1 Sir John A. MacDonald  1815  1891           76</span>
<span class="co">#&gt; 2 Alexander Mackenzie    1822  1892           70</span>
<span class="co">#&gt; 3 Sir John Abbott        1821  1893           72</span>
<span class="co">#&gt; 4 Sir John Thompson      1845  1894           49</span>
<span class="co">#&gt; 5 Sir Mackenzie Bowell   1823  1917           94</span>
<span class="co">#&gt; 6 Sir Charles Tupper     1821  1915           94</span></code></pre></div>
</div>
</div>
<div id="explore-4" class="section level3" number="8.7.4">
<h3>
<span class="header-section-number">8.7.4</span> Explore<a class="anchor" aria-label="anchor" href="#explore-4"><i class="fas fa-link"></i></a>
</h3>
<p>At this point we’d like to make a graph that illustrates how long each prime minister lived. If they are still alive then we would like them to run to the end, but we would like to colour them differently.</p>
<div class="sourceCode" id="cb213"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cleaned_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>still_alive <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">Died</span><span class="op">)</span>, <span class="st">"Yes"</span>, <span class="st">"No"</span><span class="op">)</span>,
         Died <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">Died</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="fl">2020</span><span class="op">)</span>, <span class="va">Died</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Name <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/as_factor.html">as_factor</a></span><span class="op">(</span><span class="va">Name</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Birth</span>, 
             xend <span class="op">=</span> <span class="va">Died</span>,
             y <span class="op">=</span> <span class="va">Name</span>,
             yend <span class="op">=</span> <span class="va">Name</span>, 
             color <span class="op">=</span> <span class="va">still_alive</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_segment.html">geom_segment</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Year of birth"</span>,
       y <span class="op">=</span> <span class="st">"Prime minister"</span>,
       color <span class="op">=</span> <span class="st">"PM is alive"</span>,
       title <span class="op">=</span> <span class="st">"Canadian Prime Minister, by year of birth"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_color_brewer</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Set1"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="20-gather_files/figure-html/unnamed-chunk-35-1.png" width="672"></div>
</div>
</div>
<div id="pdfs" class="section level2" number="8.8">
<h2>
<span class="header-section-number">8.8</span> PDFs<a class="anchor" aria-label="anchor" href="#pdfs"><i class="fas fa-link"></i></a>
</h2>
<div id="introduction-9" class="section level3" number="8.8.1">
<h3>
<span class="header-section-number">8.8.1</span> Introduction<a class="anchor" aria-label="anchor" href="#introduction-9"><i class="fas fa-link"></i></a>
</h3>
<p>In contrast to an API, a PDF is usually only produced for human (not computer) consumption. The nice thing about PDFs is that they are static and constant. And it is nice that they make data available at all. But the trade-off is that:</p>
<ul>
<li>It is not overly useful to do larger-scale statistical analysis.</li>
<li>We don’t know how the PDF was put together so we don’t know whether we can trust it.</li>
<li>We can’t manipulate the data to get results that we are interested in.</li>
</ul>
<p>Indeed, sometimes governments publish data as PDFs because they don’t actually want you to be able to analyse it! Being able to get data from PDFs opens up a large number of datasets for you, some of which we’ll see in this chapter.</p>
<p>There are two important aspects to keep in mind when approaching a PDF with a mind to extracting data from it:</p>
<ol style="list-style-type: decimal">
<li>Begin with an end in mind. Planning and then literally sketching out what you want from a final dataset/graph/paper stops you wasting time and keeps you focused.</li>
<li>Start simple, then iterate. The quickest way to make a complicated model is often to first build a simple model and then complicate it. Start with just trying to get one page of the PDF working or even just one line. Then iterate from there.</li>
</ol>
<p>In this chapter we start by walking through several examples and then go through three case studies of varying difficulty.</p>
</div>
<div id="getting-started-3" class="section level3" number="8.8.2">
<h3>
<span class="header-section-number">8.8.2</span> Getting started<a class="anchor" aria-label="anchor" href="#getting-started-3"><i class="fas fa-link"></i></a>
</h3>
<p>Figure <a href="gather-data.html#fig:firstpdfexample">8.9</a> is a PDF that consists of just the first sentence from Jane Eyre taken from Project Gutenberg <span class="citation"><a href="references-1.html#ref-janeeyre" role="doc-biblioref">Bronte</a> (<a href="references-1.html#ref-janeeyre" role="doc-biblioref">1847</a>)</span>.</p>
<div class="figure">
<span style="display:block;" id="fig:firstpdfexample"></span>
<img src="inputs/pdfs/first_example.png" alt="First sentence of Jane Eyre" width="90%"><p class="caption">
Figure 8.9: First sentence of Jane Eyre
</p>
</div>
<p>We will use the package <code>pdftools</code> <span class="citation"><a href="references-1.html#ref-citepdftools" role="doc-biblioref">Ooms</a> (<a href="references-1.html#ref-citepdftools" role="doc-biblioref">2019a</a>)</span> to get the text in this one page PDF into R.</p>
<div class="sourceCode" id="cb214"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># install.packages("pdftools")</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/pdftools/">pdftools</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>

<span class="va">first_example</span> <span class="op">&lt;-</span> <span class="fu">pdftools</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/pdftools/reference/pdftools.html">pdf_text</a></span><span class="op">(</span><span class="st">"inputs/pdfs/first_example.pdf"</span><span class="op">)</span>

<span class="va">first_example</span>
<span class="co">#&gt; [1] "There was no possibility of taking a walk that day.\n"</span>

<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">first_example</span><span class="op">)</span>
<span class="co">#&gt; [1] "character"</span></code></pre></div>
<p>We can see that the PDF has been correctly read in, as a character vector.</p>
<p>We will now try a slightly more complicated example that consists of the first few paragraphs of Jane Eyre (Figure <a href="gather-data.html#fig:secondpdfexample">8.10</a>). Also notice that now we have the chapter heading as well.</p>
<div class="figure">
<span style="display:block;" id="fig:secondpdfexample"></span>
<img src="inputs/pdfs/second_example.png" alt="First few paragraphs of Jane Eyre" width="90%"><p class="caption">
Figure 8.10: First few paragraphs of Jane Eyre
</p>
</div>
<p>We use the same function as before.</p>
<div class="sourceCode" id="cb215"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">second_example</span> <span class="op">&lt;-</span> <span class="fu">pdftools</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/pdftools/reference/pdftools.html">pdf_text</a></span><span class="op">(</span><span class="st">"inputs/pdfs/second_example.pdf"</span><span class="op">)</span>

<span class="va">second_example</span>
<span class="co">#&gt; [1] "CHAPTER I\nThere was no possibility of taking a walk that day. We had been wandering, indeed, in the\nleafless shrubbery an hour in the morning; but since dinner (Mrs. Reed, when there was no\ncompany, dined early) the cold winter wind had brought with it clouds so sombre, and a rain so\npenetrating, that further out-door exercise was now out of the question.\n\nI was glad of it: I never liked long walks, especially on chilly afternoons: dreadful to me was the\ncoming home in the raw twilight, with nipped fingers and toes, and a heart saddened by the\nchidings of Bessie, the nurse, and humbled by the consciousness of my physical inferiority to\nEliza, John, and Georgiana Reed.\n\nThe said Eliza, John, and Georgiana were now clustered round their mama in the drawing-room:\nshe lay reclined on a sofa by the fireside, and with her darlings about her (for the time neither\nquarrelling nor crying) looked perfectly happy. Me, she had dispensed from joining the group;\nsaying, “She regretted to be under the necessity of keeping me at a distance; but that until she\nheard from Bessie, and could discover by her own observation, that I was endeavouring in good\nearnest to acquire a more sociable and childlike disposition, a more attractive and sprightly\nmanner—something lighter, franker, more natural, as it were—she really must exclude me from\nprivileges intended only for contented, happy, little children.”\n\n“What does Bessie say I have done?” I asked.\n\n“Jane, I don’t like cavillers or questioners; besides, there is something truly forbidding in a child\ntaking up her elders in that manner. Be seated somewhere; and until you can speak pleasantly,\nremain silent.”\n\nA breakfast-room adjoined the drawing-room, I slipped in there. It contained a bookcase: I soon\npossessed myself of a volume, taking care that it should be one stored with pictures. I mounted\ninto the window-seat: gathering up my feet, I sat cross-legged, like a Turk; and, having drawn the\nred moreen curtain nearly close, I was shrined in double retirement.\n\nFolds of scarlet drapery shut in my view to the right hand; to the left were the clear panes of\nglass, protecting, but not separating me from the drear November day. At intervals, while\nturning over the leaves of my book, I studied the aspect of that winter afternoon. Afar, it offered\na pale blank of mist and cloud; near a scene of wet lawn and storm-beat shrub, with ceaseless\nrain sweeping away wildly before a long and lamentable blast.\n"</span>

<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">second_example</span><span class="op">)</span>
<span class="co">#&gt; [1] "character"</span></code></pre></div>
<p>Again, we have a character vector. The end of each line is signalled by ‘\n,’ but other than that it looks pretty good.</p>
<p>Finally, we consider the first two pages.</p>
<p>We use the same function as before.</p>
<div class="sourceCode" id="cb216"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">third_example</span> <span class="op">&lt;-</span> <span class="fu">pdftools</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/pdftools/reference/pdftools.html">pdf_text</a></span><span class="op">(</span><span class="st">"inputs/pdfs/third_example.pdf"</span><span class="op">)</span>

<span class="va">third_example</span>
<span class="co">#&gt; [1] "CHAPTER I\nThere was no possibility of taking a walk that day. We had been wandering, indeed, in the\nleafless shrubbery an hour in the morning; but since dinner (Mrs. Reed, when there was no\ncompany, dined early) the cold winter wind had brought with it clouds so sombre, and a rain so\npenetrating, that further out-door exercise was now out of the question.\n\nI was glad of it: I never liked long walks, especially on chilly afternoons: dreadful to me was the\ncoming home in the raw twilight, with nipped fingers and toes, and a heart saddened by the\nchidings of Bessie, the nurse, and humbled by the consciousness of my physical inferiority to\nEliza, John, and Georgiana Reed.\n\nThe said Eliza, John, and Georgiana were now clustered round their mama in the drawing-room:\nshe lay reclined on a sofa by the fireside, and with her darlings about her (for the time neither\nquarrelling nor crying) looked perfectly happy. Me, she had dispensed from joining the group;\nsaying, “She regretted to be under the necessity of keeping me at a distance; but that until she\nheard from Bessie, and could discover by her own observation, that I was endeavouring in good\nearnest to acquire a more sociable and childlike disposition, a more attractive and sprightly\nmanner—something lighter, franker, more natural, as it were—she really must exclude me from\nprivileges intended only for contented, happy, little children.”\n\n“What does Bessie say I have done?” I asked.\n\n“Jane, I don’t like cavillers or questioners; besides, there is something truly forbidding in a child\ntaking up her elders in that manner. Be seated somewhere; and until you can speak pleasantly,\nremain silent.”\n\nA breakfast-room adjoined the drawing-room, I slipped in there. It contained a bookcase: I soon\npossessed myself of a volume, taking care that it should be one stored with pictures. I mounted\ninto the window-seat: gathering up my feet, I sat cross-legged, like a Turk; and, having drawn the\nred moreen curtain nearly close, I was shrined in double retirement.\n\nFolds of scarlet drapery shut in my view to the right hand; to the left were the clear panes of\nglass, protecting, but not separating me from the drear November day. At intervals, while\nturning over the leaves of my book, I studied the aspect of that winter afternoon. Afar, it offered\na pale blank of mist and cloud; near a scene of wet lawn and storm-beat shrub, with ceaseless\nrain sweeping away wildly before a long and lamentable blast.\n\nI returned to my book—Bewick’s History of British Birds: the letterpress thereof I cared little\nfor, generally speaking; and yet there were certain introductory pages that, child as I was, I could\nnot pass quite as a blank. They were those which treat of the haunts of sea-fowl; of “the solitary\nrocks and promontories” by them only inhabited; of the coast of Norway, studded with isles from\nits southern extremity, the Lindeness, or Naze, to the North Cape—\n\n“Where the Northern Ocean, in vast whirls,\nBoils round the naked, melancholy isles\n"</span>
<span class="co">#&gt; [2] "Of farthest Thule; and the Atlantic surge\nPours in among the stormy Hebrides.”\n\nNor could I pass unnoticed the suggestion of the bleak shores of Lapland, Siberia, Spitzbergen,\nNova Zembla, Iceland, Greenland, with “the vast sweep of the Arctic Zone, and those forlorn\nregions of dreary space,—that reservoir of frost and snow, where firm fields of ice, the\naccumulation of centuries of winters, glazed in Alpine heights above heights, surround the pole,\nand concentre the multiplied rigours of extreme cold.” Of these death-white realms I formed an\nidea of my own: shadowy, like all the half-comprehended notions that float dim through\nchildren’s brains, but strangely impressive. The words in these introductory pages connected\nthemselves with the succeeding vignettes, and gave significance to the rock standing up alone in\na sea of billow and spray; to the broken boat stranded on a desolate coast; to the cold and ghastly\nmoon glancing through bars of cloud at a wreck just sinking.\n\nI cannot tell what sentiment haunted the quite solitary churchyard, with its inscribed headstone;\nits gate, its two trees, its low horizon, girdled by a broken wall, and its newly-risen crescent,\nattesting the hour of eventide.\n\nThe two ships becalmed on a torpid sea, I believed to be marine phantoms.\n\nThe fiend pinning down the thief’s pack behind him, I passed over quickly: it was an object of\nterror.\n\nSo was the black horned thing seated aloof on a rock, surveying a distant crowd surrounding a\ngallows.\n\nEach picture told a story; mysterious often to my undeveloped understanding and imperfect\nfeelings, yet ever profoundly interesting: as interesting as the tales Bessie sometimes narrated on\nwinter evenings, when she chanced to be in good humour; and when, having brought her ironing-\ntable to the nursery hearth, she allowed us to sit about it, and while she got up Mrs. Reed’s lace\nfrills, and crimped her nightcap borders, fed our eager attention with passages of love and\nadventure taken from old fairy tales and other ballads; or (as at a later period I discovered) from\nthe pages of Pamela, and Henry, Earl of Moreland.\n\nWith Bewick on my knee, I was then happy: happy at least in my way. I feared nothing but\ninterruption, and that came too soon. The breakfast-room door opened.\n\n“Boh! Madam Mope!” cried the voice of John Reed; then he paused: he found the room\napparently empty.\n\n“Where the dickens is she!” he continued. “Lizzy! Georgy! (calling to his sisters) Joan is not\nhere: tell mama she is run out into the rain—bad animal!”\n\n“It is well I drew the curtain,” thought I; and I wished fervently he might not discover my hiding-\nplace: nor would John Reed have found it out himself; he was not quick either of vision or\nconception; but Eliza just put her head in at the door, and said at once—\n"</span>

<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">third_example</span><span class="op">)</span>
<span class="co">#&gt; [1] "character"</span></code></pre></div>
<p>Now, notice that the first page is the first element of the character vector and the second page is the second element.</p>
<p>As we’re most familiar with rectangular data we’ll try to get it into that format as quickly as possible. And then we can use our regular tools to deal with it.</p>
<p>First we want to convert the character vector into a tibble. At this point we may like to add page numbers as well.</p>
<div class="sourceCode" id="cb217"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">jane_eyre</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>raw_text <span class="op">=</span> <span class="va">third_example</span>,
                    page_number <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>We probably now want to separate the lines so that each line is an observation. We can do that by looking for the ‘\n’ remembering that we need to escape the backslash as it’s a special character.</p>
<div class="sourceCode" id="cb218"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">jane_eyre</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate_rows.html">separate_rows</a></span><span class="op">(</span><span class="va">jane_eyre</span>, <span class="va">raw_text</span>, sep <span class="op">=</span> <span class="st">"\\n"</span>, convert <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">jane_eyre</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 × 2</span>
<span class="co">#&gt;   raw_text                                                           page_number</span>
<span class="co">#&gt;   &lt;chr&gt;                                                                    &lt;int&gt;</span>
<span class="co">#&gt; 1 "CHAPTER I"                                                                  1</span>
<span class="co">#&gt; 2 "There was no possibility of taking a walk that day. We had been …           1</span>
<span class="co">#&gt; 3 "leafless shrubbery an hour in the morning; but since dinner (Mrs…           1</span>
<span class="co">#&gt; 4 "company, dined early) the cold winter wind had brought with it c…           1</span>
<span class="co">#&gt; 5 "penetrating, that further out-door exercise was now out of the q…           1</span>
<span class="co">#&gt; 6 ""                                                                           1</span></code></pre></div>
</div>
</div>
<div id="case-study-us-total-fertility-rate-by-state-and-year-2000-2018" class="section level2" number="8.9">
<h2>
<span class="header-section-number">8.9</span> Case-study: US Total Fertility Rate, by state and year (2000-2018)<a class="anchor" aria-label="anchor" href="#case-study-us-total-fertility-rate-by-state-and-year-2000-2018"><i class="fas fa-link"></i></a>
</h2>
<div id="introduction-10" class="section level3" number="8.9.1">
<h3>
<span class="header-section-number">8.9.1</span> Introduction<a class="anchor" aria-label="anchor" href="#introduction-10"><i class="fas fa-link"></i></a>
</h3>
<p>If you’re married to a demographer it is not too long until you are asked to look at a US Department of Health and Human Services Vital Statistics Report. In this case we are interested in trying to get the total fertility rate (the average number of births per woman assuming that woman experience the current age-specific fertility rates throughout their reproductive years)<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;And if you’d like to know more about this then I’d recommend starting a PhD with &lt;a href="https://www.monicaalexander.com/"&gt;Monica Alexander&lt;/a&gt;.&lt;/p&gt;'><sup>4</sup></a> for each state for nineteen years. Annoyingly, the US persists in only making this data available in PDFs, but it makes a nice case study.</p>
<p>In the case of the year 2000 the table that we are interested in is on page 40 of a PDF that is available <a href="https://www.cdc.gov/nchs/data/nvsr/nvsr50/nvsr50_05.pdf" class="uri">https://www.cdc.gov/nchs/data/nvsr/nvsr50/nvsr50_05.pdf</a> and it is the column labelled: “Total fertility rate” (Figure <a href="gather-data.html#fig:dhsexample">8.11</a>).</p>
<div class="figure">
<span style="display:block;" id="fig:dhsexample"></span>
<img src="figures/dhs_example.png" alt="Example Vital Statistics Report, from 2000" width="90%"><p class="caption">
Figure 8.11: Example Vital Statistics Report, from 2000
</p>
</div>
</div>
<div id="begin-with-an-end-in-mind" class="section level3" number="8.9.2">
<h3>
<span class="header-section-number">8.9.2</span> Begin with an end in mind<a class="anchor" aria-label="anchor" href="#begin-with-an-end-in-mind"><i class="fas fa-link"></i></a>
</h3>
<p>The first step when getting data out of a PDF is to sketch out what you eventually want. A PDF typically contains a lot of information, and so it is handy to be very clear about what you need. This helps keep you focused, and prevents scope creep, but it is also helpful when thinking about data checks. Literally write down on paper what you have in mind.</p>
<p>In this case, what is needed is a table with a column for state, year and TFR (Figure <a href="gather-data.html#fig:tfrdesired">8.12</a>).</p>
<div class="figure">
<span style="display:block;" id="fig:tfrdesired"></span>
<img src="figures/tfr_desired.jpeg" alt="Desired output from the PDF" width="90%"><p class="caption">
Figure 8.12: Desired output from the PDF
</p>
</div>
</div>
<div id="start-simple-then-iterate." class="section level3" number="8.9.3">
<h3>
<span class="header-section-number">8.9.3</span> Start simple, then iterate.<a class="anchor" aria-label="anchor" href="#start-simple-then-iterate."><i class="fas fa-link"></i></a>
</h3>
<p>There are 19 different PDFs, and we are interested in a particular column in a particular table in each of them. Unfortunately, there is nothing magical about what is coming. This first step requires working out the link for each, and the page and column name that is of interest. In the end, this looks like this.</p>
<div class="sourceCode" id="cb219"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">monicas_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">"inputs/tfr_tables_info.csv"</span><span class="op">)</span>

<span class="va">monicas_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">page</span>, <span class="va">table</span>, <span class="va">column_name</span>, <span class="va">url</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://gt.rstudio.com/reference/gt.html">gt</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div id="otfzatpnru" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#otfzatpnru .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#otfzatpnru .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#otfzatpnru .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#otfzatpnru .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 6px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#otfzatpnru .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#otfzatpnru .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#otfzatpnru .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#otfzatpnru .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#otfzatpnru .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#otfzatpnru .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#otfzatpnru .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#otfzatpnru .gt_group_heading {
  padding: 8px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

#otfzatpnru .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#otfzatpnru .gt_from_md > :first-child {
  margin-top: 0;
}

#otfzatpnru .gt_from_md > :last-child {
  margin-bottom: 0;
}

#otfzatpnru .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#otfzatpnru .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 12px;
}

#otfzatpnru .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#otfzatpnru .gt_first_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
}

#otfzatpnru .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#otfzatpnru .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#otfzatpnru .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#otfzatpnru .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#otfzatpnru .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#otfzatpnru .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding: 4px;
}

#otfzatpnru .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#otfzatpnru .gt_sourcenote {
  font-size: 90%;
  padding: 4px;
}

#otfzatpnru .gt_left {
  text-align: left;
}

#otfzatpnru .gt_center {
  text-align: center;
}

#otfzatpnru .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#otfzatpnru .gt_font_normal {
  font-weight: normal;
}

#otfzatpnru .gt_font_bold {
  font-weight: bold;
}

#otfzatpnru .gt_font_italic {
  font-style: italic;
}

#otfzatpnru .gt_super {
  font-size: 65%;
}

#otfzatpnru .gt_footnote_marks {
  font-style: italic;
  font-weight: normal;
  font-size: 65%;
}
</style>
<div class="inline-table"><table class="gt_table">
<thead class="gt_col_headings"><tr>
<th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">year</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">page</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">table</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">column_name</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">url</th>
    </tr></thead>
<tbody class="gt_table_body">
<tr>
<td class="gt_row gt_right">2000</td>
<td class="gt_row gt_right">40</td>
<td class="gt_row gt_right">10</td>
<td class="gt_row gt_left">Total fertility rate</td>
<td class="gt_row gt_left">https://www.cdc.gov/nchs/data/nvsr/nvsr50/nvsr50_05.pdf</td>
</tr>
<tr>
<td class="gt_row gt_right">2001</td>
<td class="gt_row gt_right">41</td>
<td class="gt_row gt_right">10</td>
<td class="gt_row gt_left">Total fertility rate</td>
<td class="gt_row gt_left">https://www.cdc.gov/nchs/data/nvsr/nvsr51/nvsr51_02.pdf</td>
</tr>
<tr>
<td class="gt_row gt_right">2002</td>
<td class="gt_row gt_right">46</td>
<td class="gt_row gt_right">10</td>
<td class="gt_row gt_left">Total fertility rate</td>
<td class="gt_row gt_left">https://www.cdc.gov/nchs/data/nvsr/nvsr52/nvsr52_10.pdf</td>
</tr>
<tr>
<td class="gt_row gt_right">2003</td>
<td class="gt_row gt_right">45</td>
<td class="gt_row gt_right">10</td>
<td class="gt_row gt_left">Total fertility rate</td>
<td class="gt_row gt_left">https://www.cdc.gov/nchs/data/nvsr/nvsr54/nvsr54_02.pdf</td>
</tr>
<tr>
<td class="gt_row gt_right">2004</td>
<td class="gt_row gt_right">52</td>
<td class="gt_row gt_right">11</td>
<td class="gt_row gt_left">Total fertility rate</td>
<td class="gt_row gt_left">https://www.cdc.gov/nchs/data/nvsr/nvsr55/nvsr55_01.pdf</td>
</tr>
<tr>
<td class="gt_row gt_right">2005</td>
<td class="gt_row gt_right">52</td>
<td class="gt_row gt_right">11</td>
<td class="gt_row gt_left">Total fertility rate</td>
<td class="gt_row gt_left">https://www.cdc.gov/nchs/data/nvsr/nvsr56/nvsr56_06.pdf</td>
</tr>
<tr>
<td class="gt_row gt_right">2006</td>
<td class="gt_row gt_right">49</td>
<td class="gt_row gt_right">11</td>
<td class="gt_row gt_left">Total fertility rate</td>
<td class="gt_row gt_left">https://www.cdc.gov/nchs/data/nvsr/nvsr57/nvsr57_07.pdf</td>
</tr>
<tr>
<td class="gt_row gt_right">2007</td>
<td class="gt_row gt_right">41</td>
<td class="gt_row gt_right">11</td>
<td class="gt_row gt_left">Total fertility rate</td>
<td class="gt_row gt_left">https://www.cdc.gov/nchs/data/nvsr/nvsr58/nvsr58_24.pdf</td>
</tr>
<tr>
<td class="gt_row gt_right">2008</td>
<td class="gt_row gt_right">43</td>
<td class="gt_row gt_right">12</td>
<td class="gt_row gt_left">Total fertility rate</td>
<td class="gt_row gt_left">https://www.cdc.gov/nchs/data/nvsr/nvsr59/nvsr59_01.pdf</td>
</tr>
<tr>
<td class="gt_row gt_right">2009</td>
<td class="gt_row gt_right">43</td>
<td class="gt_row gt_right">12</td>
<td class="gt_row gt_left">Total fertility rate</td>
<td class="gt_row gt_left">https://www.cdc.gov/nchs/data/nvsr/nvsr60/nvsr60_01.pdf</td>
</tr>
<tr>
<td class="gt_row gt_right">2010</td>
<td class="gt_row gt_right">42</td>
<td class="gt_row gt_right">12</td>
<td class="gt_row gt_left">Total fertility rate</td>
<td class="gt_row gt_left">https://www.cdc.gov/nchs/data/nvsr/nvsr61/nvsr61_01.pdf</td>
</tr>
<tr>
<td class="gt_row gt_right">2011</td>
<td class="gt_row gt_right">40</td>
<td class="gt_row gt_right">12</td>
<td class="gt_row gt_left">Total fertility rate</td>
<td class="gt_row gt_left">https://www.cdc.gov/nchs/data/nvsr/nvsr62/nvsr62_01.pdf</td>
</tr>
<tr>
<td class="gt_row gt_right">2012</td>
<td class="gt_row gt_right">38</td>
<td class="gt_row gt_right">12</td>
<td class="gt_row gt_left">Total fertility rate</td>
<td class="gt_row gt_left">https://www.cdc.gov/nchs/data/nvsr/nvsr62/nvsr62_09.pdf</td>
</tr>
<tr>
<td class="gt_row gt_right">2013</td>
<td class="gt_row gt_right">37</td>
<td class="gt_row gt_right">12</td>
<td class="gt_row gt_left">Total fertility rate</td>
<td class="gt_row gt_left">https://www.cdc.gov/nchs/data/nvsr/nvsr64/nvsr64_01.pdf</td>
</tr>
<tr>
<td class="gt_row gt_right">2014</td>
<td class="gt_row gt_right">38</td>
<td class="gt_row gt_right">12</td>
<td class="gt_row gt_left">Total fertility rate</td>
<td class="gt_row gt_left">https://www.cdc.gov/nchs/data/nvsr/nvsr64/nvsr64_12.pdf</td>
</tr>
<tr>
<td class="gt_row gt_right">2015</td>
<td class="gt_row gt_right">42</td>
<td class="gt_row gt_right">12</td>
<td class="gt_row gt_left">Total fertility rate</td>
<td class="gt_row gt_left">https://www.cdc.gov/nchs/data/nvsr/nvsr66/nvsr66_01.pdf</td>
</tr>
<tr>
<td class="gt_row gt_right">2016</td>
<td class="gt_row gt_right">29</td>
<td class="gt_row gt_right">8</td>
<td class="gt_row gt_left">Total fertility rate</td>
<td class="gt_row gt_left">https://www.cdc.gov/nchs/data/nvsr/nvsr67/nvsr67_01.pdf</td>
</tr>
<tr>
<td class="gt_row gt_right">2016</td>
<td class="gt_row gt_right">30</td>
<td class="gt_row gt_right">8</td>
<td class="gt_row gt_left">Total fertility rate</td>
<td class="gt_row gt_left">https://www.cdc.gov/nchs/data/nvsr/nvsr67/nvsr67_01.pdf</td>
</tr>
<tr>
<td class="gt_row gt_right">2017</td>
<td class="gt_row gt_right">23</td>
<td class="gt_row gt_right">12</td>
<td class="gt_row gt_left">Total fertility rate</td>
<td class="gt_row gt_left">https://www.cdc.gov/nchs/data/nvsr/nvsr67/nvsr67_08-508.pdf</td>
</tr>
<tr>
<td class="gt_row gt_right">2017</td>
<td class="gt_row gt_right">24</td>
<td class="gt_row gt_right">12</td>
<td class="gt_row gt_left">Total fertility rate</td>
<td class="gt_row gt_left">https://www.cdc.gov/nchs/data/nvsr/nvsr67/nvsr67_08-508.pdf</td>
</tr>
<tr>
<td class="gt_row gt_right">2018</td>
<td class="gt_row gt_right">23</td>
<td class="gt_row gt_right">12</td>
<td class="gt_row gt_left">Total fertility rate</td>
<td class="gt_row gt_left">https://www.cdc.gov/nchs/data/nvsr/nvsr68/nvsr68_13-508.pdf</td>
</tr>
</tbody>
</table></div>
</div>
<p>The first step is to get some code that works for one of them. I’ll step through the code in a lot more detail than normal because we’re going to use these pieces a lot.</p>
<p>We will choose the year 2000. We first download the data and save it.</p>
<div class="sourceCode" id="cb220"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/download.file.html">download.file</a></span><span class="op">(</span>url <span class="op">=</span> <span class="va">monicas_data</span><span class="op">$</span><span class="va">url</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, 
              destfile <span class="op">=</span> <span class="st">"inputs/pdfs/dhs/year_2000.pdf"</span><span class="op">)</span></code></pre></div>
<p>We now want to read the PDF in as a character vector.</p>
<div class="sourceCode" id="cb221"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dhs_2000</span> <span class="op">&lt;-</span> <span class="fu">pdftools</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/pdftools/reference/pdftools.html">pdf_text</a></span><span class="op">(</span><span class="st">"inputs/pdfs/dhs/year_2000.pdf"</span><span class="op">)</span></code></pre></div>
<p>Convert it to a tibble, so that we can use familiar verbs on it.</p>
<div class="sourceCode" id="cb222"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dhs_2000</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>raw_data <span class="op">=</span> <span class="va">dhs_2000</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">dhs_2000</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 × 1</span>
<span class="co">#&gt;   raw_data                                                                      </span>
<span class="co">#&gt;   &lt;chr&gt;                                                                         </span>
<span class="co">#&gt; 1 "Volume 50, Number 5                                                         …</span>
<span class="co">#&gt; 2 "2   National Vital Statistics Report, Vol. 50, No. 5, February 12, 2002\n\n\…</span>
<span class="co">#&gt; 3 "                                                                            …</span>
<span class="co">#&gt; 4 "4   National Vital Statistics Report, Vol. 50, No. 5, February 12, 2002\n\n\…</span>
<span class="co">#&gt; 5 "                                                                            …</span>
<span class="co">#&gt; 6 "6   National Vital Statistics Report, Vol. 50, No. 5, February 12, 2002\n\n …</span></code></pre></div>
<p>Grab the page that is of interest (remembering that each page is a element of the character vector, hence a row in the tibble).</p>
<div class="sourceCode" id="cb223"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dhs_2000</span> <span class="op">&lt;-</span> 
  <span class="va">dhs_2000</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="va">monicas_data</span><span class="op">$</span><span class="va">page</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">dhs_2000</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 1 × 1</span>
<span class="co">#&gt;   raw_data                                                                      </span>
<span class="co">#&gt;   &lt;chr&gt;                                                                         </span>
<span class="co">#&gt; 1 "40 National Vital Statistics Report, Vol. 50, No. 5, Revised May 15, 20022\n…</span></code></pre></div>
<p>Now we want to separate the rows.</p>
<div class="sourceCode" id="cb224"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dhs_2000</span> <span class="op">&lt;-</span> 
  <span class="va">dhs_2000</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate_rows.html">separate_rows</a></span><span class="op">(</span><span class="va">raw_data</span>, sep <span class="op">=</span> <span class="st">"\\n"</span>, convert <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">dhs_2000</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 × 1</span>
<span class="co">#&gt;   raw_data                                                                      </span>
<span class="co">#&gt;   &lt;chr&gt;                                                                         </span>
<span class="co">#&gt; 1 "40 National Vital Statistics Report, Vol. 50, No. 5, Revised May 15, 20022"  </span>
<span class="co">#&gt; 2 ""                                                                            </span>
<span class="co">#&gt; 3 "Table 10. Number of births, birth rates, fertility rates, total fertility ra…</span>
<span class="co">#&gt; 4 "United States, each State and territory, 2000"                               </span>
<span class="co">#&gt; 5 "[By place of residence. Birth rates are live births per 1,000 estimated popu…</span>
<span class="co">#&gt; 6 "estimated in each area; total fertility rates are sums of birth rates for 5-…</span></code></pre></div>
<p>Now we are searching for patterns that we can use. (If you have a lot of tables that you are interested in grabbing from PDFs then it may also be worthwhile considering the <code>tabulizer</code> package which is specifically designed for that <span class="citation">(<a href="references-1.html#ref-citetabulizergross" role="doc-biblioref">Leeper 2018</a>)</span>. The issue is that it depends on Java and I always seem to run into trouble when I need to use Java so I avoid it when I can.)</p>
<p>Let’s look at the first ten lines of content.</p>
<div class="sourceCode" id="cb225"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dhs_2000</span><span class="op">[</span><span class="fl">13</span><span class="op">:</span><span class="fl">22</span>,<span class="op">]</span>
<span class="co">#&gt; # A tibble: 10 × 1</span>
<span class="co">#&gt;    raw_data                                                                     </span>
<span class="co">#&gt;    &lt;chr&gt;                                                                        </span>
<span class="co">#&gt;  1 "                                  State                                    …</span>
<span class="co">#&gt;  2 "                                                                           …</span>
<span class="co">#&gt;  3 "                                                                           …</span>
<span class="co">#&gt;  4 ""                                                                           </span>
<span class="co">#&gt;  5 ""                                                                           </span>
<span class="co">#&gt;  6 "United States 1 ......................................................     …</span>
<span class="co">#&gt;  7 ""                                                                           </span>
<span class="co">#&gt;  8 "Alabama ...............................................................    …</span>
<span class="co">#&gt;  9 "Alaska ................................................................... …</span>
<span class="co">#&gt; 10 "Arizona .................................................................  …</span></code></pre></div>
<p>It doesn’t get much better than this:</p>
<ol style="list-style-type: decimal">
<li>We have dots separating the states from the data.</li>
<li>We have a space between each of the columns.</li>
</ol>
<p>So we can now separate this in to separate columns. First we want to match on when there is at least two dots (remembering that the dot is a special character and so needs to be escaped).</p>
<div class="sourceCode" id="cb226"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dhs_2000</span> <span class="op">&lt;-</span> 
  <span class="va">dhs_2000</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate.html">separate</a></span><span class="op">(</span>col <span class="op">=</span> <span class="va">raw_data</span>, 
           into <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"state"</span>, <span class="st">"data"</span><span class="op">)</span>, 
           sep <span class="op">=</span> <span class="st">"\\.{2,}"</span>, 
           remove <span class="op">=</span> <span class="cn">FALSE</span>,
           fill <span class="op">=</span> <span class="st">"right"</span>
           <span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">dhs_2000</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 × 3</span>
<span class="co">#&gt;   raw_data                              state                              data </span>
<span class="co">#&gt;   &lt;chr&gt;                                 &lt;chr&gt;                              &lt;chr&gt;</span>
<span class="co">#&gt; 1 "40 National Vital Statistics Report… "40 National Vital Statistics Rep… &lt;NA&gt; </span>
<span class="co">#&gt; 2 ""                                    ""                                 &lt;NA&gt; </span>
<span class="co">#&gt; 3 "Table 10. Number of births, birth r… "Table 10. Number of births, birt… &lt;NA&gt; </span>
<span class="co">#&gt; 4 "United States, each State and terri… "United States, each State and te… &lt;NA&gt; </span>
<span class="co">#&gt; 5 "[By place of residence. Birth rates… "[By place of residence. Birth ra… &lt;NA&gt; </span>
<span class="co">#&gt; 6 "estimated in each area; total ferti… "estimated in each area; total fe… &lt;NA&gt;</span></code></pre></div>
<p>We get the expected warnings about the top and the bottom as they don’t have multiple dots.</p>
<p>(Another option here is to use the <code><a href="https://docs.ropensci.org/pdftools/reference/pdftools.html">pdf_data()</a></code> function which would allow us to use location rather than delimiters.)</p>
<p>We can now separate the data based on spaces. There is an inconsistent number of spaces, so we first squish any example of more than one space into just one.</p>
<div class="sourceCode" id="cb227"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dhs_2000</span> <span class="op">&lt;-</span> 
  <span class="va">dhs_2000</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_trim.html">str_squish</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate.html">separate</a></span><span class="op">(</span>col <span class="op">=</span> <span class="va">data</span>, 
           into <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"number_of_births"</span>, 
                    <span class="st">"birth_rate"</span>, 
                    <span class="st">"fertility_rate"</span>, 
                    <span class="st">"TFR"</span>, 
                    <span class="st">"teen_births_all"</span>, 
                    <span class="st">"teen_births_15_17"</span>, 
                    <span class="st">"teen_births_18_19"</span><span class="op">)</span>, 
           sep <span class="op">=</span> <span class="st">"\\s"</span>, 
           remove <span class="op">=</span> <span class="cn">FALSE</span>
           <span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">dhs_2000</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 × 10</span>
<span class="co">#&gt;   raw_data      state     data  number_of_births birth_rate fertility_rate TFR  </span>
<span class="co">#&gt;   &lt;chr&gt;         &lt;chr&gt;     &lt;chr&gt; &lt;chr&gt;            &lt;chr&gt;      &lt;chr&gt;          &lt;chr&gt;</span>
<span class="co">#&gt; 1 "40 National… "40 Nati… &lt;NA&gt;  &lt;NA&gt;             &lt;NA&gt;       &lt;NA&gt;           &lt;NA&gt; </span>
<span class="co">#&gt; 2 ""            ""        &lt;NA&gt;  &lt;NA&gt;             &lt;NA&gt;       &lt;NA&gt;           &lt;NA&gt; </span>
<span class="co">#&gt; 3 "Table 10. N… "Table 1… &lt;NA&gt;  &lt;NA&gt;             &lt;NA&gt;       &lt;NA&gt;           &lt;NA&gt; </span>
<span class="co">#&gt; 4 "United Stat… "United … &lt;NA&gt;  &lt;NA&gt;             &lt;NA&gt;       &lt;NA&gt;           &lt;NA&gt; </span>
<span class="co">#&gt; 5 "[By place o… "[By pla… &lt;NA&gt;  &lt;NA&gt;             &lt;NA&gt;       &lt;NA&gt;           &lt;NA&gt; </span>
<span class="co">#&gt; 6 "estimated i… "estimat… &lt;NA&gt;  &lt;NA&gt;             &lt;NA&gt;       &lt;NA&gt;           &lt;NA&gt; </span>
<span class="co">#&gt; # … with 3 more variables: teen_births_all &lt;chr&gt;, teen_births_15_17 &lt;chr&gt;,</span>
<span class="co">#&gt; #   teen_births_18_19 &lt;chr&gt;</span></code></pre></div>
<p>This is all looking fairly great. The only thing left is to clean up.</p>
<div class="sourceCode" id="cb228"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dhs_2000</span> <span class="op">&lt;-</span> 
  <span class="va">dhs_2000</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">TFR</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="fl">13</span><span class="op">:</span><span class="fl">69</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fl">2000</span><span class="op">)</span>

<span class="va">dhs_2000</span>
<span class="co">#&gt; # A tibble: 57 × 3</span>
<span class="co">#&gt;    state                                                            TFR     year</span>
<span class="co">#&gt;    &lt;chr&gt;                                                            &lt;chr&gt;  &lt;dbl&gt;</span>
<span class="co">#&gt;  1 "                                  State                       … &lt;NA&gt;    2000</span>
<span class="co">#&gt;  2 "                                                              … &lt;NA&gt;    2000</span>
<span class="co">#&gt;  3 "                                                              … &lt;NA&gt;    2000</span>
<span class="co">#&gt;  4 ""                                                               &lt;NA&gt;    2000</span>
<span class="co">#&gt;  5 ""                                                               &lt;NA&gt;    2000</span>
<span class="co">#&gt;  6 "United States 1 "                                               2,130…  2000</span>
<span class="co">#&gt;  7 ""                                                               &lt;NA&gt;    2000</span>
<span class="co">#&gt;  8 "Alabama "                                                       2,021…  2000</span>
<span class="co">#&gt;  9 "Alaska "                                                        2,437…  2000</span>
<span class="co">#&gt; 10 "Arizona "                                                       2,652…  2000</span>
<span class="co">#&gt; # … with 47 more rows</span></code></pre></div>
<p>And we’re done for that year. Now we want to take these pieces, put them into a function and then run that function over all 19 years.</p>
</div>
<div id="iterating" class="section level3" number="8.9.4">
<h3>
<span class="header-section-number">8.9.4</span> Iterating<a class="anchor" aria-label="anchor" href="#iterating"><i class="fas fa-link"></i></a>
</h3>
<div id="get-the-pdfs" class="section level4" number="8.9.4.1">
<h4>
<span class="header-section-number">8.9.4.1</span> Get the PDFs<a class="anchor" aria-label="anchor" href="#get-the-pdfs"><i class="fas fa-link"></i></a>
</h4>
<p>The first part is downloading each of the 19 PDFs that we need. We’re going to build on the code that we used before. That code was:</p>
<div class="sourceCode" id="cb229"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/download.file.html">download.file</a></span><span class="op">(</span>url <span class="op">=</span> <span class="va">monicas_data</span><span class="op">$</span><span class="va">url</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, destfile <span class="op">=</span> <span class="st">"inputs/pdfs/dhs/year_2000.pdf"</span><span class="op">)</span></code></pre></div>
<p>To modify this we need:</p>
<ol style="list-style-type: decimal">
<li>To have it iterate through each of the lines in the dataset that contains our CSVs (i.e. where it says 1, we want 1, then 2, then 3, etc.).</li>
<li>Where it has a filename, we need it to iterate through our desired filenames (i.e. year_2000, then year_2001, then year_2002, etc).</li>
<li>We’d like for it to do all of this in a way that is a little robust to errors. For instance, if one of the URLs is wrong or the internet drops out then we’d like it to just move onto the next PDF, and then warn us at the end that it missed one, not to stop. (This doesn’t really matter because it’s only 19 files, but it’s pretty easy to find yourself doing this for thousands of files).</li>
</ol>
<p>We will draw on the <code>purrr</code> package for this <span class="citation"><a href="references-1.html#ref-citepurrr" role="doc-biblioref">Henry and Wickham</a> (<a href="references-1.html#ref-citepurrr" role="doc-biblioref">2020</a>)</span>.</p>
<div class="sourceCode" id="cb230"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://purrr.tidyverse.org">purrr</a></span><span class="op">)</span>
<span class="va">monicas_data</span> <span class="op">&lt;-</span> 
  <span class="va">monicas_data</span> <span class="op"><a href="https://purrr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>pdf_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"inputs/pdfs/dhs/year_"</span>, <span class="va">year</span>, <span class="st">".pdf"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb231"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html">walk2</a></span><span class="op">(</span><span class="va">monicas_data</span><span class="op">$</span><span class="va">url</span>, <span class="va">monicas_data</span><span class="op">$</span><span class="va">pdf_name</span>, <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/safely.html">safely</a></span><span class="op">(</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/utils/download.file.html">download.file</a></span><span class="op">(</span><span class="va">.x</span> , <span class="va">.y</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>What this code does it take the function <code><a href="https://rdrr.io/r/utils/download.file.html">download.file()</a></code> and give it two arguments: <code>.x</code> and <code>.y</code>. The function <code><a href="https://purrr.tidyverse.org/reference/map2.html">walk2()</a></code> then applies that function to the inputs that we give it, in this case the URLs columns is the <code>.x</code> and the pdf_names column is the <code>.y</code>. Finally, the <code><a href="https://purrr.tidyverse.org/reference/safely.html">safely()</a></code> function means that if there are any failures then it just moves onto the next file instead of throwing an error.</p>
<p>We now have each of the PDFs saved and we can move onto getting the data from them.</p>
</div>
<div id="get-data-from-the-pdfs" class="section level4" number="8.9.4.2">
<h4>
<span class="header-section-number">8.9.4.2</span> Get data from the PDFs<a class="anchor" aria-label="anchor" href="#get-data-from-the-pdfs"><i class="fas fa-link"></i></a>
</h4>
<p>Now we need to get the data from the PDFs. As before, we’re going to build on the code that we used before. That code (overly condensed) was:</p>
<div class="sourceCode" id="cb232"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dhs_2000</span> <span class="op">&lt;-</span> <span class="fu">pdftools</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/pdftools/reference/pdftools.html">pdf_text</a></span><span class="op">(</span><span class="st">"inputs/pdfs/dhs/year_2000.pdf"</span><span class="op">)</span>

<span class="va">dhs_2000</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>raw_data <span class="op">=</span> <span class="va">dhs_2000</span><span class="op">)</span> <span class="op"><a href="https://purrr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="va">monicas_data</span><span class="op">$</span><span class="va">page</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://purrr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate_rows.html">separate_rows</a></span><span class="op">(</span><span class="va">raw_data</span>, sep <span class="op">=</span> <span class="st">"\\n"</span>, convert <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="https://purrr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate.html">separate</a></span><span class="op">(</span>col <span class="op">=</span> <span class="va">raw_data</span>, into <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"state"</span>, <span class="st">"data"</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"\\.{2,}"</span>, remove <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="https://purrr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_trim.html">str_squish</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://purrr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate.html">separate</a></span><span class="op">(</span>col <span class="op">=</span> <span class="va">data</span>, 
           into <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"number_of_births"</span>, <span class="st">"birth_rate"</span>, <span class="st">"fertility_rate"</span>, <span class="st">"TFR"</span>, <span class="st">"teen_births_all"</span>, <span class="st">"teen_births_15_17"</span>, <span class="st">"teen_births_18_19"</span><span class="op">)</span>, 
           sep <span class="op">=</span> <span class="st">"\\s"</span>, 
           remove <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="https://purrr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">TFR</span><span class="op">)</span> <span class="op"><a href="https://purrr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="fl">13</span><span class="op">:</span><span class="fl">69</span><span class="op">)</span> <span class="op"><a href="https://purrr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fl">2000</span><span class="op">)</span>

<span class="va">dhs_2000</span></code></pre></div>
<p>There are a bunch of aspects here that have been hardcoded, but the first thing that we want to iterate is the argument to <code><a href="https://docs.ropensci.org/pdftools/reference/pdftools.html">pdf_text()</a></code>, then the number in in <code><a href="https://dplyr.tidyverse.org/reference/slice.html">slice()</a></code> will also need to change (that is doing the work to get only the page that we are interested in).</p>
<p>Two aspects are hardcoded, and these may need to be updated. In particular: 1) The separate only works if each of the tables has the same columns in the same order; and 2) the slice (which restricts the data to just the states) only works in this particular case. Finally, we add the year only at the end, whereas we’d need to bring that up earlier in the process.</p>
<p>We’ll start by writing a function that will go through all the files, grab the data, get the page of interest, and then expand the rows. We’ll then use a function from <code>purrr</code> to apply that function to all of the PDFs and to output a tibble.</p>
<div class="sourceCode" id="cb233"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">get_pdf_convert_to_tibble</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">pdf_name</span>, <span class="va">page</span>, <span class="va">year</span><span class="op">)</span><span class="op">{</span>
  
  <span class="va">dhs_table_of_interest</span> <span class="op">&lt;-</span> 
    <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>raw_data <span class="op">=</span> <span class="fu">pdftools</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/pdftools/reference/pdftools.html">pdf_text</a></span><span class="op">(</span><span class="va">pdf_name</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://purrr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="va">page</span><span class="op">)</span> <span class="op"><a href="https://purrr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate_rows.html">separate_rows</a></span><span class="op">(</span><span class="va">raw_data</span>, sep <span class="op">=</span> <span class="st">"\\n"</span>, convert <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="https://purrr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate.html">separate</a></span><span class="op">(</span>col <span class="op">=</span> <span class="va">raw_data</span>, 
             into <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"state"</span>, <span class="st">"data"</span><span class="op">)</span>, 
             sep <span class="op">=</span> <span class="st">"[�|\\.]\\s+(?=[[:digit:]])"</span>, 
             remove <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="https://purrr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
      data <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_trim.html">str_squish</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>,
      year_of_data <span class="op">=</span> <span class="va">year</span><span class="op">)</span>

  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Done with"</span>, <span class="va">year</span><span class="op">)</span><span class="op">)</span>
  
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">dhs_table_of_interest</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">raw_dhs_data</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html">pmap_dfr</a></span><span class="op">(</span><span class="va">monicas_data</span> <span class="op"><a href="https://purrr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">pdf_name</span>, <span class="va">page</span>, <span class="va">year</span><span class="op">)</span>,
                                <span class="va">get_pdf_convert_to_tibble</span><span class="op">)</span>
<span class="co">#&gt; [1] "Done with 2000"</span>
<span class="co">#&gt; [1] "Done with 2001"</span>
<span class="co">#&gt; [1] "Done with 2002"</span>
<span class="co">#&gt; [1] "Done with 2003"</span>
<span class="co">#&gt; [1] "Done with 2004"</span>
<span class="co">#&gt; [1] "Done with 2005"</span>
<span class="co">#&gt; [1] "Done with 2006"</span>
<span class="co">#&gt; [1] "Done with 2007"</span>
<span class="co">#&gt; [1] "Done with 2008"</span>
<span class="co">#&gt; [1] "Done with 2009"</span>
<span class="co">#&gt; [1] "Done with 2010"</span>
<span class="co">#&gt; [1] "Done with 2011"</span>
<span class="co">#&gt; [1] "Done with 2012"</span>
<span class="co">#&gt; [1] "Done with 2013"</span>
<span class="co">#&gt; [1] "Done with 2014"</span>
<span class="co">#&gt; [1] "Done with 2015"</span>
<span class="co">#&gt; [1] "Done with 2016"</span>
<span class="co">#&gt; [1] "Done with 2016"</span>
<span class="co">#&gt; [1] "Done with 2017"</span>
<span class="co">#&gt; [1] "Done with 2017"</span>
<span class="co">#&gt; [1] "Done with 2018"</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">raw_dhs_data</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 × 4</span>
<span class="co">#&gt;   raw_data                       state                        data  year_of_data</span>
<span class="co">#&gt;   &lt;chr&gt;                          &lt;chr&gt;                        &lt;chr&gt;        &lt;dbl&gt;</span>
<span class="co">#&gt; 1 "40 National Vital Statistics… "40 National Vital Statisti… 50, …         2000</span>
<span class="co">#&gt; 2 ""                             ""                           &lt;NA&gt;          2000</span>
<span class="co">#&gt; 3 "Table 10. Number of births, … "Table 10. Number of births… &lt;NA&gt;          2000</span>
<span class="co">#&gt; 4 "United States, each State an… "United States, each State … &lt;NA&gt;          2000</span>
<span class="co">#&gt; 5 "[By place of residence. Birt… "[By place of residence. Bi… &lt;NA&gt;          2000</span>
<span class="co">#&gt; 6 "estimated in each area; tota… "estimated in each area; to… &lt;NA&gt;          2000</span></code></pre></div>
<p>Now we need to clean up the state names and then filter on them.</p>
<div class="sourceCode" id="cb234"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">states</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Alabama"</span>, <span class="st">"Alaska"</span>, <span class="st">"Arizona"</span>, <span class="st">"Arkansas"</span>, <span class="st">"California"</span>, <span class="st">"Colorado"</span>, 
            <span class="st">"Connecticut"</span>, <span class="st">"Delaware"</span>, <span class="st">"Florida"</span>, <span class="st">"Georgia"</span>, <span class="st">"Hawaii"</span>, <span class="st">"Idaho"</span>, 
            <span class="st">"Illinois"</span>, <span class="st">"Indiana"</span>, <span class="st">"Iowa"</span>, <span class="st">"Kansas"</span>, <span class="st">"Kentucky"</span>, <span class="st">"Louisiana"</span>, 
            <span class="st">"Maine"</span>, <span class="st">"Maryland"</span>, <span class="st">"Massachusetts"</span>, <span class="st">"Michigan"</span>, <span class="st">"Minnesota"</span>, 
            <span class="st">"Mississippi"</span>, <span class="st">"Missouri"</span>, <span class="st">"Montana"</span>, <span class="st">"Nebraska"</span>, <span class="st">"Nevada"</span>, 
            <span class="st">"New Hampshire"</span>, <span class="st">"New Jersey"</span>, <span class="st">"New Mexico"</span>, <span class="st">"New York"</span>, <span class="st">"North Carolina"</span>, 
            <span class="st">"North Dakota"</span>, <span class="st">"Ohio"</span>, <span class="st">"Oklahoma"</span>, <span class="st">"Oregon"</span>, <span class="st">"Pennsylvania"</span>, 
            <span class="st">"Rhode Island"</span>, <span class="st">"South Carolina"</span>, <span class="st">"South Dakota"</span>, <span class="st">"Tennessee"</span>, <span class="st">"Texas"</span>, 
            <span class="st">"Utah"</span>, <span class="st">"Vermont"</span>, <span class="st">"Virginia"</span>, <span class="st">"Washington"</span>, <span class="st">"West Virginia"</span>, <span class="st">"Wisconsin"</span>, 
            <span class="st">"Wyoming"</span>, <span class="st">"District of Columbia"</span><span class="op">)</span>

<span class="va">raw_dhs_data</span> <span class="op">&lt;-</span> 
  <span class="va">raw_dhs_data</span> <span class="op"><a href="https://purrr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>state <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove_all</a></span><span class="op">(</span><span class="va">state</span>, <span class="st">"\\."</span><span class="op">)</span>,
         state <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove_all</a></span><span class="op">(</span><span class="va">state</span>, <span class="st">"�"</span><span class="op">)</span>,
         state <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove_all</a></span><span class="op">(</span><span class="va">state</span>, <span class="st">"\u0008"</span><span class="op">)</span>,
         state <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op">(</span><span class="va">state</span>, <span class="st">"United States 1"</span>, <span class="st">"United States"</span><span class="op">)</span>,
         state <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op">(</span><span class="va">state</span>, <span class="st">"United States1"</span>, <span class="st">"United States"</span><span class="op">)</span>,
         state <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op">(</span><span class="va">state</span>, <span class="st">"United States 2"</span>, <span class="st">"United States"</span><span class="op">)</span>,
         state <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op">(</span><span class="va">state</span>, <span class="st">"United States2"</span>, <span class="st">"United States"</span><span class="op">)</span>,
         state <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op">(</span><span class="va">state</span>, <span class="st">"United States²"</span>, <span class="st">"United States"</span><span class="op">)</span>,
         <span class="op">)</span> <span class="op"><a href="https://purrr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>state <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_trim.html">str_squish</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://purrr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">state</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">states</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">raw_dhs_data</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 × 4</span>
<span class="co">#&gt;   raw_data                              state   data                year_of_data</span>
<span class="co">#&gt;   &lt;chr&gt;                                 &lt;chr&gt;   &lt;chr&gt;                      &lt;dbl&gt;</span>
<span class="co">#&gt; 1 Alabama ............................… Alabama 63,299 14.4 65.0 2…         2000</span>
<span class="co">#&gt; 2 Alaska .............................… Alaska  9,974 16.0 74.6 2,…         2000</span>
<span class="co">#&gt; 3 Arizona ............................… Arizona 85,273 17.5 84.4 2…         2000</span>
<span class="co">#&gt; 4 Arkansas ...........................… Arkans… 37,783 14.7 69.1 2…         2000</span>
<span class="co">#&gt; 5 California .........................… Califo… 531,959 15.8 70.7 …         2000</span>
<span class="co">#&gt; 6 Colorado ...........................… Colora… 65,438 15.8 73.1 2…         2000</span></code></pre></div>
<p>The next step is to separate the data and get the correct column from it. We’re going to separate based on spaces once it is cleaned up.</p>
<div class="sourceCode" id="cb235"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">raw_dhs_data</span> <span class="op">&lt;-</span> 
  <span class="va">raw_dhs_data</span> <span class="op"><a href="https://purrr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove_all</a></span><span class="op">(</span><span class="va">data</span>, <span class="st">"\\*"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://purrr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate.html">separate</a></span><span class="op">(</span><span class="va">data</span>, into <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"col_1"</span>, <span class="st">"col_2"</span>, <span class="st">"col_3"</span>, <span class="st">"col_4"</span>, <span class="st">"col_5"</span>, 
                          <span class="st">"col_6"</span>, <span class="st">"col_7"</span>, <span class="st">"col_8"</span>, <span class="st">"col_9"</span>, <span class="st">"col_10"</span><span class="op">)</span>, 
           sep <span class="op">=</span> <span class="st">" "</span>,
           remove <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">raw_dhs_data</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 × 14</span>
<span class="co">#&gt;   raw_data    state data   col_1 col_2 col_3 col_4 col_5 col_6 col_7 col_8 col_9</span>
<span class="co">#&gt;   &lt;chr&gt;       &lt;chr&gt; &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;</span>
<span class="co">#&gt; 1 Alabama ..… Alab… 63,29… 63,2… 14.4  65.0  2,02… 62.9  37.9  97.3  &lt;NA&gt;  &lt;NA&gt; </span>
<span class="co">#&gt; 2 Alaska ...… Alas… 9,974… 9,974 16.0  74.6  2,43… 42.4  23.6  69.4  &lt;NA&gt;  &lt;NA&gt; </span>
<span class="co">#&gt; 3 Arizona ..… Ariz… 85,27… 85,2… 17.5  84.4  2,65… 69.1  41.1  111.3 &lt;NA&gt;  &lt;NA&gt; </span>
<span class="co">#&gt; 4 Arkansas .… Arka… 37,78… 37,7… 14.7  69.1  2,14… 68.5  36.7  114.1 &lt;NA&gt;  &lt;NA&gt; </span>
<span class="co">#&gt; 5 California… Cali… 531,9… 531,… 15.8  70.7  2,18… 48.5  28.6  75.6  &lt;NA&gt;  &lt;NA&gt; </span>
<span class="co">#&gt; 6 Colorado .… Colo… 65,43… 65,4… 15.8  73.1  2,35… 49.2  28.6  79.8  &lt;NA&gt;  &lt;NA&gt; </span>
<span class="co">#&gt; # … with 2 more variables: col_10 &lt;chr&gt;, year_of_data &lt;dbl&gt;</span></code></pre></div>
<p>We can now grab the correct column.</p>
<div class="sourceCode" id="cb236"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tfr_data</span> <span class="op">&lt;-</span> 
  <span class="va">raw_dhs_data</span> <span class="op"><a href="https://purrr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>TFR <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">year_of_data</span> <span class="op">&lt;</span> <span class="fl">2008</span>, <span class="va">col_4</span>, <span class="va">col_3</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://purrr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">year_of_data</span>, <span class="va">TFR</span><span class="op">)</span> <span class="op"><a href="https://purrr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>year <span class="op">=</span> <span class="va">year_of_data</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">tfr_data</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 × 3</span>
<span class="co">#&gt;   state       year TFR    </span>
<span class="co">#&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;chr&gt;  </span>
<span class="co">#&gt; 1 Alabama     2000 2,021.0</span>
<span class="co">#&gt; 2 Alaska      2000 2,437.0</span>
<span class="co">#&gt; 3 Arizona     2000 2,652.5</span>
<span class="co">#&gt; 4 Arkansas    2000 2,140.0</span>
<span class="co">#&gt; 5 California  2000 2,186.0</span>
<span class="co">#&gt; 6 Colorado    2000 2,356.5</span></code></pre></div>
<p>Finally, we need to convert the case.</p>
<div class="sourceCode" id="cb237"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">tfr_data</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 × 3</span>
<span class="co">#&gt;   state       year TFR    </span>
<span class="co">#&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;chr&gt;  </span>
<span class="co">#&gt; 1 Alabama     2000 2,021.0</span>
<span class="co">#&gt; 2 Alaska      2000 2,437.0</span>
<span class="co">#&gt; 3 Arizona     2000 2,652.5</span>
<span class="co">#&gt; 4 Arkansas    2000 2,140.0</span>
<span class="co">#&gt; 5 California  2000 2,186.0</span>
<span class="co">#&gt; 6 Colorado    2000 2,356.5</span>

<span class="va">tfr_data</span> <span class="op">&lt;-</span> 
  <span class="va">tfr_data</span> <span class="op"><a href="https://purrr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>TFR <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove_all</a></span><span class="op">(</span><span class="va">TFR</span>, <span class="st">","</span><span class="op">)</span>,
         TFR <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">TFR</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">tfr_data</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 × 3</span>
<span class="co">#&gt;   state       year   TFR</span>
<span class="co">#&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co">#&gt; 1 Alabama     2000 2021 </span>
<span class="co">#&gt; 2 Alaska      2000 2437 </span>
<span class="co">#&gt; 3 Arizona     2000 2652.</span>
<span class="co">#&gt; 4 Arkansas    2000 2140 </span>
<span class="co">#&gt; 5 California  2000 2186 </span>
<span class="co">#&gt; 6 Colorado    2000 2356.</span></code></pre></div>
<p>And run some checks.</p>
<div class="sourceCode" id="cb238"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># tfr_data %&gt;% </span>
<span class="co">#   skimr::skim()</span></code></pre></div>
<p>In particular we want for there to be 51 states and for there to be 19 years.</p>
<p>And we’re done.</p>
<div class="sourceCode" id="cb239"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">tfr_data</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 × 3</span>
<span class="co">#&gt;   state       year   TFR</span>
<span class="co">#&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co">#&gt; 1 Alabama     2000 2021 </span>
<span class="co">#&gt; 2 Alaska      2000 2437 </span>
<span class="co">#&gt; 3 Arizona     2000 2652.</span>
<span class="co">#&gt; 4 Arkansas    2000 2140 </span>
<span class="co">#&gt; 5 California  2000 2186 </span>
<span class="co">#&gt; 6 Colorado    2000 2356.</span>

<span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html">write_csv</a></span><span class="op">(</span><span class="va">tfr_data</span>, <span class="st">"outputs/monicas_tfr.csv"</span><span class="op">)</span></code></pre></div>
</div>
</div>
</div>
<div id="semi-structured" class="section level2" number="8.10">
<h2>
<span class="header-section-number">8.10</span> Semi-structured<a class="anchor" aria-label="anchor" href="#semi-structured"><i class="fas fa-link"></i></a>
</h2>
<div id="json-and-xml" class="section level3" number="8.10.1">
<h3>
<span class="header-section-number">8.10.1</span> JSON and XML<a class="anchor" aria-label="anchor" href="#json-and-xml"><i class="fas fa-link"></i></a>
</h3>
</div>
</div>
<div id="optical-character-recognition" class="section level2" number="8.11">
<h2>
<span class="header-section-number">8.11</span> Optical Character Recognition<a class="anchor" aria-label="anchor" href="#optical-character-recognition"><i class="fas fa-link"></i></a>
</h2>
<p>All of the above is predicated on having a PDF that is already ‘digitized.’ But what if it is images? In that case you need to first use Optical Character Recognition (OCR). The go-to package is Tesseract <span class="citation">(<a href="references-1.html#ref-citetesseract" role="doc-biblioref">Ooms 2019c</a>)</span>. This is a R wrapper around the Tesseract open-source OCR engine.</p>
<p>Let’s see an example with a scan from the first page of Jane Eyre (Figure <a href="gather-data.html#fig:janescan">8.13</a>).</p>
<div class="figure">
<span style="display:block;" id="fig:janescan"></span>
<img src="figures/jane_scan.png" alt="Scan of first page of Jane Eyre." width="90%"><p class="caption">
Figure 8.13: Scan of first page of Jane Eyre.
</p>
</div>
<div class="sourceCode" id="cb240"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># install.packages('tesseract')</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/tesseract/">tesseract</a></span><span class="op">)</span>
<span class="va">text</span> <span class="op">&lt;-</span> <span class="fu">tesseract</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/tesseract/reference/ocr.html">ocr</a></span><span class="op">(</span><span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"figures/jane_scan.png"</span><span class="op">)</span>, engine <span class="op">=</span> <span class="fu"><a href="https://docs.ropensci.org/tesseract/reference/tesseract.html">tesseract</a></span><span class="op">(</span><span class="st">"eng"</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="va">text</span><span class="op">)</span>
<span class="co">#&gt; 1 THERE was no possibility of taking a walk that day. We had</span>
<span class="co">#&gt; been wandering, indeed, in the leafless shrubbery an hour in</span>
<span class="co">#&gt; the morning; but since dinner (Mrs Reed, when there was no com-</span>
<span class="co">#&gt; pany, dined early) the cold winter wind had brought with it clouds</span>
<span class="co">#&gt; so sombre, and a rain so penetrating, that further out-door exercise</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; was now out of the question.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; I was glad of it: I never liked long walks, especially on chilly</span>
<span class="co">#&gt; afternoons: dreadful to me was the coming home in the raw twi-</span>
<span class="co">#&gt; light, with nipped fingers and toes, and a heart saddened by the</span>
<span class="co">#&gt; chidings of Bessie, the nurse, and humbled by the consciousness of</span>
<span class="co">#&gt; my physical inferiority to Eliza, John, and Georgiana Reed.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; The said Eliza, John, and Georgiana were now clustered round</span>
<span class="co">#&gt; their mama in the drawing-room: she lay reclined on a sofa by the</span>
<span class="co">#&gt; fireside, and with her darlings about her (for the time neither quar-</span>
<span class="co">#&gt; relling nor crying) looked perfectly happy. Me, she had dispensed</span>
<span class="co">#&gt; from joining the group; saying, ‘She regretted to be under the</span>
<span class="co">#&gt; necessity of keeping me at a distance; but that until she heard from</span>
<span class="co">#&gt; Bessie, and could discover by her own observation that I was</span>
<span class="co">#&gt; endeavouring in good earnest to acquire a more sociable and</span>
<span class="co">#&gt; child-like disposition, a more attractive and sprightly manner—</span>
<span class="co">#&gt; something lighter, franker, more natural as it were—she really</span>
<span class="co">#&gt; must exclude me from privileges intended only for contented,</span>
<span class="co">#&gt; happy, littie children.’</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ‘What does Bessie say I have done?’ I asked.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ‘Jane, I don’t like cavillers or questioners: besides, there is</span>
<span class="co">#&gt; something truly forbidding in a child taking up her elders in that</span>
<span class="co">#&gt; manner. Be seated somewhere; and until you can speak pleasantly,</span>
<span class="co">#&gt; remain silent.’</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; . Bs aT sae] eae</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; i; AN TCM TAN | Beal | Sees</span>
<span class="co">#&gt; a) } ; | i)</span>
<span class="co">#&gt; i i 4 | | A ae | i | eee eek?</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; a an eames yi | bee</span>
<span class="co">#&gt; 1 nea elem | | oe pee</span>
<span class="co">#&gt; i i ae BC i i Hale</span>
<span class="co">#&gt; oul | ec hi</span>
<span class="co">#&gt; pan || i re a al! |</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ase } Oty 2 RIES ORT Sata ariel</span>
<span class="co">#&gt; SEEN BE — =——_</span>
<span class="co">#&gt; 15</span></code></pre></div>
</div>
<div id="text" class="section level2" number="8.12">
<h2>
<span class="header-section-number">8.12</span> Text<a class="anchor" aria-label="anchor" href="#text"><i class="fas fa-link"></i></a>
</h2>
<p><em>Aspects of this section have been previously published.</em></p>
<div id="introduction-11" class="section level3" number="8.12.1">
<h3>
<span class="header-section-number">8.12.1</span> Introduction<a class="anchor" aria-label="anchor" href="#introduction-11"><i class="fas fa-link"></i></a>
</h3>
<p>Text data is all around us, and in many cases is some of the earliest types of data that we are exposed to. Recent increases in computational power, the development of new methods, and the enormous availability of text, means that there has been a great deal of interest in using text as data. Initial methods tend to focus, essentially, on converting text into numbers and then analysing them using traditional methods. More recent methods have begun to take advantage of the structure that is inherent in text, to draw additional meaning. The difference is perhaps akin to a child who can group similar colors, compared with a child who knows what objects are; although both crocodiles and trees are green, and you can do something with that knowledge, you can do more by knowing that a crocodile could eat you, and a tree probably won’t.</p>
<p>In this section we cover a variety of techniques designed to equip you with the basics of using text as data. One of the great things about text data is that it is typically not generated for the purposes of our analysis. That’s great because it removes one of the unobservable variables that we typically have to worry about. The trade-off is that we typically have to do a bunch more work to get it into a form that we can work with.</p>
</div>
<div id="getting-text-data" class="section level3" number="8.12.2">
<h3>
<span class="header-section-number">8.12.2</span> Getting text data<a class="anchor" aria-label="anchor" href="#getting-text-data"><i class="fas fa-link"></i></a>
</h3>
<p>Text as data is an exciting tool to apply. But many guides assume that you already have a nice dataset. Because we’ve focused on workflow in these notes, we know that’s not likely to be true! In this section we will scrape some text from a website. We’ve already seen examples of scraping, but in general those were focused on exploiting tables in the website. Here we’re going to instead focus on paragraphs of text, hence we’ll focus on different html/css tags.</p>
<p>We’re going to us the <code>rvest</code> package to make it easier to scrape data. We’re also going to use the <code>purrr</code> package to apply a function to a bunch of different URLs. For those of you with a little bit of programming, this is an alternative to using a for loop. For those of you with a bit of CS, this is a package that adds functional programming to R.</p>
<div class="sourceCode" id="cb241"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rvest.tidyverse.org/">rvest</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>

<span class="co"># Some websites</span>
<span class="va">address_to_visit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"https://www.rba.gov.au/monetary-policy/rba-board-minutes/2020/2020-03-03.html"</span>,
                    <span class="st">"https://www.rba.gov.au/monetary-policy/rba-board-minutes/2020/2020-02-04.html"</span>,
                    <span class="st">"https://www.rba.gov.au/monetary-policy/rba-board-minutes/2019/2019-12-03.html"</span>,
                    <span class="st">"https://www.rba.gov.au/monetary-policy/rba-board-minutes/2019/2019-11-05.html"</span>,
                    <span class="st">"https://www.rba.gov.au/monetary-policy/rba-board-minutes/2019/2019-10-01.html"</span>,
                    <span class="st">"https://www.rba.gov.au/monetary-policy/rba-board-minutes/2019/2019-09-03.html"</span>
                    <span class="op">)</span>

<span class="co"># Save names</span>
<span class="va">save_name</span> <span class="op">&lt;-</span> <span class="va">address_to_visit</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove</a></span><span class="op">(</span><span class="st">"https://www.rba.gov.au/monetary-policy/rba-board-minutes/"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove</a></span><span class="op">(</span><span class="st">".html"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove</a></span><span class="op">(</span><span class="st">"20[:digit:]{2}/"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_c.html">str_c</a></span><span class="op">(</span><span class="st">"inputs/rba/"</span>, <span class="va">.</span>, <span class="st">".csv"</span><span class="op">)</span></code></pre></div>
<p>Create the function that will visit address_to_visit and save to save_name files.</p>
<div class="sourceCode" id="cb242"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">visit_address_and_save_content</span> <span class="op">&lt;-</span>
  <span class="kw">function</span><span class="op">(</span><span class="va">name_of_address_to_visit</span>,
           <span class="va">name_of_file_to_save_as</span><span class="op">)</span> <span class="op">{</span>
    <span class="co"># The function takes two inputs</span>
    <span class="va">name_of_address_to_visit</span> <span class="op">&lt;-</span> <span class="va">address_to_visit</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
    <span class="va">name_of_file_to_save_as</span> <span class="op">&lt;-</span> <span class="va">save_name</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
    
    <span class="fu"><a href="http://xml2.r-lib.org/reference/read_xml.html">read_html</a></span><span class="op">(</span><span class="va">name_of_address_to_visit</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># Go to the website and read the html</span>
      <span class="fu"><a href="https://rvest.tidyverse.org/reference/rename.html">html_node</a></span><span class="op">(</span><span class="st">"#content"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># Find the content part</span>
      <span class="fu"><a href="https://rvest.tidyverse.org/reference/html_text.html">html_text</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># Extract the text of the content part</span>
      <span class="fu"><a href="https://readr.tidyverse.org/reference/read_lines.html">write_lines</a></span><span class="op">(</span><span class="va">name_of_file_to_save_as</span><span class="op">)</span> <span class="co"># Save as a text file</span>
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Done with"</span>, <span class="va">name_of_address_to_visit</span>, <span class="st">"at"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>  
    <span class="co"># Helpful so that you know progress when running it on all the records</span>
    <span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html">Sys.sleep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">30</span><span class="op">:</span><span class="fl">60</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="co"># Space out each request by somewhere between </span>
    <span class="co"># 30 and 60 seconds each so that we don't overwhelm their server</span>
  <span class="op">}</span>

<span class="co"># If there is an error then ignore it and move to the next one</span>
<span class="va">visit_address_and_save_content</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://purrr.tidyverse.org/reference/safely.html">safely</a></span><span class="op">(</span><span class="va">visit_address_and_save_content</span><span class="op">)</span></code></pre></div>
<p>We now apply that function to our list of URLs.</p>
<div class="sourceCode" id="cb243"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Walk through the addresses and apply the function to each</span>
<span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html">walk2</a></span><span class="op">(</span><span class="va">address_to_visit</span>,
      <span class="va">save_name</span>,
      <span class="op">~</span> <span class="fu">visit_address_and_save_content</span><span class="op">(</span><span class="va">.x</span>, <span class="va">.y</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>The result is a bunch of files with saved text data.</p>
<p>In this case we used scraping, but there are, of course, many ways. We may be able to use APIs, for instance, In the case of the Airbnb dataset that we examined earlier in the notes. If you are lucky then it may simply be that there is a column that contains text data in your dataset.</p>
</div>
<div id="preparing-text-datasets" class="section level3" number="8.12.3">
<h3>
<span class="header-section-number">8.12.3</span> Preparing text datasets<a class="anchor" aria-label="anchor" href="#preparing-text-datasets"><i class="fas fa-link"></i></a>
</h3>
<p><em>This section draws on Sharla Gelfand’s blog post, linked in the required readings.</em></p>
<p>As much as I would like to stick with Australian economics and politics examples, I realise that this is probably only of limited interest to most of you. As such, in this section we will consider a dataset of Sephora reviews. Please read Sharla’s blog post (<a href="https://sharla.party/post/crying-sephora/" class="uri">https://sharla.party/post/crying-sephora/</a>) for another take on this dataset.</p>
<p>In this section we assume that there is some text data that you have gathered. At this point we need to change it into a form that we can work with. For some applications this will be counts of words. For others it may be some variant of this. The dataset that we are going to use is from Sephora, was scraped by <a href="https://twitter.com/crabbage_/">Connie</a> and I originally became aware of it because of <a href="https://sharla.party/post/crying-sephora/">Sharla</a>.</p>
<p>First let’s read in the data.</p>
<div class="sourceCode" id="cb244"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># This code is taken from https://sharla.party/post/crying-sephora/</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://arxiv.org/abs/1403.2805">jsonlite</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/juliasilge/tidytext">tidytext</a></span><span class="op">)</span>

<span class="va">crying</span> <span class="op">&lt;-</span> 
  <span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html">fromJSON</a></span><span class="op">(</span><span class="st">"https://raw.githubusercontent.com/everestpipkin/datagardens/master/students/khanniie/5_newDataSet/crying_dataset.json"</span>,
  simplifyDataFrame <span class="op">=</span> <span class="cn">TRUE</span>
<span class="op">)</span>

<span class="va">crying</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="va">crying</span><span class="op">[[</span><span class="st">"reviews"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">crying</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 × 6</span>
<span class="co">#&gt;   date        product_info$bra… $name $type $url  review_body review_title stars</span>
<span class="co">#&gt;   &lt;chr&gt;       &lt;chr&gt;             &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;       &lt;chr&gt;        &lt;chr&gt;</span>
<span class="co">#&gt; 1 29 Mar 2016 Too Faced         Bett… Masc… http… "Now I can… AWESOME      5 st…</span>
<span class="co">#&gt; 2 29 Sep 2016 Too Faced         Bett… Masc… http… "This hold… if you're s… 5 st…</span>
<span class="co">#&gt; 3 23 May 2017 Too Faced         Bett… Masc… http… "I just bo… Hate it      1 st…</span>
<span class="co">#&gt; 4 15 Aug 2017 Too Faced         Bett… Masc… http… "To start … Nearly perf… 5 st…</span>
<span class="co">#&gt; 5 21 Sep 2016 Too Faced         Bett… Masc… http… "This masc… Amazing!!    5 st…</span>
<span class="co">#&gt; 6 30 May 2016 Too Faced         Bett… Masc… http… "Let's tal… Tricky but … 5 st…</span>
<span class="co">#&gt; # … with 1 more variable: userid &lt;dbl&gt;</span></code></pre></div>
<div class="sourceCode" id="cb245"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">crying</span><span class="op">)</span>
<span class="co">#&gt; [1] "date"         "product_info" "review_body"  "review_title" "stars"       </span>
<span class="co">#&gt; [6] "userid"</span></code></pre></div>
<p>We’ll focus on the <code>review_body</code> variable and the number of stars <code>stars</code> that the reviewer gave. Most of them are 5 stars, so we’ll just focus on whether or not the review is five stars.</p>
<div class="sourceCode" id="cb246"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">crying</span> <span class="op">&lt;-</span> 
  <span class="va">crying</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">review_body</span>, <span class="va">stars</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>stars <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove</a></span><span class="op">(</span><span class="va">stars</span>, <span class="st">" stars?"</span><span class="op">)</span>,  <span class="co"># The question mark at the end means it'l get rid of 'star' and 'stars'.</span>
         stars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">stars</span><span class="op">)</span>
         <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>five_stars <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">stars</span> <span class="op">==</span> <span class="fl">5</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">crying</span><span class="op">$</span><span class="va">stars</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  1  2  3  4  5 </span>
<span class="co">#&gt;  6  2  4 14 79</span></code></pre></div>
<p>In this example we are going to split everything into separate words. When we do this it is just searching for a space, and so what other types of elements are going to be considered ‘words?’</p>
<div class="sourceCode" id="cb247"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">crying_by_words</span> <span class="op">&lt;-</span> 
  <span class="va">crying</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu">tidytext</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tidytext/man/unnest_tokens.html">unnest_tokens</a></span><span class="op">(</span><span class="va">word</span>, <span class="va">review_body</span>, token <span class="op">=</span> <span class="st">"words"</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">crying_by_words</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 × 3</span>
<span class="co">#&gt;   stars five_stars word </span>
<span class="co">#&gt;   &lt;int&gt;      &lt;dbl&gt; &lt;chr&gt;</span>
<span class="co">#&gt; 1     5          1 now  </span>
<span class="co">#&gt; 2     5          1 i    </span>
<span class="co">#&gt; 3     5          1 can  </span>
<span class="co">#&gt; 4     5          1 cry  </span>
<span class="co">#&gt; 5     5          1 all  </span>
<span class="co">#&gt; 6     5          1 i</span></code></pre></div>
<p>We now want to count the number of times each word is used by each of the star classifications.</p>
<div class="sourceCode" id="cb248"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">crying_by_words</span> <span class="op">&lt;-</span> 
  <span class="va">crying_by_words</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">stars</span>, <span class="va">word</span>, sort <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">crying_by_words</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 × 3</span>
<span class="co">#&gt;   stars word      n</span>
<span class="co">#&gt;   &lt;int&gt; &lt;chr&gt; &lt;int&gt;</span>
<span class="co">#&gt; 1     5 i       348</span>
<span class="co">#&gt; 2     5 and     249</span>
<span class="co">#&gt; 3     5 the     239</span>
<span class="co">#&gt; 4     5 it      211</span>
<span class="co">#&gt; 5     5 a       193</span>
<span class="co">#&gt; 6     5 this    178</span>

<span class="va">crying_by_words</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">stars</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 × 3</span>
<span class="co">#&gt;   stars word      n</span>
<span class="co">#&gt;   &lt;int&gt; &lt;chr&gt; &lt;int&gt;</span>
<span class="co">#&gt; 1     1 the      39</span>
<span class="co">#&gt; 2     1 i        24</span>
<span class="co">#&gt; 3     1 and      21</span>
<span class="co">#&gt; 4     1 it       21</span>
<span class="co">#&gt; 5     1 to       19</span>
<span class="co">#&gt; 6     1 my       16</span></code></pre></div>
<p>So you can see that the most popular word for five-star reviews is ‘i,’ and that the most popular word for one star reviews is ‘the.’</p>
<p>At this point, we can use the data to do a whole bunch of different things, but one nice measure to look at is term frequency e.g. in this case how many times is a word used in reviews with a particular star rating. The issue is that there are a lot of words that are commonly used regardless of context. As such, we may also like to look at the inverse document frequency in which we ‘penalise’ words that occur in many particular star ratings. For instance, ‘the’ probably occurs in both one star and five star reviews and so its idf is lower than ‘hate’ which probably only occurs in one star reviews. The term frequency–inverse document frequency (tf-idf) is then the product of these.</p>
<p>We can create this value using the <code><a href="https://rdrr.io/pkg/tidytext/man/bind_tf_idf.html">bind_tf_idf()</a></code> function from the <code>tidytext</code> package, and this will create a bunch of new columns, one for each word and star combination.</p>
<div class="sourceCode" id="cb249"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># This code, and the one in the next block, is from Julia Silge: https://juliasilge.com/blog/sherlock-holmes-stm/</span>
<span class="va">crying_by_words_tf_idf</span> <span class="op">&lt;-</span> 
  <span class="va">crying_by_words</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/pkg/tidytext/man/bind_tf_idf.html">bind_tf_idf</a></span><span class="op">(</span><span class="va">word</span>, <span class="va">stars</span>, <span class="va">n</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="op">-</span><span class="va">tf_idf</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">crying_by_words_tf_idf</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 × 6</span>
<span class="co">#&gt;   stars word              n      tf   idf tf_idf</span>
<span class="co">#&gt;   &lt;int&gt; &lt;chr&gt;         &lt;int&gt;   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;</span>
<span class="co">#&gt; 1     2 below             1 0.00826  1.61 0.0133</span>
<span class="co">#&gt; 2     2 boy               1 0.00826  1.61 0.0133</span>
<span class="co">#&gt; 3     2 choice            1 0.00826  1.61 0.0133</span>
<span class="co">#&gt; 4     2 contrary          1 0.00826  1.61 0.0133</span>
<span class="co">#&gt; 5     2 exceptionally     1 0.00826  1.61 0.0133</span>
<span class="co">#&gt; 6     2 migrates          1 0.00826  1.61 0.0133</span></code></pre></div>
<div class="sourceCode" id="cb250"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">crying_by_words_tf_idf</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">stars</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/top_n.html">top_n</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="va">ungroup</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>word <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/tidytext/man/reorder_within.html">reorder_within</a></span><span class="op">(</span><span class="va">word</span>, <span class="va">tf_idf</span>, <span class="va">stars</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>stars <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/as_factor.html">as_factor</a></span><span class="op">(</span><span class="va">stars</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">stars</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">word</span>, <span class="va">tf_idf</span>, fill <span class="op">=</span> <span class="va">stars</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_col</a></span><span class="op">(</span>show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html">vars</a></span><span class="op">(</span><span class="va">stars</span><span class="op">)</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://rdrr.io/pkg/tidytext/man/reorder_within.html">scale_x_reordered</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Word"</span>, 
         y <span class="op">=</span> <span class="st">"tf-idf"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_fill_brewer</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Set1"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="20-gather_files/figure-html/unnamed-chunk-71-1.png" width="672"></div>
</div>
</div>
<div id="exercises-and-tutorial-7" class="section level2" number="8.13">
<h2>
<span class="header-section-number">8.13</span> Exercises and tutorial<a class="anchor" aria-label="anchor" href="#exercises-and-tutorial-7"><i class="fas fa-link"></i></a>
</h2>
<div id="exercises-7" class="section level3" number="8.13.1">
<h3>
<span class="header-section-number">8.13.1</span> Exercises<a class="anchor" aria-label="anchor" href="#exercises-7"><i class="fas fa-link"></i></a>
</h3>
<ol style="list-style-type: decimal">
<li>In your own words, what is an API (write a paragraph or two)?</li>
<li>Find two APIs and discuss how you could use them to tell interesting stories (write a paragraph or two for each).</li>
<li>Find two APIs that have an R packages written around them. How could you use these to tell interesting stories? (Write a paragraph or two for each.)</li>
<li>What is the main argument to <code><a href="https://httr.r-lib.org/reference/GET.html">httr::GET()</a></code> (pick one)?
<ol style="list-style-type: lower-alpha">
<li>‘url’</li>
<li>‘website’</li>
<li>‘domain’</li>
<li>‘location’</li>
</ol>
</li>
<li>Name three reasons why we should be respectful when getting scraping data from websites (write a paragraph or two).</li>
<li>What features of a website do we typically take advantage of when we parse the code (select all)?
<ol style="list-style-type: lower-alpha">
<li>HTML/CSS mark-up.</li>
<li>Cookies.</li>
<li>Facebook beacons.</li>
<li>Code comments.</li>
</ol>
</li>
<li>What are three advantages and three disadvantages of scraping compared with using an API (write a paragraph or two)?</li>
<li>What are three delimiters that could be useful when trying to bring order to the PDF that you read in as a character vector (write a paragraph or two)?</li>
<li>What do I need to put inside “SOMETHING_HERE” if I want to match regular expressions for a full stop i.e. “.” (hint: see the ‘strings’ cheat sheet) (pick one)?
<ol style="list-style-type: lower-alpha">
<li><code>.</code></li>
<li><code>\.</code></li>
<li><code>\\.</code></li>
<li><code>\\\.</code></li>
</ol>
</li>
<li>Name three reasons for sketching out what you want before starting to try to extract data from a PDF (write a paragraph or two for each).</li>
<li>If you are interested in demographic data then what are three checks that you might like to do? What are three if you are interested in economic data such as GDP, interest rates, and exchange rates? (Write an explanation for each.)</li>
<li>What does the <code>purrr</code> package do (select all)?
<ol style="list-style-type: lower-alpha">
<li>Enhances R’s functional programming toolkit.</li>
<li>Makes loops easier to code and read.</li>
<li>Checks the consistency of datasets.</li>
<li>Identifies issues in data structures and proposes replacements.</li>
</ol>
</li>
<li>Which of these are functions from the <code>purrr</code> package (select all)?
<ol style="list-style-type: lower-alpha">
<li><code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code></li>
<li><code><a href="https://purrr.tidyverse.org/reference/map.html">walk()</a></code></li>
<li><code>run()</code></li>
<li><code><a href="https://purrr.tidyverse.org/reference/safely.html">safely()</a></code></li>
</ol>
</li>
<li>Why should we use <code><a href="https://purrr.tidyverse.org/reference/safely.html">safely()</a></code> when scraping data (pick one)?
<ol style="list-style-type: lower-alpha">
<li>To protect us from hackers.</li>
<li>To avoid side effects of pages with issues.</li>
<li>To slow down our scraping to an appropriate speed.</li>
</ol>
</li>
<li>What are some principles to follow when scraping (select all)?
<ol style="list-style-type: lower-alpha">
<li>Avoid it if possible</li>
<li>Follow the site’s guidance</li>
<li>Slow down</li>
<li>Use a scalpel not an axe.<br>
</li>
</ol>
</li>
<li>What is a robots.txt file (pick one)?
<ol style="list-style-type: lower-alpha">
<li>The instructions that Frankenstein followed.</li>
<li>Notes that web scrapers should follow when scraping.</li>
</ol>
</li>
<li>What is the html tag for an item in list (pick one)?
<ol style="list-style-type: lower-alpha">
<li><code>li</code></li>
<li><code>body</code></li>
<li><code>b</code></li>
<li><code>em</code></li>
</ol>
</li>
<li>If I have the following text data ‘rohan_alexander’ in a column called ‘names’ and want to split it into first name and surname based on the underbar what function should I use (pick one)?
<ol style="list-style-type: lower-alpha">
<li><code><a href="https://tidyr.tidyverse.org/reference/separate.html">separate()</a></code></li>
<li><code><a href="https://dplyr.tidyverse.org/reference/slice.html">slice()</a></code></li>
<li><code>spacing()</code></li>
<li><code>text_to_columns()</code></li>
</ol>
</li>
</ol>
</div>
<div id="tutorial-7" class="section level3" number="8.13.2">
<h3>
<span class="header-section-number">8.13.2</span> Tutorial<a class="anchor" aria-label="anchor" href="#tutorial-7"><i class="fas fa-link"></i></a>
</h3>
<p>Gather some data yourself using a method that is introduced here - APIs directly or via a wrapper package, web scraping, PDF parsing, OCR, or text. Write a few paragraphs about the data source, what you gathered, and how you went about it. What took longer than you expected? When did it become fun? What would you do differently next time you do this? Please include a link to your GitHub repo so I can see the code, but it won’t be strictly marked - this is more about encouraging you to have a go. (Start with something tiny and very specific, get that working, and then increase the scope - almost everything will be more difficult and time-consuming than you think - and don’t forget to plan it out before you start.)</p>

</div>
</div>
</div>

  <div class="chapter-nav">
<div class="prev"><a href="interactive-communication.html"><span class="header-section-number">7</span> Interactive communication</a></div>
<div class="next"><a href="hunt-data.html"><span class="header-section-number">9</span> Hunt data</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#gather-data"><span class="header-section-number">8</span> Gather data</a></li>
<li><a class="nav-link" href="#apis"><span class="header-section-number">8.1</span> APIs</a></li>
<li><a class="nav-link" href="#case-study---arxiv"><span class="header-section-number">8.2</span> Case study - arXiv</a></li>
<li><a class="nav-link" href="#case-study---rtweet"><span class="header-section-number">8.3</span> Case study - rtweet</a></li>
<li><a class="nav-link" href="#case-study---spotifyr"><span class="header-section-number">8.4</span> Case study - spotifyr</a></li>
<li>
<a class="nav-link" href="#scraping"><span class="header-section-number">8.5</span> Scraping</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#introduction-6"><span class="header-section-number">8.5.1</span> Introduction</a></li>
<li><a class="nav-link" href="#getting-started-2"><span class="header-section-number">8.5.2</span> Getting started</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#case-study---rohans-books"><span class="header-section-number">8.6</span> Case study - Rohan’s books</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#introduction-7"><span class="header-section-number">8.6.1</span> Introduction</a></li>
<li><a class="nav-link" href="#gather"><span class="header-section-number">8.6.2</span> Gather</a></li>
<li><a class="nav-link" href="#clean"><span class="header-section-number">8.6.3</span> Clean</a></li>
<li><a class="nav-link" href="#explore-3"><span class="header-section-number">8.6.4</span> Explore</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#case-study---canadian-prime-ministers"><span class="header-section-number">8.7</span> Case study - Canadian Prime Ministers</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#introduction-8"><span class="header-section-number">8.7.1</span> Introduction</a></li>
<li><a class="nav-link" href="#gather-1"><span class="header-section-number">8.7.2</span> Gather</a></li>
<li><a class="nav-link" href="#clean-1"><span class="header-section-number">8.7.3</span> Clean</a></li>
<li><a class="nav-link" href="#explore-4"><span class="header-section-number">8.7.4</span> Explore</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#pdfs"><span class="header-section-number">8.8</span> PDFs</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#introduction-9"><span class="header-section-number">8.8.1</span> Introduction</a></li>
<li><a class="nav-link" href="#getting-started-3"><span class="header-section-number">8.8.2</span> Getting started</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#case-study-us-total-fertility-rate-by-state-and-year-2000-2018"><span class="header-section-number">8.9</span> Case-study: US Total Fertility Rate, by state and year (2000-2018)</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#introduction-10"><span class="header-section-number">8.9.1</span> Introduction</a></li>
<li><a class="nav-link" href="#begin-with-an-end-in-mind"><span class="header-section-number">8.9.2</span> Begin with an end in mind</a></li>
<li><a class="nav-link" href="#start-simple-then-iterate."><span class="header-section-number">8.9.3</span> Start simple, then iterate.</a></li>
<li><a class="nav-link" href="#iterating"><span class="header-section-number">8.9.4</span> Iterating</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#semi-structured"><span class="header-section-number">8.10</span> Semi-structured</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#json-and-xml"><span class="header-section-number">8.10.1</span> JSON and XML</a></li></ul>
</li>
<li><a class="nav-link" href="#optical-character-recognition"><span class="header-section-number">8.11</span> Optical Character Recognition</a></li>
<li>
<a class="nav-link" href="#text"><span class="header-section-number">8.12</span> Text</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#introduction-11"><span class="header-section-number">8.12.1</span> Introduction</a></li>
<li><a class="nav-link" href="#getting-text-data"><span class="header-section-number">8.12.2</span> Getting text data</a></li>
<li><a class="nav-link" href="#preparing-text-datasets"><span class="header-section-number">8.12.3</span> Preparing text datasets</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#exercises-and-tutorial-7"><span class="header-section-number">8.13</span> Exercises and tutorial</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#exercises-7"><span class="header-section-number">8.13.1</span> Exercises</a></li>
<li><a class="nav-link" href="#tutorial-7"><span class="header-section-number">8.13.2</span> Tutorial</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/rstudio/bookdown-demo/blob/master/20-gather.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/rstudio/bookdown-demo/edit/master/20-gather.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Telling Stories With Data</strong>" was written by Rohan Alexander. It was last built on 02 January, 2022.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
