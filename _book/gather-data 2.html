<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 9 Gather data | Telling Stories With Data</title>
<meta name="author" content="Rohan Alexander">
<meta name="description" content="Required material Read Turning History into Data: Data Collection, Measurement, and Inference in HPE, (Cirone and Spirling 2021). Read Two Regimes of Prison Data Collection, (K. R. Johnson 2021)....">
<meta name="generator" content="bookdown 0.24 with bs4_book()">
<meta property="og:title" content="Chapter 9 Gather data | Telling Stories With Data">
<meta property="og:type" content="book">
<meta property="og:image" content="/tellingstorieswithdatapainting.png">
<meta property="og:description" content="Required material Read Turning History into Data: Data Collection, Measurement, and Inference in HPE, (Cirone and Spirling 2021). Read Two Regimes of Prison Data Collection, (K. R. Johnson 2021)....">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 9 Gather data | Telling Stories With Data">
<meta name="twitter:description" content="Required material Read Turning History into Data: Data Collection, Measurement, and Inference in HPE, (Cirone and Spirling 2021). Read Two Regimes of Prison Data Collection, (K. R. Johnson 2021)....">
<meta name="twitter:image" content="/tellingstorieswithdatapainting.png">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.11/header-attrs.js"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><link href="libs/_Atkinson%20Hyperlegible-0.4.0/font.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=IBM%20Plex%20Mono&amp;display=swap" rel="stylesheet">
<script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script><link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet">
<script src="libs/leaflet-1.3.1/leaflet.js"></script><link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet">
<script src="libs/proj4-2.6.2/proj4.min.js"></script><script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script><link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet">
<script src="libs/leaflet-binding-2.0.4.1/leaflet.js"></script><script src="libs/mapdeck-binding-0.3.4/mapdeck.js"></script><script src="libs/mpadeck_functions-0.0.1/mapdeck_functions.js"></script><script src="libs/deckgl-8.1.6/deckgl.min.js"></script><script src="libs/legend-0.0.1/legend.js"></script><script src="libs/title-0.0.1/title.js"></script><script src="libs/mapdeck_location-0.0.1/mapdeck_location.js"></script><script src="libs/mapdeck_colours-0.0.1/mapdeck_colours.js"></script><script src="libs/mapdeck_coordinates-0.0.1/mapdeck_coordinates.js"></script><link href="libs/mapboxgl-1.10.0/mapbox-gl.css" rel="stylesheet">
<script src="libs/mapboxgl-1.10.0/mapbox-gl.js"></script><link href="libs/mapdeck-0.0.1/mapdeck.css" rel="stylesheet">
<script src="libs/mpadeck-binding-0.3.4/mapdeck.js"></script><script src="libs/scatterplot-1.0.0/scatterplot.js"></script><script src="libs/viz-1.8.2/viz.js"></script><link href="libs/DiagrammeR-styles-0.2/styles.css" rel="stylesheet">
<script src="libs/grViz-binding-1.0.6.1/grViz.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><link rel="stylesheet" href="bs4_style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Telling Stories With Data</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Preface</a></li>
<li><a class="" href="about-the-author.html">About the author</a></li>
<li class="book-part">Foundations</li>
<li><a class="" href="telling-stories-with-data.html"><span class="header-section-number">1</span> Telling stories with data</a></li>
<li><a class="" href="drinking-from-a-fire-hose.html"><span class="header-section-number">2</span> Drinking from a fire hose</a></li>
<li><a class="" href="r-essentials.html"><span class="header-section-number">3</span> R essentials</a></li>
<li><a class="" href="reproducible-workflows.html"><span class="header-section-number">4</span> Reproducible workflows</a></li>
<li class="book-part">Communication</li>
<li><a class="" href="on-writing.html"><span class="header-section-number">5</span> On writing</a></li>
<li><a class="" href="static-communication.html"><span class="header-section-number">6</span> Static communication</a></li>
<li><a class="" href="interactive-communication.html"><span class="header-section-number">7</span> Interactive communication</a></li>
<li class="book-part">Acquisition</li>
<li><a class="" href="farm-data.html"><span class="header-section-number">8</span> Farm data</a></li>
<li><a class="active" href="gather-data.html"><span class="header-section-number">9</span> Gather data</a></li>
<li><a class="" href="hunt-data.html"><span class="header-section-number">10</span> Hunt data</a></li>
<li class="book-part">Preparation</li>
<li><a class="" href="clean-and-prepare.html"><span class="header-section-number">11</span> Clean and prepare</a></li>
<li><a class="" href="store-and-share.html"><span class="header-section-number">12</span> Store and share</a></li>
<li class="book-part">Modelling</li>
<li><a class="" href="exploratory-data-analysis.html"><span class="header-section-number">13</span> Exploratory data analysis</a></li>
<li><a class="" href="ijalm.html"><span class="header-section-number">14</span> It’s Just A Linear Model</a></li>
<li><a class="" href="causality.html"><span class="header-section-number">15</span> Causality from observational data</a></li>
<li><a class="" href="mrp.html"><span class="header-section-number">16</span> Multilevel regression with post-stratification</a></li>
<li><a class="" href="text-as-data.html"><span class="header-section-number">17</span> Text as data</a></li>
<li class="book-part">Enrichment</li>
<li><a class="" href="deploying-models.html"><span class="header-section-number">18</span> Deploying models</a></li>
<li><a class="" href="efficiency.html"><span class="header-section-number">19</span> Efficiency</a></li>
<li><a class="" href="concludingremarks.html"><span class="header-section-number">20</span> Concluding remarks</a></li>
<li class="book-part">Appendix</li>
<li><a class="" href="oh-you-think-and-shoulders-and-datasets.html"><span class="header-section-number">A</span> Oh you think and shoulders and datasets</a></li>
<li><a class="" href="papers.html"><span class="header-section-number">B</span> Papers</a></li>
<li><a class="" href="cocktails.html"><span class="header-section-number">C</span> Cocktails</a></li>
<li><a class="" href="references-1.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/rstudio/bookdown-demo">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="gather-data" class="section level1" number="9">
<h1>
<span class="header-section-number">9</span> Gather data<a class="anchor" aria-label="anchor" href="#gather-data"><i class="fas fa-link"></i></a>
</h1>
<p><strong>Required material</strong></p>
<ul>
<li>Read <em>Turning History into Data: Data Collection, Measurement, and Inference in HPE</em>, <span class="citation">(<a href="references-1.html#ref-cirone" role="doc-biblioref">Cirone and Spirling 2021</a>)</span>.</li>
<li>Read <em>Two Regimes of Prison Data Collection</em>, <span class="citation">(<a href="references-1.html#ref-Johnson2021Two" role="doc-biblioref">K. R. Johnson 2021</a>)</span>.</li>
</ul>
<!-- - Cardoso, Tom, 2019, 'Introduction to scraping', https://github.com/tomcardoso/intro-to-scraping. --><!-- - Clavelle, Tyler, 2017, 'Using R to extract data from web APIs', 5 June, https://www.tylerclavelle.com/code/2017/randapis/. --><!-- - Cooksey, Brian, 2014, 'An Introduction to APIs', Zapier, 22 April, https://zapier.com/learn/apis/. --><!-- - Dogucu, Mine, and Mine Çetinkaya-Runde, 2020 ,'Web Scraping in the Statistics and Data Science Curriculum: Challenges and Opportunities', 6 May. --><!-- - Gelfand, Sharla, 2019, 'Crying @ Sephora', 8 November, https://sharla.party/post/crying-sephora/. --><!-- - Goldman, Shayna, 2019, 'How Much Do NHL Players Really Make? Part 2: Taxes', https://hockey-graphs.com/2019/01/08/how-much-do-nhl-players-really-make-part-2-taxes/. --><!-- - Graham, Shawn, 2019, 'Scraping with rvest', 7 November, https://electricarchaeology.ca/2019/11/07/scraping-with-rvest/. --><!-- - Henze, Martin, 2020, 'Web Scraping with rvest + Astro Throwback', 23 January, https://heads0rtai1s.github.io/2020/01/23/rvest-intro-astro/. --><!-- - Hudon, Caitlin, 2017, ''Blue Christmas: A data-driven search for the most depressing Christmas song', 22 December, https://caitlinhudon.com/2017/12/22/blue-christmas/. --><!-- - Luscombe, Alex, 2020, 'A Gentle Introduction to Tesseract OCR', 3 June, https://alexluscombe.ca/post/ocr-tutorial/. --><!-- - Luscombe, Alex, 2020, 'Getting your .pdfs into R', 5 August, https://alexluscombe.ca/post/r-pdftools/. --><!-- - Luscombe, Alex, 2020, 'Parsing your .pdfs in R', 10 August, https://alexluscombe.ca/post/parsing-pdfs/. --><!-- - Marshall, James, 'HTML Made Really Easy', https://www.jmarshall.com/easy/html/. --><!-- - Marshall, James, 'HTTP Made Really Easy', https://www.jmarshall.com/easy/http/. --><!-- - Nakagawara, Ryo, 2020, 'Intro to {polite} Web Scraping of Soccer Data with R!', 14 May, https://ryo-n7.github.io/2020-05-14-webscrape-soccer-data-with-R/. --><!-- - Pavlik, Kaylin, 2020, 'How do fiber types appear together in yarn blends?', 17 February, https://www.kaylinpavlik.com/ravelry-yarn-fibers/. --><!-- - Silge, Julia and David Robinson, 2020, *Text Mining with R*, Chapters 1, 3, and 6, https://www.tidytextmining.com/. --><!-- - Silge, Julia, 2017, 'Scraping CRAN with rvest', 5 March, https://juliasilge.com/blog/scraping-cran/. --><!-- - Wickham, Hadley, 'Managing Secrets', https://cran.r-project.org/web/packages/httr/vignettes/secrets.html. --><!-- - Wickham, Hadley, 2014, 'rvest: easy web scraping with R', 24 November, https://blog.rstudio.com/2014/11/24/rvest-easy-web-scraping-with-r/. --><!-- - Wickham, Hadley, nd, 'Getting started with httr', https://cran.r-project.org/web/packages/httr/vignettes/quickstart.html. --><!-- - D'Agostino McGowan, Lucy, 2020 'Harnessing the Power of the Web via R Clients for Web APIs', talk at ASA Joint Statistical Meeting 2018, https://www.lucymcgowan.com/talk/asa_joint_statistical_meeting_2018/. --><!-- - Tatman, Rachel, 2018, 'Character Encoding and You', 21 February, https://youtu.be/2U9EHYqc59Y. --><p><strong>Key concepts and skills</strong></p>
<ul>
<li>Initial usage of APIs, both directly, including dealing with semi-structured data, and indirectly through R Packages.</li>
<li>Use R environments to manage keys.</li>
<li>Web scraping, especially reasonable use and ethical concerns.</li>
<li>Cleaning data from unstructured data to structured, tidy, data.</li>
<li>Extracting data from PDFs, both those that are able to be parsed and those that are an image and require OCR.</li>
</ul>
<p><strong>Key libraries</strong></p>
<ul>
<li>
<code>babynames</code> <span class="citation">(<a href="references-1.html#ref-citebabynames" role="doc-biblioref">Wickham 2019b</a>)</span>
</li>
<li>
<code>httr</code> <span class="citation">(<a href="references-1.html#ref-citehttr" role="doc-biblioref">Wickham 2019c</a>)</span>
</li>
<li>
<code>jsonlite</code> <span class="citation">(<a href="references-1.html#ref-jsonlite" role="doc-biblioref">Ooms 2014</a>)</span>
</li>
<li>
<code>lubridate</code> <span class="citation">(<a href="references-1.html#ref-GrolemundWickham2011" role="doc-biblioref">Grolemund and Wickham 2011</a>)</span>
</li>
<li>
<code>pdftools</code> <span class="citation">(<a href="references-1.html#ref-Ooms2018pdftools" role="doc-biblioref">Ooms 2018a</a>)</span>
</li>
<li>
<code>purrr</code> <span class="citation">(<a href="references-1.html#ref-citepurrr" role="doc-biblioref">Henry and Wickham 2020</a>)</span>
</li>
<li>
<code>rtweet</code> <span class="citation">(<a href="references-1.html#ref-rtweet" role="doc-biblioref">Kearney 2019</a>)</span>
</li>
<li>
<code>rvest</code> <span class="citation">(<a href="references-1.html#ref-citervest" role="doc-biblioref">Wickham 2019d</a>)</span>
</li>
<li>
<code>spotifyr</code> <span class="citation">(<a href="references-1.html#ref-spotifyr" role="doc-biblioref">Thompson et al. 2020</a>)</span>
</li>
<li>
<code>tesseract</code> <span class="citation">(<a href="references-1.html#ref-Ooms2018tesseract" role="doc-biblioref">Ooms 2018b</a>)</span>
</li>
<li>
<code>tidyverse</code> <span class="citation">(<a href="references-1.html#ref-citetidyverse" role="doc-biblioref">Wickham et al. 2019a</a>)</span>
</li>
<li>
<code>usethis</code> <span class="citation">(<a href="references-1.html#ref-citeusethis" role="doc-biblioref">Wickham and Bryan 2020</a>)</span>
</li>
<li>
<code>xml2</code> <span class="citation">(<a href="references-1.html#ref-xml2" role="doc-biblioref">Wickham, Hester, and Ooms 2021</a>)</span>
</li>
</ul>
<p><strong>Key functions</strong></p>
<ul>
<li><code><a href="https://rdrr.io/r/utils/download.file.html">download.file()</a></code></li>
<li><code><a href="https://rdrr.io/r/base/factor.html">factor()</a></code></li>
<li><code>function()</code></li>
<li><code><a href="https://httr.r-lib.org/reference/GET.html">httr::GET()</a></code></li>
<li><code><a href="https://docs.ropensci.org/pdftools/reference/pdftools.html">pdftools::pdf_text()</a></code></li>
<li><code><a href="https://purrr.tidyverse.org/reference/map2.html">purrr::walk2()</a></code></li>
<li><code><a href="https://rdrr.io/pkg/rtweet/man/get_favorites.html">rtweet::get_favorites()</a></code></li>
<li><code><a href="https://rdrr.io/pkg/rtweet/man/get_friends.html">rtweet::get_friends()</a></code></li>
<li><code><a href="https://rdrr.io/pkg/rtweet/man/get_timeline.html">rtweet::get_timelines()</a></code></li>
<li><code><a href="https://rdrr.io/pkg/rtweet/man/search_tweets.html">rtweet::search_tweets()</a></code></li>
<li><code><a href="https://rvest.tidyverse.org/reference/rename.html">rvest::html_nodes()</a></code></li>
<li><code><a href="https://rvest.tidyverse.org/reference/html_text.html">rvest::html_text()</a></code></li>
<li><code><a href="https://rdrr.io/r/base/Random.html">set.seed()</a></code></li>
<li><code><a href="https://rdrr.io/pkg/spotifyr/man/get_artist_audio_features.html">spotifyr::get_artist_audio_features()</a></code></li>
<li><code>sys.sleep()</code></li>
<li><code><a href="https://docs.ropensci.org/tesseract/reference/ocr.html">tesseract::ocr()</a></code></li>
<li><code><a href="https://usethis.r-lib.org/reference/edit.html">usethis::edit_r_environ()</a></code></li>
</ul>
<div id="introduction-6" class="section level2" number="9.1">
<h2>
<span class="header-section-number">9.1</span> Introduction<a class="anchor" aria-label="anchor" href="#introduction-6"><i class="fas fa-link"></i></a>
</h2>
<p>In this chapter we first
go through a variety of approaches for gathering data, including the use of APIs and semi-structured data, such as JSON and XML, web scraping, converting PDFs,
and using optical character recognition, especially to obtain text data.</p>
</div>
<div id="apis" class="section level2" number="9.2">
<h2>
<span class="header-section-number">9.2</span> APIs<a class="anchor" aria-label="anchor" href="#apis"><i class="fas fa-link"></i></a>
</h2>
<p>In everyday language, and for our purposes, an Application Programming Interface (API) is a situation in which someone has set up specific files on their computer such that we can follow their instructions to get them. For instance, when we use a gif on Slack, Slack asks Giphy’s server for the appropriate gif, Giphy’s server gives that gif to Slack and then Slack inserts it into your chat. The way in which Slack and Giphy interact is determined by Giphy’s API. More strictly, an API is just an application that runs on a server that we access using the HTTP protocol.</p>
<p>We focus on using APIs for gathering data. And so, with that focus, an API is a website that is set-up for another computer to be able to access, rather than a person. For instance, we could go to Google Maps: <a href="https://www.google.com/maps" class="uri">https://www.google.com/maps</a>. And we could then scroll and click and drag to center the map on Canberra, Australia. Or we could paste this into the browser: <a href="https://www.google.com/maps/@-35.2812958,149.1248113,16z" class="uri">https://www.google.com/maps/@-35.2812958,149.1248113,16z</a>. We just used the Google Maps API, and the result should be a map similar to Figure <a href="gather-data.html#fig:focuson2020">9.1</a>.</p>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:focuson2020"></span>
<img src="figures/googlemaps.png" alt="Example of Google Maps, as at 29 January 2022" width="90%"><p class="caption">
Figure 9.1: Example of Google Maps, as at 29 January 2022
</p>
</div>
<p>The advantage of using an API is that the data provider specifies exactly the data that they are willing to provide, and the terms under which they will provide it. These terms may include aspects such as rate limits (i.e. how often we can ask for data), and what we can do with the data, for instance, we might not be allowed to use it for commercial purposes, or to republish it. Additionally, because the API is being provided specifically for us to use it, it is less likely to be subject to unexpected changes or legal issues. Because of this it is ethically and legally clear that when an API is available we should try to use it rather than web scraping.</p>
<p>We will now go through a few case studies of using APIs. In the first we deal directly with an API using <code>httr</code> <span class="citation">(<a href="references-1.html#ref-citehttr" role="doc-biblioref">Wickham 2019c</a>)</span>. In the second we access data from Twitter using <code>rtweet</code> <span class="citation">(<a href="references-1.html#ref-rtweet" role="doc-biblioref">Kearney 2019</a>)</span>. And in the third we access data from Spotify using <code>spotifyr</code> <span class="citation">(<a href="references-1.html#ref-spotifyr" role="doc-biblioref">Thompson et al. 2020</a>)</span>. Developing comfort with gathering data through APIs enables access to exciting datasets. For instance, <span class="citation">Wong (<a href="references-1.html#ref-facebookapitrump" role="doc-biblioref">2020</a>)</span> use the Facebook Political Ad API to gather all 218,100 of the Trump 2020 campaign ads to better understand the campaign.</p>
<div id="case-study-gathering-data-from-arxiv-nasa-and-dataverse" class="section level3" number="9.2.1">
<h3>
<span class="header-section-number">9.2.1</span> Case study: Gathering data from arXiv, NASA, and Dataverse<a class="anchor" aria-label="anchor" href="#case-study-gathering-data-from-arxiv-nasa-and-dataverse"><i class="fas fa-link"></i></a>
</h3>
<p>We use <code><a href="https://httr.r-lib.org/reference/GET.html">GET()</a></code> from <code>httr</code> <span class="citation">(<a href="references-1.html#ref-citehttr" role="doc-biblioref">Wickham 2019c</a>)</span> to obtain data from an API directly. This will try to get some specific data and the main argument is ‘url’. In a way, this is very similar to the earlier Google Maps example. In that example, the specific information that we were interested in was a map.</p>
<p>In this case study we will use an API provided by arXiv: <a href="https://arxiv.org" class="uri">https://arxiv.org</a>. arXiv is an online repository for academic papers before they go through peer-review, and these are typically referred to as ‘pre-prints’. After installing and loading <code>httr</code>, we use <code><a href="https://httr.r-lib.org/reference/GET.html">GET()</a></code> to ask arXiv to obtain some information about the pre-print of <span class="citation">R. Alexander and Alexander (<a href="references-1.html#ref-Alexander2020" role="doc-biblioref">2021</a>)</span>.</p>
<div class="sourceCode" id="cb248"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://httr.r-lib.org/">httr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>
<span class="co">#&gt; ── Attaching packages ─────────────────── tidyverse 1.3.1 ──</span>
<span class="co">#&gt; ✓ ggplot2 3.3.5     ✓ purrr   0.3.4</span>
<span class="co">#&gt; ✓ tibble  3.1.6     ✓ dplyr   1.0.7</span>
<span class="co">#&gt; ✓ tidyr   1.2.0     ✓ stringr 1.4.0</span>
<span class="co">#&gt; ✓ readr   2.1.1     ✓ forcats 0.5.1</span>
<span class="co">#&gt; ── Conflicts ────────────────────── tidyverse_conflicts() ──</span>
<span class="co">#&gt; x dplyr::filter() masks stats::filter()</span>
<span class="co">#&gt; x dplyr::lag()    masks stats::lag()</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://xml2.r-lib.org/">xml2</a></span><span class="op">)</span>

<span class="va">arxiv</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://httr.r-lib.org/reference/GET.html">GET</a></span><span class="op">(</span><span class="st">"http://export.arxiv.org/api/query?id_list=2111.09299"</span><span class="op">)</span>

<span class="fu"><a href="https://httr.r-lib.org/reference/status_code.html">status_code</a></span><span class="op">(</span><span class="va">arxiv</span><span class="op">)</span>
<span class="co">#&gt; [1] 200</span></code></pre></div>
<p>We can use <code><a href="https://httr.r-lib.org/reference/status_code.html">status_code()</a></code> to check whether we received an error from the server. And assuming we received something back from the server, we can use <code><a href="https://httr.r-lib.org/reference/content.html">content()</a></code> to display the information. In this case we have received XML formatted data, which we can read using <code><a href="http://xml2.r-lib.org/reference/read_xml.html">read_xml()</a></code> from <code>xml2</code> <span class="citation">(<a href="references-1.html#ref-xml2" role="doc-biblioref">Wickham, Hester, and Ooms 2021</a>)</span>. XML is a semi-formatted structure, and it can be useful to start by having a look at it using <code><a href="http://xml2.r-lib.org/reference/xml_structure.html">html_structure()</a></code>.</p>
<div class="sourceCode" id="cb249"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://httr.r-lib.org/reference/content.html">content</a></span><span class="op">(</span><span class="va">arxiv</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="http://xml2.r-lib.org/reference/read_xml.html">read_xml</a></span><span class="op">(</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_structure.html">html_structure</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; &lt;feed [xmlns]&gt;</span>
<span class="co">#&gt;   &lt;link [href, rel, type]&gt;</span>
<span class="co">#&gt;   &lt;title [type]&gt;</span>
<span class="co">#&gt;     {text}</span>
<span class="co">#&gt;   &lt;id&gt;</span>
<span class="co">#&gt;     {text}</span>
<span class="co">#&gt;   &lt;updated&gt;</span>
<span class="co">#&gt;     {text}</span>
<span class="co">#&gt;   &lt;totalResults [xmlns:opensearch]&gt;</span>
<span class="co">#&gt;     {text}</span>
<span class="co">#&gt;   &lt;startIndex [xmlns:opensearch]&gt;</span>
<span class="co">#&gt;     {text}</span>
<span class="co">#&gt;   &lt;itemsPerPage [xmlns:opensearch]&gt;</span>
<span class="co">#&gt;     {text}</span>
<span class="co">#&gt;   &lt;entry&gt;</span>
<span class="co">#&gt;     &lt;id&gt;</span>
<span class="co">#&gt;       {text}</span>
<span class="co">#&gt;     &lt;updated&gt;</span>
<span class="co">#&gt;       {text}</span>
<span class="co">#&gt;     &lt;published&gt;</span>
<span class="co">#&gt;       {text}</span>
<span class="co">#&gt;     &lt;title&gt;</span>
<span class="co">#&gt;       {text}</span>
<span class="co">#&gt;     &lt;summary&gt;</span>
<span class="co">#&gt;       {text}</span>
<span class="co">#&gt;     &lt;author&gt;</span>
<span class="co">#&gt;       &lt;name&gt;</span>
<span class="co">#&gt;         {text}</span>
<span class="co">#&gt;     &lt;author&gt;</span>
<span class="co">#&gt;       &lt;name&gt;</span>
<span class="co">#&gt;         {text}</span>
<span class="co">#&gt;     &lt;comment [xmlns:arxiv]&gt;</span>
<span class="co">#&gt;       {text}</span>
<span class="co">#&gt;     &lt;link [href, rel, type]&gt;</span>
<span class="co">#&gt;     &lt;link [title, href, rel, type]&gt;</span>
<span class="co">#&gt;     &lt;primary_category [term, scheme, xmlns:arxiv]&gt;</span>
<span class="co">#&gt;     &lt;category [term, scheme]&gt;</span></code></pre></div>
<p>Or we might be interested to create a dataset based on extracting various aspects of this XML tree. For instance, we might be interested to look at the ‘entry’, which is the eighth item, and in particular to obtain the title and the URL, which are the fourth and ninth items, respectively, within entry.</p>
<div class="sourceCode" id="cb250"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data_from_arxiv</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>
    title <span class="op">=</span> <span class="fu"><a href="https://httr.r-lib.org/reference/content.html">content</a></span><span class="op">(</span><span class="va">arxiv</span><span class="op">)</span> |&gt;
      <span class="fu"><a href="http://xml2.r-lib.org/reference/read_xml.html">read_xml</a></span><span class="op">(</span><span class="op">)</span> |&gt;
      <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_children.html">xml_child</a></span><span class="op">(</span>search <span class="op">=</span> <span class="fl">8</span><span class="op">)</span> |&gt;
      <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_children.html">xml_child</a></span><span class="op">(</span>search <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> |&gt;
      <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_text.html">xml_text</a></span><span class="op">(</span><span class="op">)</span>,
    link <span class="op">=</span> <span class="fu"><a href="https://httr.r-lib.org/reference/content.html">content</a></span><span class="op">(</span><span class="va">arxiv</span><span class="op">)</span> |&gt;
      <span class="fu"><a href="http://xml2.r-lib.org/reference/read_xml.html">read_xml</a></span><span class="op">(</span><span class="op">)</span> |&gt;
      <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_children.html">xml_child</a></span><span class="op">(</span>search <span class="op">=</span> <span class="fl">8</span><span class="op">)</span> |&gt;
      <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_children.html">xml_child</a></span><span class="op">(</span>search <span class="op">=</span> <span class="fl">9</span><span class="op">)</span> |&gt;
      <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_attr.html">xml_attr</a></span><span class="op">(</span><span class="st">"href"</span><span class="op">)</span>
  <span class="op">)</span>
<span class="va">data_from_arxiv</span>
<span class="co">#&gt; # A tibble: 1 × 2</span>
<span class="co">#&gt;   title                                                link </span>
<span class="co">#&gt;   &lt;chr&gt;                                                &lt;chr&gt;</span>
<span class="co">#&gt; 1 "The Increased Effect of Elections and Changing Pri… http…</span></code></pre></div>
<p>Each day NASA provides the Astronomy Picture of the Day (APOD) through its APOD API. We can again use <code><a href="https://httr.r-lib.org/reference/GET.html">GET()</a></code> to obtain the URL for the photo on particular dates and then display it.</p>
<div class="sourceCode" id="cb251"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">NASA_APOD_20211226</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://httr.r-lib.org/reference/GET.html">GET</a></span><span class="op">(</span><span class="st">"https://api.nasa.gov/planetary/apod?api_key=DEMO_KEY&amp;date=2021-12-26"</span><span class="op">)</span>

<span class="va">NASA_APOD_20190719</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://httr.r-lib.org/reference/GET.html">GET</a></span><span class="op">(</span><span class="st">"https://api.nasa.gov/planetary/apod?api_key=DEMO_KEY&amp;date=2019-07-19"</span><span class="op">)</span></code></pre></div>
<p>Examining the returned data using <code><a href="https://httr.r-lib.org/reference/content.html">content()</a></code>, we can see that we are provided with various fields, such as date, title, explanation, and a URL. And we can provide that URL to <code><a href="https://rdrr.io/pkg/knitr/man/include_graphics.html">include_graphics()</a></code> from <code>knitr</code> to display it (Figure <a href="gather-data.html#fig:nasaone">9.2</a>).</p>
<div class="sourceCode" id="cb252"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://httr.r-lib.org/reference/content.html">content</a></span><span class="op">(</span><span class="va">NASA_APOD_20211226</span><span class="op">)</span><span class="op">$</span><span class="va">date</span>
<span class="co">#&gt; [1] "2021-12-26"</span>
<span class="fu"><a href="https://httr.r-lib.org/reference/content.html">content</a></span><span class="op">(</span><span class="va">NASA_APOD_20211226</span><span class="op">)</span><span class="op">$</span><span class="va">title</span>
<span class="co">#&gt; [1] "James Webb Space Telescope over Earth"</span>
<span class="fu"><a href="https://httr.r-lib.org/reference/content.html">content</a></span><span class="op">(</span><span class="va">NASA_APOD_20211226</span><span class="op">)</span><span class="op">$</span><span class="va">explanation</span>
<span class="co">#&gt; [1] "There's a big new telescope in space. This one, the James Webb Space Telescope (JWST), not only has a mirror over five times larger than Hubble's in area, but can see better in infrared light. The featured picture shows JWST high above the Earth just after being released by the upper stage of an Ariane V rocket, launched yesterday from French Guiana. Over the next month, JWST will move out near the Sun-Earth L2 point where it will co-orbit the Sun with the Earth. During this time and for the next five months, JWST will unravel its segmented mirror and an array of sophisticated scientific instruments -- and test them. If all goes well, JWST will start examining galaxies across the universe and planets orbiting stars across our Milky Way Galaxy in the summer of 2022.   APOD Gallery: Webb Space Telescope Launch"</span>
<span class="fu"><a href="https://httr.r-lib.org/reference/content.html">content</a></span><span class="op">(</span><span class="va">NASA_APOD_20211226</span><span class="op">)</span><span class="op">$</span><span class="va">url</span>
<span class="co">#&gt; [1] "https://apod.nasa.gov/apod/image/2112/JwstLaunch_Arianespace_1080.jpg"</span>

<span class="fu"><a href="https://httr.r-lib.org/reference/content.html">content</a></span><span class="op">(</span><span class="va">NASA_APOD_20190719</span><span class="op">)</span><span class="op">$</span><span class="va">date</span>
<span class="co">#&gt; [1] "2019-07-19"</span>
<span class="fu"><a href="https://httr.r-lib.org/reference/content.html">content</a></span><span class="op">(</span><span class="va">NASA_APOD_20190719</span><span class="op">)</span><span class="op">$</span><span class="va">title</span>
<span class="co">#&gt; [1] "Tranquility Base Panorama"</span>
<span class="fu"><a href="https://httr.r-lib.org/reference/content.html">content</a></span><span class="op">(</span><span class="va">NASA_APOD_20190719</span><span class="op">)</span><span class="op">$</span><span class="va">explanation</span>
<span class="co">#&gt; [1] "On July 20, 1969 the Apollo 11 lunar module Eagle safely touched down on the Moon. It landed near the southwestern corner of the Moon's Mare Tranquillitatis at a landing site dubbed Tranquility Base. This panoramic view of Tranquility Base was constructed from the historic photos taken from the lunar surface. On the far left astronaut Neil Armstrong casts a long shadow with Sun is at his back and the Eagle resting about 60 meters away ( AS11-40-5961). He stands near the rim of 30 meter-diameter Little West crater seen here to the right ( AS11-40-5954). Also visible in the foreground is the top of the camera intended for taking stereo close-ups of the lunar surface."</span>
<span class="fu"><a href="https://httr.r-lib.org/reference/content.html">content</a></span><span class="op">(</span><span class="va">NASA_APOD_20190719</span><span class="op">)</span><span class="op">$</span><span class="va">url</span>
<span class="co">#&gt; [1] "https://apod.nasa.gov/apod/image/1907/apollo11TranquilitybasePan600h.jpg"</span></code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:nasaone"></span>
<img src="figures/JwstLaunch_Arianespace_1080.jpg" alt="Photo of the James Webb Space Telescope over Earth and another of Tranquility Base obtained from the NASA APOD API" width="50%"><img src="figures/apollo11TranquilitybasePan.jpg" alt="Photo of the James Webb Space Telescope over Earth and another of Tranquility Base obtained from the NASA APOD API" width="50%"><p class="caption">
Figure 9.2: Photo of the James Webb Space Telescope over Earth and another of Tranquility Base obtained from the NASA APOD API
</p>
</div>
<p>Finally, another common API response in semi-structured form is JSON. We can parse JSON with <code>jsonlite</code> <span class="citation">(<a href="references-1.html#ref-jsonlite" role="doc-biblioref">Ooms 2014</a>)</span>. A Dataverse is a web application that makes it easier to share dataset. We can use an API go query a demonstration dataverse. For instance we might be interested in datasets related to politics.</p>
<div class="sourceCode" id="cb253"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://arxiv.org/abs/1403.2805">jsonlite</a></span><span class="op">)</span>

<span class="va">politics_datasets</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html">fromJSON</a></span><span class="op">(</span><span class="st">"https://demo.dataverse.org/api/search?q=politics"</span><span class="op">)</span></code></pre></div>
<p>We can also look at the dataset using <code>View(politics_datasets)</code>, which allows us to expand the tree based on what we are interested in and even get the code that we need to focus on different aspects by hovering on the item and then clicking the icon with the green arrow (Figure <a href="gather-data.html#fig:jsonfirst">9.3</a>).</p>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:jsonfirst"></span>
<img src="figures/jsonlite.png" alt="Example of hovering over an JSON element, 'items', where the icon with a green arrow can be clicked on to get the code that would focus on that element" width="90%"><p class="caption">
Figure 9.3: Example of hovering over an JSON element, ‘items’, where the icon with a green arrow can be clicked on to get the code that would focus on that element
</p>
</div>
<p>This tells us how to obtain the dataset of interest.</p>
<div class="sourceCode" id="cb254"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="va">politics_datasets</span><span class="op">[[</span><span class="st">"data"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"items"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 1 × 6</span>
<span class="co">#&gt;   name       type  url   identifier description published_at</span>
<span class="co">#&gt;   &lt;chr&gt;      &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;      &lt;chr&gt;       &lt;chr&gt;       </span>
<span class="co">#&gt; 1 China Arc… data… http… china-arc… Introducti… 2016-12-09T…</span></code></pre></div>
</div>
<div id="case-study-gathering-data-from-twitter" class="section level3" number="9.2.2">
<h3>
<span class="header-section-number">9.2.2</span> Case study: Gathering data from Twitter<a class="anchor" aria-label="anchor" href="#case-study-gathering-data-from-twitter"><i class="fas fa-link"></i></a>
</h3>
<p>Twitter is a rich source of text and other data. The Twitter API is the way in which Twitter asks that we gather these data. And <code>rtweet</code> <span class="citation">(<a href="references-1.html#ref-rtweet" role="doc-biblioref">Kearney 2019</a>)</span> is built around this API and allows us to interact with it in ways that are similar to using any other R package. Initially, we can use the Twitter API with just a regular Twitter account.</p>
<p>Begin by installing and loading <code>rtweet</code> and <code>tidyverse</code>. We then need to authorize <code>rtweet</code> and we start that process by calling a function from the package, for instance <code><a href="https://rdrr.io/pkg/rtweet/man/get_favorites.html">get_favorites()</a></code> which will return a tibble of a user’s favorites. This will open a browser, and we then log into a regular Twitter account (Figure <a href="gather-data.html#fig:rtweetlogin">9.4</a>).</p>
<div class="sourceCode" id="cb255"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://CRAN.R-project.org/package=rtweet">rtweet</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb256"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/rtweet/man/get_favorites.html">get_favorites</a></span><span class="op">(</span>user <span class="op">=</span> <span class="st">"RohanAlexander"</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:rtweetlogin"></span>
<img src="figures/rtweet.png" alt="rtweet authorisation page" width="90%"><p class="caption">
Figure 9.4: rtweet authorisation page
</p>
</div>
<p>Once the application is authorized, then we can use <code><a href="https://rdrr.io/pkg/rtweet/man/get_favorites.html">get_favorites()</a></code> to actually get the favorites of a user and save them.</p>
<div class="sourceCode" id="cb257"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rohans_favorites</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rtweet/man/get_favorites.html">get_favorites</a></span><span class="op">(</span><span class="st">"RohanAlexander"</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">rohans_favorites</span>, <span class="st">"rohans_favorites.rds"</span><span class="op">)</span></code></pre></div>
<p>We could then look at some recent favorites, keeping in mind that they may be different depending on when they are being accessed.</p>
<div class="sourceCode" id="cb258"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rohans_favorites</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">created_at</span><span class="op">)</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">screen_name</span>, <span class="va">text</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 10 × 2</span>
<span class="co">#&gt;    screen_name text                                         </span>
<span class="co">#&gt;    &lt;chr&gt;       &lt;chr&gt;                                        </span>
<span class="co">#&gt;  1 EconAndrew  "How much better are the investment opportun…</span>
<span class="co">#&gt;  2 simonpcouch "There's a new release of #rstats broom up o…</span>
<span class="co">#&gt;  3 MineDogucu  "🚨 New manuscript🚨\n📕 Content and Computi…</span>
<span class="co">#&gt;  4 reid_nancy  "Latest issue. From the intro: \"... it has …</span>
<span class="co">#&gt;  5 tjmahr      "bathing is good, folks"                     </span>
<span class="co">#&gt;  6 andrewheiss "finished hand washing that load in the bath…</span>
<span class="co">#&gt;  7 monkmanmh   "@CMastication https://t.co/3Eh0mLy44v"      </span>
<span class="co">#&gt;  8 eplusgg     "Stares from Ontario https://t.co/swzYhaptF9"</span>
<span class="co">#&gt;  9 ryancbriggs "Same. https://t.co/C9pNpXO0F9"              </span>
<span class="co">#&gt; 10 flynnpolsci "I’m not great at coming up with assignments…</span></code></pre></div>
<p>We can use <code><a href="https://rdrr.io/pkg/rtweet/man/search_tweets.html">search_tweets()</a></code> to search for tweets about a particular topic. For instance, we could look at tweets using a hashtag commonly associated with R: ‘#rstats’.</p>
<div class="sourceCode" id="cb259"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rstats_tweets</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rtweet/man/search_tweets.html">search_tweets</a></span><span class="op">(</span>
  q <span class="op">=</span> <span class="st">"#rstats"</span>,
  include_rts <span class="op">=</span> <span class="cn">FALSE</span>
<span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">rstats_tweets</span>, <span class="st">"rstats_tweets.rds"</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb260"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rstats_tweets</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">screen_name</span>, <span class="va">text</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 × 2</span>
<span class="co">#&gt;   screen_name     text                                      </span>
<span class="co">#&gt;   &lt;chr&gt;           &lt;chr&gt;                                     </span>
<span class="co">#&gt; 1 SuccessAnalytiX "The Science of Success \n\nhttps://t.co/…</span>
<span class="co">#&gt; 2 babycoin_dev    "BabyCoin (BABY)\n\nGUI wallet v2.05 =&amp;gt…</span>
<span class="co">#&gt; 3 rstatsdata      "#rdata #rstats: Yield of 6 barley variet…</span>
<span class="co">#&gt; 4 PDH_SciTechNews "#Coding Arm Puts Security Architecture t…</span>
<span class="co">#&gt; 5 PDH_SciTechNews "#Coding Network Engineer: Skills, Roles …</span>
<span class="co">#&gt; 6 PDH_SciTechNews "#Coding CockroachDB Strengthens Change D…</span></code></pre></div>
<p>Other useful functions that can be used include <code><a href="https://rdrr.io/pkg/rtweet/man/get_friends.html">get_friends()</a></code> to get all the accounts that a user follows, and <code><a href="https://rdrr.io/pkg/rtweet/man/get_timeline.html">get_timelines()</a></code> to get a user’s recent tweets. Registering as a developer enables access to more API functionality.</p>
<p>When using APIs, even when they are wrapped in an R package, in this case <code>rtweet</code>, it is important to read the terms under which access is provided. The Twitter API docs are surprisingly readable, and the developer policy is especially clear: <a href="https://developer.twitter.com/en/developer-terms/policy" class="uri">https://developer.twitter.com/en/developer-terms/policy</a>. To see how easy it is to violate the terms under which an API provider makes data available, consider that we saved the tweets that we downloaded. If we were to push these to GitHub, then it is possible that we may have accidentally stored sensitive information if there happened to be some in the tweets. Twitter is also explicit about asking those that use their API to be especially careful about sensitive information and not matching Twitter users with off-Twitter folks. Again, the documentation around these restricted uses is clear and readable: <a href="https://developer.twitter.com/en/developer-terms/more-on-restricted-use-cases" class="uri">https://developer.twitter.com/en/developer-terms/more-on-restricted-use-cases</a>.</p>
</div>
<div id="case-study-gathering-data-from-spotify" class="section level3" number="9.2.3">
<h3>
<span class="header-section-number">9.2.3</span> Case study: Gathering data from Spotify<a class="anchor" aria-label="anchor" href="#case-study-gathering-data-from-spotify"><i class="fas fa-link"></i></a>
</h3>
<p>For the final case study, we will use <code>spotifyr</code> <span class="citation">(<a href="references-1.html#ref-spotifyr" role="doc-biblioref">Thompson et al. 2020</a>)</span>, which is a wrapper around the Spotify API. Install <code>install.packages('spotifyr')</code> and load the package.</p>
<div class="sourceCode" id="cb261"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/charlie86/spotifyr">spotifyr</a></span><span class="op">)</span></code></pre></div>
<p>To access the Spotify API, we need a Spotify Developer Account: <a href="https://developer.spotify.com/dashboard/" class="uri">https://developer.spotify.com/dashboard/</a>. This will require logging in with a Spotify account and then accepting the Developer Terms (Figure <a href="gather-data.html#fig:spotifyaccept">9.5</a>).</p>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:spotifyaccept"></span>
<img src="figures/spotify.png" alt="Spotify Developer Account Terms agreement page" width="90%"><p class="caption">
Figure 9.5: Spotify Developer Account Terms agreement page
</p>
</div>
<p>Continuing with the registration process, in our case, we ‘do not know’ what we are building and so Spotify requires us to use a non-commercial agreement. To use the Spotify API we need a ‘Client ID’ and a ‘Client Secret’. These are things that we want to keep to ourselves because anyone with the details could use our developer account as though they were us. One way to keep these details secret with a minimum of hassle is to keep them in our ‘System Environment’. In this way, when we push to GitHub they should not be included. (We followed this process without explanation in Chapter <a href="interactive-communication.html#interactive-communication">7</a> when we used <code>mapdeck</code>.) We will use <code>usethis</code> <span class="citation">(<a href="references-1.html#ref-citeusethis" role="doc-biblioref">Wickham and Bryan 2020</a>)</span> to modify our System Environment. In particular, there is a file called ‘.Renviron’ which we will open using <code><a href="https://usethis.r-lib.org/reference/edit.html">edit_r_environ()</a></code> and add our ‘Client ID’ and ‘Client Secret’ to.</p>
<div class="sourceCode" id="cb262"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://usethis.r-lib.org">usethis</a></span><span class="op">)</span>

<span class="fu"><a href="https://usethis.r-lib.org/reference/edit.html">edit_r_environ</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>When we run <code><a href="https://usethis.r-lib.org/reference/edit.html">edit_r_environ()</a></code>, our ‘.Renviron’ file will open and we can add our ‘Spotify Client ID’ and ‘Client Secret’. It is important to use the same names, because <code>spotifyr</code> will look in our environment for keys with those specific names.</p>
<div class="sourceCode" id="cb263"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">SPOTIFY_CLIENT_ID</span> <span class="op">=</span> <span class="st">'PUT_YOUR_CLIENT_ID_HERE'</span>
<span class="va">SPOTIFY_CLIENT_SECRET</span> <span class="op">=</span> <span class="st">'PUT_YOUR_SECRET_HERE'</span></code></pre></div>
<p>Save the ‘.Renviron’ file, and then restart R (‘Session’ -&gt; ‘Restart R’). We can now use our ‘Spotify Client ID’ and ‘Client Secret’ as needed. And functions that require those details as arguments will work without them being explicitly specified again. We will get and save some information about Radiohead, the English rock band, using <code><a href="https://rdrr.io/pkg/spotifyr/man/get_artist_audio_features.html">get_artist_audio_features()</a></code>. One of the required arguments is <code>authorization</code>, but as that is set, by default, to look at the ‘.Renviron’ file, we do not need to specify it here.</p>
<div class="sourceCode" id="cb264"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">radiohead</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/spotifyr/man/get_artist_audio_features.html">get_artist_audio_features</a></span><span class="op">(</span><span class="st">'radiohead'</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">radiohead</span>, <span class="st">"radiohead.rds"</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb265"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">radiohead</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"radiohead.rds"</span><span class="op">)</span></code></pre></div>
<p>There is a variety of information available based on songs. We might be interested to see whether their songs are getting longer over time (Figure <a href="gather-data.html#fig:readioovertime">9.6</a>).</p>
<div class="sourceCode" id="cb266"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">radiohead</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">artist_name</span>, <span class="va">track_name</span>, <span class="va">album_name</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt;   artist_name                    track_name   album_name</span>
<span class="co">#&gt; 1   Radiohead Everything In Its Right Place KID A MNESIA</span>
<span class="co">#&gt; 2   Radiohead                         Kid A KID A MNESIA</span>
<span class="co">#&gt; 3   Radiohead           The National Anthem KID A MNESIA</span>
<span class="co">#&gt; 4   Radiohead   How to Disappear Completely KID A MNESIA</span>
<span class="co">#&gt; 5   Radiohead                   Treefingers KID A MNESIA</span>
<span class="co">#&gt; 6   Radiohead                    Optimistic KID A MNESIA</span></code></pre></div>
<div class="sourceCode" id="cb267"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org">lubridate</a></span><span class="op">)</span>

<span class="va">radiohead</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>album_release_date <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="va">album_release_date</span><span class="op">)</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">album_release_date</span>, y <span class="op">=</span> <span class="va">duration_ms</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Album release date"</span>,
       y <span class="op">=</span> <span class="st">"Duration of song (ms)"</span>
       <span class="op">)</span> </code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:readioovertime"></span>
<img src="21-gather_files/figure-html/readioovertime-1.png" alt="Length of each Radiohead song, over time, as gathered from Spotify" width="672"><p class="caption">
Figure 9.6: Length of each Radiohead song, over time, as gathered from Spotify
</p>
</div>
<p>One interesting variable provided by Spotify about each song is ‘valence’. The Spotify documentation describe this as a measure between 0 and 1 that signals the ‘the musical positiveness’ of the track with higher values being more positive. Further details are available at the documentation: <a href="https://developer.spotify.com/documentation/web-api/reference/#/operations/get-audio-features" class="uri">https://developer.spotify.com/documentation/web-api/reference/#/operations/get-audio-features</a>. We might be interested to compare valence over time between a few artists, for instance, the American rock band The National, and the American singer Taylor Swift.</p>
<p>First, we need to gather the data.</p>
<div class="sourceCode" id="cb268"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">taylor_swift</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/spotifyr/man/get_artist_audio_features.html">get_artist_audio_features</a></span><span class="op">(</span><span class="st">'taylor swift'</span><span class="op">)</span>
<span class="va">the_national</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/spotifyr/man/get_artist_audio_features.html">get_artist_audio_features</a></span><span class="op">(</span><span class="st">'the national'</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">taylor_swift</span>, <span class="st">"taylor_swift.rds"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">the_national</span>, <span class="st">"the_national.rds"</span><span class="op">)</span></code></pre></div>
<p>Then we can bring them together and make the graph (Figure <a href="gather-data.html#fig:swiftyvsnationalvsradiohead">9.7</a>). This appears to show that while Taylor Swift and Radiohead have largely maintained their level of valence overtime, The National has decreased theirs.</p>
<div class="sourceCode" id="cb269"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">three_artists</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">taylor_swift</span>, <span class="va">the_national</span>, <span class="va">radiohead</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">artist_name</span>, <span class="va">album_release_date</span>, <span class="va">valence</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>album_release_date <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="va">album_release_date</span><span class="op">)</span><span class="op">)</span>

<span class="va">three_artists</span> |&gt;
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">album_release_date</span>,
             y <span class="op">=</span> <span class="va">valence</span>,
             color <span class="op">=</span> <span class="va">artist_name</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Album release date"</span>,
       y <span class="op">=</span> <span class="st">"Valence"</span>,
       color <span class="op">=</span> <span class="st">"Artist"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_color_brewer</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Set1"</span><span class="op">)</span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:swiftyvsnationalvsradiohead"></span>
<img src="21-gather_files/figure-html/swiftyvsnationalvsradiohead-1.png" alt="Comparing valence, over time, for Radiohead, Taylor Swift, and The National" width="672"><p class="caption">
Figure 9.7: Comparing valence, over time, for Radiohead, Taylor Swift, and The National
</p>
</div>
<p>How amazing that we live in a world that all that information is available with very little effort or cost. And having gathered the data, there is a lot that could be done. For instance, <span class="citation">Pavlik (<a href="references-1.html#ref-kaylinpavlik" role="doc-biblioref">2019</a>)</span> uses an expanded dataset to classify musical genres and <span class="citation">The Economist (<a href="references-1.html#ref-theeconomistonspotify" role="doc-biblioref">2022</a>)</span> looks at how language is associated with music streaming on Spotify. Our ability to gather such data enables us to answer questions that had to be considered experimentally in the past, for instance <span class="citation">M. J. Salganik, Dodds, and Watts (<a href="references-1.html#ref-salganik2006experimental" role="doc-biblioref">2006</a>)</span> had to use experimental data rather than the real data we are able to access. But at the same time, it is worth thinking about what valence is purporting to represent. Little information is available in the Spotify documentation about how this is being created. And it is doubtful that one number can completely represent how positive a song is.</p>
<!-- ## NBA statistics -->
<!-- NBA: https://github.com/toddwschneider/ballr -->
<!-- ## tidyquant -->
<!-- Financial markets data: tidyquant -->
<!-- ## Danish statistics -->
<!-- https://cran.r-project.org/web/packages/danstat/vignettes/Introduction_to_danstat.html -->
</div>
</div>
<div id="web-scraping" class="section level2" number="9.3">
<h2>
<span class="header-section-number">9.3</span> Web scraping<a class="anchor" aria-label="anchor" href="#web-scraping"><i class="fas fa-link"></i></a>
</h2>
<p>Web scraping is a way to get data from websites. Rather than going to a website using a browser the copy and pasting, we write code that does it for us. This opens a lot of data to us, but on the other hand, it is not typically data that is being made available for these purposes. This means that it is important to be respectful of it. While generally not illegal, the specifics about the legality of web scraping depend on jurisdictions and the specifics of what we are doing, and so it is also important to be mindful of this. While our use would rarely be commercially competitive, of particular concern is the conflict between the need for our work to be reproducible with the need to respect terms of service that may disallow data republishing <span class="citation">(<a href="references-1.html#ref-luscombe2021algorithmic" role="doc-biblioref">Luscombe, Dick, and Walby 2021</a>)</span>. And finally, web scraping imposes a cost on the website host, and so it is important to reduce this to the extent possible.</p>
<p>That all said, web scraping is an invaluable source of data. But they are typically datasets that can be created as a by-product of someone trying to achieve another aim. For instance, a retailer may have a website with their products and their prices. That has not been created deliberately as a source of data, but we can scrape it to create a dataset. As such, the following principles are useful to guide web scraping.</p>
<ol style="list-style-type: decimal">
<li>Avoid it. Try to use an API wherever possible.</li>
<li>Abide by their desires. Some websites have a ‘robots.txt’ file that contains information about what they are comfortable with scrapers doing, for instance ‘<a href="https://www.google.com/robots.txt" class="uri">https://www.google.com/robots.txt</a>’.</li>
<li>Reduce the impact.
<ul>
<li>Firstly, slow down the scraper, for instance, rather than having it visit the website every second, slow it down using <code>sys.sleep()</code>. If we only need a few hundred files, then why not just have it visit the website a few times a minute, running in the background overnight?</li>
<li>Secondly, consider the timing of when we run our scraper. For instance, if we are scraping a retailer then maybe we should set our script to run from 10pm through to the morning, when fewer customers are likely using the site. Similarly, if it is a government website and they have a big monthly release, then it might be polite to avoid that day.</li>
</ul>
</li>
<li>Take only what is needed. For instance, we do not need to scrape the entire of Wikipedia if all we need is the names of the ten largest cities in Croatia. This reduces the impact on the website, and allows us to more easily justify our actions.</li>
<li>Only scrape once. This means we should save everything as we go so that we do not have to re-collect data. Similarly, once we have the data, we should keep that separate and not modify it. Of course, if we need data over time then we will need to go back, but this is different to needlessly re-scraping a page.</li>
<li>Do not republish the pages that were scraped. (This contrasts with datasets that we create from it.)</li>
<li>Take ownership and ask permission if possible. At a minimum level all scripts should have our contact details in them. Depending on the circumstances, it may be worthwhile asking for permission before you scrape.</li>
</ol>
<p>Web scraping is possible by taking advantage of the underlying structure of a webpage. We use patterns in the HTML/CSS to get the data that we want. To look at the underlying HTML/CSS we can either:</p>
<ol style="list-style-type: decimal">
<li>open a browser, right-click, and choose something like ‘Inspect’; or</li>
<li>save the website and then open it with a text editor rather than a browser.</li>
</ol>
<p>HTML/CSS is a markup language comprised of matching tags. If we want text to be bold, then we would use something like:</p>
<div class="sourceCode" id="cb270"><pre class="sourceCode css"><code class="sourceCode css"><span id="cb270-1"><a href="gather-data.html#cb270-1" aria-hidden="true" tabindex="-1"></a>&lt;b<span class="op">&gt;</span>My bold text&lt;/b<span class="op">&gt;</span></span></code></pre></div>
<p>Similarly, if we want a list then we start and end the list, as well as each item.</p>
<div class="sourceCode" id="cb271"><pre class="sourceCode css"><code class="sourceCode css"><span id="cb271-1"><a href="gather-data.html#cb271-1" aria-hidden="true" tabindex="-1"></a>&lt;ul<span class="op">&gt;</span></span>
<span id="cb271-2"><a href="gather-data.html#cb271-2" aria-hidden="true" tabindex="-1"></a>  &lt;li<span class="op">&gt;</span>Learn webscraping&lt;/li<span class="op">&gt;</span></span>
<span id="cb271-3"><a href="gather-data.html#cb271-3" aria-hidden="true" tabindex="-1"></a>  &lt;li<span class="op">&gt;</span>Do data science&lt;/li<span class="op">&gt;</span></span>
<span id="cb271-4"><a href="gather-data.html#cb271-4" aria-hidden="true" tabindex="-1"></a>  &lt;li<span class="op">&gt;</span>Proft&lt;/li<span class="op">&gt;</span></span>
<span id="cb271-5"><a href="gather-data.html#cb271-5" aria-hidden="true" tabindex="-1"></a>&lt;/ul<span class="op">&gt;</span></span></code></pre></div>
<p>When scraping we will search for these tags.</p>
<p>To get started, we can pretend that we obtained some HTML from a website, and that we want to get the name from it. We can see that the name is in bold, so we want to focus on that feature and extract it.</p>
<div class="sourceCode" id="cb272"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">website_extract</span> <span class="op">&lt;-</span> <span class="st">"&lt;p&gt;Hi, I’m &lt;b&gt;Rohan&lt;/b&gt; Alexander.&lt;/p&gt;"</span></code></pre></div>
<p>We will use <code><a href="http://xml2.r-lib.org/reference/read_xml.html">read_html()</a></code> from <code>rvest</code> <span class="citation">(<a href="references-1.html#ref-citervest" role="doc-biblioref">Wickham 2019d</a>)</span> to read in the data.</p>
<div class="sourceCode" id="cb273"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># install.packages("rvest")</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rvest.tidyverse.org/">rvest</a></span><span class="op">)</span>

<span class="va">rohans_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/read_xml.html">read_html</a></span><span class="op">(</span><span class="va">website_extract</span><span class="op">)</span>

<span class="va">rohans_data</span>
<span class="co">#&gt; {html_document}</span>
<span class="co">#&gt; &lt;html&gt;</span>
<span class="co">#&gt; [1] &lt;body&gt;&lt;p&gt;Hi, I’m &lt;b&gt;Rohan&lt;/b&gt; Alexander.&lt;/p&gt;&lt;/body&gt;</span></code></pre></div>
<p>The language used by <code>rvest</code> to look for tags is ‘node’, so we focus on bold nodes. By default <code><a href="https://rvest.tidyverse.org/reference/rename.html">html_nodes()</a></code> returns the tags as well. We can focus on the text that they contain, with <code><a href="https://rvest.tidyverse.org/reference/html_text.html">html_text()</a></code>.</p>
<div class="sourceCode" id="cb274"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rohans_data</span> |&gt; 
  <span class="fu"><a href="https://rvest.tidyverse.org/reference/rename.html">html_nodes</a></span><span class="op">(</span><span class="st">"b"</span><span class="op">)</span>
<span class="co">#&gt; {xml_nodeset (1)}</span>
<span class="co">#&gt; [1] &lt;b&gt;Rohan&lt;/b&gt;</span>

<span class="va">first_name</span> <span class="op">&lt;-</span> 
  <span class="va">rohans_data</span> |&gt; 
  <span class="fu"><a href="https://rvest.tidyverse.org/reference/rename.html">html_nodes</a></span><span class="op">(</span><span class="st">"b"</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="https://rvest.tidyverse.org/reference/html_text.html">html_text</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">first_name</span>
<span class="co">#&gt; [1] "Rohan"</span></code></pre></div>
<div id="case-study-web-scraping-book-information" class="section level3" number="9.3.1">
<h3>
<span class="header-section-number">9.3.1</span> Case study: Web scraping book information<a class="anchor" aria-label="anchor" href="#case-study-web-scraping-book-information"><i class="fas fa-link"></i></a>
</h3>
<p>In this case study we will scrape a list of books from: <a href="https://rohanalexander.com/bookshelf.html" class="uri">https://rohanalexander.com/bookshelf.html</a>. We will then clean the data and look at the distribution of the first letters of author surnames. It is slightly more complicated than the example above, but the underlying approach is the same: download the website, look for the nodes of interest, extract the information, clean it.</p>
<p>We use <code>rvest</code> <span class="citation">(<a href="references-1.html#ref-citervest" role="doc-biblioref">Wickham 2019d</a>)</span> to download a website, and to then navigate the html to find the aspects that we are interested in. And we use <code>tidyverse</code> to clean the dataset. We first need to go to the website and then save a local copy.</p>
<div class="sourceCode" id="cb275"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rvest.tidyverse.org/">rvest</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://xml2.r-lib.org/">xml2</a></span><span class="op">)</span>

<span class="va">books_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/read_xml.html">read_html</a></span><span class="op">(</span><span class="st">"https://rohanalexander.com/bookshelf.html"</span><span class="op">)</span>

<span class="fu"><a href="http://xml2.r-lib.org/reference/write_xml.html">write_html</a></span><span class="op">(</span><span class="va">books_data</span>, <span class="st">"raw_data.html"</span><span class="op">)</span> </code></pre></div>
<p>Now we need to navigate the HTML to get the aspects that we want, and to then put them into some sensible structure. We will start with trying to get the data into a tibble as quickly as possible because this will allow us to more easily use <code>dplyr</code> verbs and <code>tidyverse</code> functions.</p>
<div class="sourceCode" id="cb276"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">books_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/read_xml.html">read_html</a></span><span class="op">(</span><span class="st">"inputs/my_website/raw_data.html"</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb277"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">books_data</span>
<span class="co">#&gt; {html_document}</span>
<span class="co">#&gt; &lt;html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang=""&gt;</span>
<span class="co">#&gt; [1] &lt;head&gt;\n&lt;meta http-equiv="Content-Type" content="text ...</span>
<span class="co">#&gt; [2] &lt;body&gt;\n\n&lt;!--radix_placeholder_front_matter--&gt;\n\n&lt;s ...</span></code></pre></div>
<p>To get the data into a tibble we first need to identify the data that we are interested in using html tags. If we look at the website then we need to focus on list items (Figure <a href="gather-data.html#fig:rohansbooks">9.8</a>). And we can look at the source, focusing particularly on looking for a list (Figure <a href="gather-data.html#fig:rohanssourceone">9.9</a>).</p>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:rohansbooks"></span>
<img src="figures/rohansbooks.png" alt="Books website as displayed" width="90%"><p class="caption">
Figure 9.8: Books website as displayed
</p>
</div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:rohanssourceone"></span>
<img src="figures/sourcetop.png" alt="HTML for the top of the books website and the list of books" width="50%"><img src="figures/sourcelist.png" alt="HTML for the top of the books website and the list of books" width="50%"><p class="caption">
Figure 9.9: HTML for the top of the books website and the list of books
</p>
</div>
<p>The tag for a list item is ‘li’, so we can use that to focus on the list.</p>
<div class="sourceCode" id="cb278"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">text_data</span> <span class="op">&lt;-</span> 
  <span class="va">books_data</span> |&gt;
  <span class="fu"><a href="https://rvest.tidyverse.org/reference/rename.html">html_nodes</a></span><span class="op">(</span><span class="st">"li"</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="https://rvest.tidyverse.org/reference/html_text.html">html_text</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">all_books</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>books <span class="op">=</span> <span class="va">text_data</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">all_books</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 × 1</span>
<span class="co">#&gt;   books                     </span>
<span class="co">#&gt;   &lt;chr&gt;                     </span>
<span class="co">#&gt; 1 Academic                  </span>
<span class="co">#&gt; 2 Non-fiction               </span>
<span class="co">#&gt; 3 Fiction                   </span>
<span class="co">#&gt; 4 Cookbooks                 </span>
<span class="co">#&gt; 5 Want to buy               </span>
<span class="co">#&gt; 6 Best books that I read in:</span></code></pre></div>
<p>We now need to clean the data. First we want to separate the title and the author using <code><a href="https://tidyr.tidyverse.org/reference/separate.html">separate()</a></code> and then clean up the author and title columns.</p>
<div class="sourceCode" id="cb279"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">all_books</span> <span class="op">&lt;-</span>
  <span class="va">all_books</span> |&gt;
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="fl">7</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">all_books</span><span class="op">)</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate.html">separate</a></span><span class="op">(</span><span class="va">books</span>, into <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"author"</span>, <span class="st">"title"</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">", ‘"</span><span class="op">)</span>

<span class="va">all_books</span> <span class="op">&lt;-</span>
  <span class="va">all_books</span> |&gt;
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate.html">separate</a></span><span class="op">(</span><span class="va">title</span>, into <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"title"</span>, <span class="st">"debris"</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"’."</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">debris</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>author <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove_all</a></span><span class="op">(</span><span class="va">author</span>, <span class="st">"^, "</span><span class="op">)</span>,
         author <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_trim.html">str_squish</a></span><span class="op">(</span><span class="va">author</span><span class="op">)</span>,
         title <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove</a></span><span class="op">(</span><span class="va">title</span>, <span class="st">"“"</span><span class="op">)</span>,
         title <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove</a></span><span class="op">(</span><span class="va">title</span>, <span class="st">"^-"</span><span class="op">)</span>
         <span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">all_books</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 × 2</span>
<span class="co">#&gt;   author                               title                </span>
<span class="co">#&gt;   &lt;chr&gt;                                &lt;chr&gt;                </span>
<span class="co">#&gt; 1 Bryant, John, and Junni L. Zhang     Bayesian Demographic…</span>
<span class="co">#&gt; 2 Chan, Ngai Hang                      Time Series          </span>
<span class="co">#&gt; 3 Clark, Greg                          The Son Also Rises   </span>
<span class="co">#&gt; 4 Duflo, Esther                        Expérience, science …</span>
<span class="co">#&gt; 5 Foster, Ghani, Jarmin, Kreuter, Lane Big Data and Social …</span>
<span class="co">#&gt; 6 Francois Chollet with JJ Allaire     Deep Learning with R</span></code></pre></div>
<!-- Finally, some specific cleaning is needed. -->
<!-- ```{r, include = TRUE, eval = TRUE, echo = TRUE} -->
<!-- all_books <- -->
<!--   all_books |> -->
<!--   mutate(author = str_replace_all(author, -->
<!--                               c("J. K. Rowling." = "J K Rowling.", -->
<!--                                 "M. Mitchell Waldrop." = "M Mitchell Waldrop.", -->
<!--                                 "David A. Price" = "David A Price") -->
<!--                               ) -->
<!--          ) |> -->
<!--   separate(author, into = c("author_correct", "throw_away"), sep = "\\.", extra = "drop") |> -->
<!--   select(-throw_away) |> -->
<!--   rename(author = author_correct) -->
<!-- # One has multiple authors: -->
<!-- # "Daniela Witten, Gareth James, Robert Tibshirani, and Trevor Hastie" -->
<!-- all_books <- -->
<!--   all_books |> -->
<!--   mutate(author = str_replace(author, -->
<!--                               "Daniela Witten, Gareth James, Robert Tibshirani, and Trevor Hastie", -->
<!--                               "Daniela Witten and Gareth James and Robert Tibshirani and Trevor Hastie")) |> -->
<!--   separate(author, into = c("author_first", "author_second", "author_third", "author_fourth"), sep = " and ", fill = "right") |> -->
<!--   pivot_longer(cols = starts_with("author_"), -->
<!--                names_to = "author_position", -->
<!--                values_to = "author") |> -->
<!--   select(-author_position) |> -->
<!--   filter(!is.na(author)) -->
<!-- head(all_books) -->
<!-- ``` -->
<p>There are some at the end that we need to get rid of because they are from a ‘best of’.</p>
<div class="sourceCode" id="cb280"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">all_books</span> <span class="op">&lt;-</span> 
  <span class="va">all_books</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">142</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">author</span> <span class="op">!=</span> <span class="st">"‘150 Years of Stats Canada!’."</span><span class="op">)</span></code></pre></div>
<p>Finally, we could make a table of the distribution of the first letter of the names (Table <a href="gather-data.html#tab:lettersofbooks">9.1</a>).</p>
<div class="sourceCode" id="cb281"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">all_books</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
    first_letter <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op">(</span><span class="va">author</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>
    <span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">first_letter</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="op">)</span> |&gt;
  <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span>
    caption <span class="op">=</span> <span class="st">"Distribution of first letter of author names in a collection of books"</span>,
    col.names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"First letter"</span>, <span class="st">"Number of times"</span><span class="op">)</span>,
    booktabs <span class="op">=</span> <span class="cn">TRUE</span>, 
    linesep <span class="op">=</span> <span class="st">""</span>
    <span class="op">)</span></code></pre></div>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:lettersofbooks">Table 9.1: </span>Distribution of first letter of author names in a collection of books</caption>
<thead><tr class="header">
<th align="left">First letter</th>
<th align="right">Number of times</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">⭐</td>
<td align="right">12</td>
</tr>
<tr class="even">
<td align="left">A</td>
<td align="right">6</td>
</tr>
<tr class="odd">
<td align="left">B</td>
<td align="right">8</td>
</tr>
<tr class="even">
<td align="left">C</td>
<td align="right">13</td>
</tr>
<tr class="odd">
<td align="left">D</td>
<td align="right">7</td>
</tr>
<tr class="even">
<td align="left">E</td>
<td align="right">5</td>
</tr>
<tr class="odd">
<td align="left">F</td>
<td align="right">6</td>
</tr>
<tr class="even">
<td align="left">G</td>
<td align="right">13</td>
</tr>
<tr class="odd">
<td align="left">H</td>
<td align="right">6</td>
</tr>
<tr class="even">
<td align="left">I</td>
<td align="right">3</td>
</tr>
<tr class="odd">
<td align="left">J</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">K</td>
<td align="right">3</td>
</tr>
<tr class="odd">
<td align="left">l</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">L</td>
<td align="right">4</td>
</tr>
<tr class="odd">
<td align="left">M</td>
<td align="right">8</td>
</tr>
<tr class="even">
<td align="left">N</td>
<td align="right">2</td>
</tr>
<tr class="odd">
<td align="left">O</td>
<td align="right">4</td>
</tr>
<tr class="even">
<td align="left">P</td>
<td align="right">7</td>
</tr>
<tr class="odd">
<td align="left">R</td>
<td align="right">3</td>
</tr>
<tr class="even">
<td align="left">S</td>
<td align="right">12</td>
</tr>
<tr class="odd">
<td align="left">T</td>
<td align="right">6</td>
</tr>
<tr class="even">
<td align="left">W</td>
<td align="right">9</td>
</tr>
<tr class="odd">
<td align="left">Y</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">Z</td>
<td align="right">1</td>
</tr>
</tbody>
</table></div>
</div>
<div id="case-study-web-scraping-uk-prime-ministers-from-wikipedia" class="section level3" number="9.3.2">
<h3>
<span class="header-section-number">9.3.2</span> Case study: Web scraping UK Prime Ministers from Wikipedia<a class="anchor" aria-label="anchor" href="#case-study-web-scraping-uk-prime-ministers-from-wikipedia"><i class="fas fa-link"></i></a>
</h3>
<p>In this case study we are interested in how long UK prime ministers lived, based on the year that they were born. We will scrape data from Wikipedia using <code>rvest</code> <span class="citation">(<a href="references-1.html#ref-citervest" role="doc-biblioref">Wickham 2019d</a>)</span>, clean it, and then make a graph. Every time we scrape a website things will change. Each scrape will largely be bespoke, even if we can borrow some code from earlier projects. It is completely normal to feel frustrated at times. It helps to begin with an end in mind.</p>
<p>To that end, we can start by generating some simulated data. Ideally, we want a table that has a row for each prime minister, a column for their name, and a column each for the birth and death years. If they are still alive, then that death year can be empty. We know that birth and death years should be somewhere between 1700 and 1990, and that death year should be larger than birth year. Finally, we also know that the years should be integers, and the names should be characters. So, we want something that looks roughly like this:</p>
<div class="sourceCode" id="cb282"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/hadley/babynames">babynames</a></span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">853</span><span class="op">)</span>

<span class="va">simulated_dataset</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>
    prime_minister <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span>
      x <span class="op">=</span> <span class="va">babynames</span> |&gt; <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">prop</span> <span class="op">&gt;</span> <span class="fl">0.01</span><span class="op">)</span> |&gt;
        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">name</span><span class="op">)</span> |&gt; <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="op">)</span> |&gt; <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="op">)</span>,
      size <span class="op">=</span> <span class="fl">10</span>,
      replace <span class="op">=</span> <span class="cn">FALSE</span>
    <span class="op">)</span>,
    birth_year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span>
      x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1700</span><span class="op">:</span><span class="fl">1990</span><span class="op">)</span>,
      size <span class="op">=</span> <span class="fl">10</span>,
      replace <span class="op">=</span> <span class="cn">TRUE</span>
    <span class="op">)</span>,
    years_lived <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span>
      x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">50</span><span class="op">:</span><span class="fl">100</span><span class="op">)</span>,
      size <span class="op">=</span> <span class="fl">10</span>,
      replace <span class="op">=</span> <span class="cn">TRUE</span>
    <span class="op">)</span>,
    death_year <span class="op">=</span> <span class="va">birth_year</span> <span class="op">+</span> <span class="va">years_lived</span>
  <span class="op">)</span> |&gt;
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">prime_minister</span>, <span class="va">birth_year</span>, <span class="va">death_year</span>, <span class="va">years_lived</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">birth_year</span><span class="op">)</span></code></pre></div>
<p>One of the advantages of generating a simulated dataset is that if we are working in groups then one person can start making the graph, using the simulated dataset, while the other person gathers the data. In terms of a graph, we are aiming for something like Figure <a href="gather-data.html#fig:pmsgraphexample">9.10</a>.</p>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:pmsgraphexample"></span>
<img src="figures/pms_graph_plan.png" alt="Sketch of planned graph showing how long UK prime ministers lived" width="90%"><p class="caption">
Figure 9.10: Sketch of planned graph showing how long UK prime ministers lived
</p>
</div>
<p>We are starting with a question that is of interest, which how long each UK prime minister lived. As such, we need to identify a source of data While there are plenty of data sources that have the births and deaths of each prime minister, we want one that we can trust, and as we are going to be scraping, we want one that has some structure to it. The Wikipedia page about UK prime ministers fits both these criteria: <a href="https://en.wikipedia.org/wiki/List_of_prime_ministers_of_the_United_Kingdom" class="uri">https://en.wikipedia.org/wiki/List_of_prime_ministers_of_the_United_Kingdom</a>. As it is a popular page the information is more likely to be correct, and the data are available in a table.</p>
<p>We load <code>rvest</code> and then download the page using <code><a href="http://xml2.r-lib.org/reference/read_xml.html">read_html()</a></code>. Saving it locally provides us with a copy that we need for reproducibility in case the website changes, and also means that we do not have to keep visiting the website. But it is likely not our property, and so this is typically not something that should be necessarily redistributed.</p>
<div class="sourceCode" id="cb283"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rvest.tidyverse.org/">rvest</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb284"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">raw_data</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="http://xml2.r-lib.org/reference/read_xml.html">read_html</a></span><span class="op">(</span><span class="st">"https://en.wikipedia.org/wiki/List_of_prime_ministers_of_the_United_Kingdom"</span><span class="op">)</span>
<span class="fu"><a href="http://xml2.r-lib.org/reference/write_xml.html">write_html</a></span><span class="op">(</span><span class="va">raw_data</span>, <span class="st">"pms.html"</span><span class="op">)</span></code></pre></div>
<p>As with the earlier case study we are looking for patterns in the HTML that we can use to help us get closer to the data that we want. This is an iterative process and requires a lot of trial and error. Even simple examples will take time.</p>
<p>One tool that may help is the SelectorGadget: <a href="https://rvest.tidyverse.org/articles/articles/selectorgadget.html" class="uri">https://rvest.tidyverse.org/articles/articles/selectorgadget.html</a>. This allows us to pick and choose the elements that we want, and then gives us the input to give to <code><a href="https://rvest.tidyverse.org/reference/rename.html">html_nodes()</a></code> (Figure <a href="gather-data.html#fig:selectorgadget">9.11</a>)</p>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:selectorgadget"></span>
<img src="figures/uk_pms.png" alt="Using the Selector Gadget to identify the tag, as at 13 March 2020." width="90%"><p class="caption">
Figure 9.11: Using the Selector Gadget to identify the tag, as at 13 March 2020.
</p>
</div>
<div class="sourceCode" id="cb285"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Read in our saved data</span>
<span class="va">raw_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/read_xml.html">read_html</a></span><span class="op">(</span><span class="st">"pms.html"</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb286"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># We can parse tags in order</span>
<span class="va">parse_data_selector_gadget</span> <span class="op">&lt;-</span> 
  <span class="va">raw_data</span> |&gt; 
  <span class="fu"><a href="https://rvest.tidyverse.org/reference/rename.html">html_nodes</a></span><span class="op">(</span><span class="st">"td:nth-child(3)"</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://rvest.tidyverse.org/reference/html_text.html">html_text</a></span><span class="op">(</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">parse_data_selector_gadget</span><span class="op">)</span>
<span class="co">#&gt; [1] "\nSir Robert Walpole(1676–1745)\n"                       </span>
<span class="co">#&gt; [2] "\nSpencer Compton1st Earl of Wilmington(1673–1743)\n"    </span>
<span class="co">#&gt; [3] "\nHenry Pelham(1694–1754)\n"                             </span>
<span class="co">#&gt; [4] "\nThomas Pelham-Holles1st Duke of Newcastle(1693–1768)\n"</span>
<span class="co">#&gt; [5] "\nWilliam Cavendish4th Duke of Devonshire(1720–1764)\n"  </span>
<span class="co">#&gt; [6] "\nThomas Pelham-Holles1st Duke of Newcastle(1693–1768)\n"</span></code></pre></div>
<p>In this case there is are a few blank lines that we will need to filter away.</p>
<div class="sourceCode" id="cb287"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">parsed_data</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>raw_text <span class="op">=</span> <span class="va">parse_data_selector_gadget</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">raw_text</span> <span class="op">!=</span> <span class="st">"—\n"</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span>
    <span class="op">!</span><span class="va">raw_text</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
      <span class="st">"\n1868\n"</span>,
      <span class="st">"\n1874\n"</span>,
      <span class="st">"\n1880\n"</span>,
      <span class="st">"\n1885\n"</span>,
      <span class="st">"\n1892\n"</span>,
      <span class="st">"\n1979\n"</span>,
      <span class="st">"\n1997\n"</span>,
      <span class="st">"\n2010\n"</span>
    <span class="op">)</span>
  <span class="op">)</span> |&gt;
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span>
    <span class="op">!</span><span class="va">raw_text</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
      <span class="st">"\nNational Labour\n"</span>,
      <span class="st">"\nWilliam Pulteney1st Earl of Bath(1684–1764)\n"</span>,
      <span class="st">"\nJames Waldegrave2nd Earl Waldegrave(1715–1763)\n"</span>,
      <span class="st">"\nEdward VII\n\n\n1901–1910\n\n"</span>, 
      <span class="st">"\nGeorge V\n\n\n1910–1936\n\n"</span>
    <span class="op">)</span>
  <span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">parsed_data</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 × 1</span>
<span class="co">#&gt;   raw_text                                                  </span>
<span class="co">#&gt;   &lt;chr&gt;                                                     </span>
<span class="co">#&gt; 1 "\nSir Robert Walpole(1676–1745)\n"                       </span>
<span class="co">#&gt; 2 "\nSpencer Compton1st Earl of Wilmington(1673–1743)\n"    </span>
<span class="co">#&gt; 3 "\nHenry Pelham(1694–1754)\n"                             </span>
<span class="co">#&gt; 4 "\nThomas Pelham-Holles1st Duke of Newcastle(1693–1768)\n"</span>
<span class="co">#&gt; 5 "\nWilliam Cavendish4th Duke of Devonshire(1720–1764)\n"  </span>
<span class="co">#&gt; 6 "\nThomas Pelham-Holles1st Duke of Newcastle(1693–1768)\n"</span></code></pre></div>
<p>Now that we have the parsed data, we need to clean it to match what we wanted. In particular we want a names column, as well as columns for birth year and death year. We will use <code><a href="https://tidyr.tidyverse.org/reference/separate.html">separate()</a></code> to take advantage of the fact that it looks like the dates are distinguished by brackets.</p>
<div class="sourceCode" id="cb288"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">initial_clean</span> <span class="op">&lt;-</span> 
  <span class="va">parsed_data</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>raw_text <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove_all</a></span><span class="op">(</span><span class="va">raw_text</span>, <span class="st">"\n"</span><span class="op">)</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate.html">separate</a></span><span class="op">(</span><span class="va">raw_text</span>, 
            into <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Name"</span>, <span class="st">"not_name"</span><span class="op">)</span>, 
            sep <span class="op">=</span> <span class="st">"\\("</span>,
            remove <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> |&gt; <span class="co"># The remove = FALSE option here means that we </span>
  <span class="co"># keep the original column that we are separating.</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate.html">separate</a></span><span class="op">(</span><span class="va">not_name</span>, 
            into <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Date"</span>, <span class="st">"all_the_rest"</span><span class="op">)</span>, 
            sep <span class="op">=</span> <span class="st">"\\)"</span>,
            remove <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">initial_clean</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 × 5</span>
<span class="co">#&gt;   raw_text                 Name  not_name Date  all_the_rest</span>
<span class="co">#&gt;   &lt;chr&gt;                    &lt;chr&gt; &lt;chr&gt;    &lt;chr&gt; &lt;chr&gt;       </span>
<span class="co">#&gt; 1 Sir Robert Walpole(1676… Sir … 1676–17… 1676… ""          </span>
<span class="co">#&gt; 2 Spencer Compton1st Earl… Spen… 1673–17… 1673… ""          </span>
<span class="co">#&gt; 3 Henry Pelham(1694–1754)  Henr… 1694–17… 1694… ""          </span>
<span class="co">#&gt; 4 Thomas Pelham-Holles1st… Thom… 1693–17… 1693… ""          </span>
<span class="co">#&gt; 5 William Cavendish4th Du… Will… 1720–17… 1720… ""          </span>
<span class="co">#&gt; 6 Thomas Pelham-Holles1st… Thom… 1693–17… 1693… ""</span></code></pre></div>
<p>Finally, we need to clean up the columns.</p>
<div class="sourceCode" id="cb289"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">initial_clean</span> <span class="op">&lt;-</span> 
 <span class="va">initial_clean</span> |&gt; 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate.html">separate</a></span><span class="op">(</span>col <span class="op">=</span> <span class="va">Name</span>, 
           into <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Name"</span>, <span class="st">"Title"</span><span class="op">)</span>,
           sep <span class="op">=</span> <span class="st">"[[:digit:]]"</span>,
           extra <span class="op">=</span> <span class="st">"merge"</span>,
           fill <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate.html">separate</a></span><span class="op">(</span>col <span class="op">=</span> <span class="va">Name</span>, 
           into <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Name"</span>, <span class="st">"Title"</span><span class="op">)</span>,
           sep <span class="op">=</span> <span class="st">"MP for"</span>,
           extra <span class="op">=</span> <span class="st">"merge"</span>,
           fill <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Name <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove</a></span><span class="op">(</span><span class="va">Name</span>, <span class="st">"\\[b\\]"</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">initial_clean</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 × 6</span>
<span class="co">#&gt;   raw_text           Name  Title not_name Date  all_the_rest</span>
<span class="co">#&gt;   &lt;chr&gt;              &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;    &lt;chr&gt; &lt;chr&gt;       </span>
<span class="co">#&gt; 1 Sir Robert Walpol… Sir … &lt;NA&gt;  1676–17… 1676… ""          </span>
<span class="co">#&gt; 2 Spencer Compton1s… Spen… &lt;NA&gt;  1673–17… 1673… ""          </span>
<span class="co">#&gt; 3 Henry Pelham(1694… Henr… &lt;NA&gt;  1694–17… 1694… ""          </span>
<span class="co">#&gt; 4 Thomas Pelham-Hol… Thom… &lt;NA&gt;  1693–17… 1693… ""          </span>
<span class="co">#&gt; 5 William Cavendish… Will… &lt;NA&gt;  1720–17… 1720… ""          </span>
<span class="co">#&gt; 6 Thomas Pelham-Hol… Thom… &lt;NA&gt;  1693–17… 1693… ""</span></code></pre></div>
<div class="sourceCode" id="cb290"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cleaned_data</span> <span class="op">&lt;-</span> 
  <span class="va">initial_clean</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">Name</span>, <span class="va">Date</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate.html">separate</a></span><span class="op">(</span><span class="va">Date</span>, into <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Birth"</span>, <span class="st">"Died"</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"–"</span>, remove <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> |&gt; <span class="co"># The </span>
  <span class="co"># PMs who have died have their birth and death years separated by a hyphen, but </span>
  <span class="co"># we need to be careful with the hyphen as it seems to be a slightly odd type of </span>
  <span class="co"># hyphen and we need to copy/paste it.</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Birth <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove_all</a></span><span class="op">(</span><span class="va">Birth</span>, <span class="st">"born"</span><span class="op">)</span>,
         Birth <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_trim.html">str_trim</a></span><span class="op">(</span><span class="va">Birth</span><span class="op">)</span>
         <span class="op">)</span> |&gt; <span class="co"># Alive PMs have slightly different format</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">Date</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Name <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove</a></span><span class="op">(</span><span class="va">Name</span>, <span class="st">"\n"</span><span class="op">)</span><span class="op">)</span> |&gt; <span class="co"># Remove some html tags that remain</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html">mutate_at</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html">vars</a></span><span class="op">(</span><span class="va">Birth</span>, <span class="va">Died</span><span class="op">)</span>, <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span> |&gt; <span class="co"># Change birth and death to integers</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Age_at_Death <span class="op">=</span> <span class="va">Died</span> <span class="op">-</span> <span class="va">Birth</span><span class="op">)</span> |&gt;  <span class="co"># Add column of the number of years they lived</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># Some of the PMs had two goes at it.</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">cleaned_data</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 × 4</span>
<span class="co">#&gt;   Name                 Birth  Died Age_at_Death</span>
<span class="co">#&gt;   &lt;chr&gt;                &lt;int&gt; &lt;int&gt;        &lt;int&gt;</span>
<span class="co">#&gt; 1 Sir Robert Walpole    1676  1745           69</span>
<span class="co">#&gt; 2 Spencer Compton       1673  1743           70</span>
<span class="co">#&gt; 3 Henry Pelham          1694  1754           60</span>
<span class="co">#&gt; 4 Thomas Pelham-Holles  1693  1768           75</span>
<span class="co">#&gt; 5 William Cavendish     1720  1764           44</span>
<span class="co">#&gt; 6 John Stuart           1713  1792           79</span></code></pre></div>
<p>Our dataset looks similar to the one that we said we wanted at the start (Table <a href="gather-data.html#tab:canadianpmscleanddata">9.2</a>).</p>
<div class="sourceCode" id="cb291"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cleaned_data</span> |&gt; 
  <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span>
    caption <span class="op">=</span> <span class="st">"UK Prime Ministers, by how old they were when they died"</span>,
    col.names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Prime Minister"</span>, <span class="st">"Birth year"</span>, <span class="st">"Death year"</span>, <span class="st">"Age at death"</span><span class="op">)</span>,
    booktabs <span class="op">=</span> <span class="cn">TRUE</span>, 
    linesep <span class="op">=</span> <span class="st">""</span>
    <span class="op">)</span></code></pre></div>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:canadianpmscleanddata">Table 9.2: </span>UK Prime Ministers, by how old they were when they died</caption>
<thead><tr class="header">
<th align="left">Prime Minister</th>
<th align="right">Birth year</th>
<th align="right">Death year</th>
<th align="right">Age at death</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Sir Robert Walpole</td>
<td align="right">1676</td>
<td align="right">1745</td>
<td align="right">69</td>
</tr>
<tr class="even">
<td align="left">Spencer Compton</td>
<td align="right">1673</td>
<td align="right">1743</td>
<td align="right">70</td>
</tr>
<tr class="odd">
<td align="left">Henry Pelham</td>
<td align="right">1694</td>
<td align="right">1754</td>
<td align="right">60</td>
</tr>
<tr class="even">
<td align="left">Thomas Pelham-Holles</td>
<td align="right">1693</td>
<td align="right">1768</td>
<td align="right">75</td>
</tr>
<tr class="odd">
<td align="left">William Cavendish</td>
<td align="right">1720</td>
<td align="right">1764</td>
<td align="right">44</td>
</tr>
<tr class="even">
<td align="left">John Stuart</td>
<td align="right">1713</td>
<td align="right">1792</td>
<td align="right">79</td>
</tr>
<tr class="odd">
<td align="left">George Grenville</td>
<td align="right">1712</td>
<td align="right">1770</td>
<td align="right">58</td>
</tr>
<tr class="even">
<td align="left">Charles Watson-Wentworth</td>
<td align="right">1730</td>
<td align="right">1782</td>
<td align="right">52</td>
</tr>
<tr class="odd">
<td align="left">William Pitt the Elder</td>
<td align="right">1708</td>
<td align="right">1778</td>
<td align="right">70</td>
</tr>
<tr class="even">
<td align="left">Augustus FitzRoy</td>
<td align="right">1735</td>
<td align="right">1811</td>
<td align="right">76</td>
</tr>
<tr class="odd">
<td align="left">Frederick NorthLord North</td>
<td align="right">1732</td>
<td align="right">1792</td>
<td align="right">60</td>
</tr>
<tr class="even">
<td align="left">William Petty</td>
<td align="right">1737</td>
<td align="right">1805</td>
<td align="right">68</td>
</tr>
<tr class="odd">
<td align="left">William Cavendish-Bentinck</td>
<td align="right">1738</td>
<td align="right">1809</td>
<td align="right">71</td>
</tr>
<tr class="even">
<td align="left">William Pitt the Younger</td>
<td align="right">1759</td>
<td align="right">1806</td>
<td align="right">47</td>
</tr>
<tr class="odd">
<td align="left">Henry Addington</td>
<td align="right">1757</td>
<td align="right">1844</td>
<td align="right">87</td>
</tr>
<tr class="even">
<td align="left">William Grenville</td>
<td align="right">1759</td>
<td align="right">1834</td>
<td align="right">75</td>
</tr>
<tr class="odd">
<td align="left">Spencer Perceval</td>
<td align="right">1762</td>
<td align="right">1812</td>
<td align="right">50</td>
</tr>
<tr class="even">
<td align="left">Robert Jenkinson</td>
<td align="right">1770</td>
<td align="right">1828</td>
<td align="right">58</td>
</tr>
<tr class="odd">
<td align="left">George Canning</td>
<td align="right">1770</td>
<td align="right">1827</td>
<td align="right">57</td>
</tr>
<tr class="even">
<td align="left">F. J. Robinson</td>
<td align="right">1782</td>
<td align="right">1859</td>
<td align="right">77</td>
</tr>
<tr class="odd">
<td align="left">Arthur Wellesley</td>
<td align="right">1769</td>
<td align="right">1852</td>
<td align="right">83</td>
</tr>
<tr class="even">
<td align="left">Charles Grey</td>
<td align="right">1764</td>
<td align="right">1845</td>
<td align="right">81</td>
</tr>
<tr class="odd">
<td align="left">William Lamb</td>
<td align="right">1779</td>
<td align="right">1848</td>
<td align="right">69</td>
</tr>
<tr class="even">
<td align="left">Sir Robert Peel</td>
<td align="right">1788</td>
<td align="right">1850</td>
<td align="right">62</td>
</tr>
<tr class="odd">
<td align="left">Lord John Russell</td>
<td align="right">1792</td>
<td align="right">1878</td>
<td align="right">86</td>
</tr>
<tr class="even">
<td align="left">Edward Smith-Stanley</td>
<td align="right">1799</td>
<td align="right">1869</td>
<td align="right">70</td>
</tr>
<tr class="odd">
<td align="left">George Hamilton-Gordon</td>
<td align="right">1784</td>
<td align="right">1860</td>
<td align="right">76</td>
</tr>
<tr class="even">
<td align="left">Henry John Temple</td>
<td align="right">1784</td>
<td align="right">1865</td>
<td align="right">81</td>
</tr>
<tr class="odd">
<td align="left">John Russell</td>
<td align="right">1792</td>
<td align="right">1878</td>
<td align="right">86</td>
</tr>
<tr class="even">
<td align="left">Benjamin Disraeli</td>
<td align="right">1804</td>
<td align="right">1881</td>
<td align="right">77</td>
</tr>
<tr class="odd">
<td align="left">William Ewart Gladstone</td>
<td align="right">1809</td>
<td align="right">1898</td>
<td align="right">89</td>
</tr>
<tr class="even">
<td align="left">Robert Gascoyne-Cecil</td>
<td align="right">1830</td>
<td align="right">1903</td>
<td align="right">73</td>
</tr>
<tr class="odd">
<td align="left">Archibald Primrose</td>
<td align="right">1847</td>
<td align="right">1929</td>
<td align="right">82</td>
</tr>
<tr class="even">
<td align="left">Arthur Balfour</td>
<td align="right">1848</td>
<td align="right">1930</td>
<td align="right">82</td>
</tr>
<tr class="odd">
<td align="left">Sir Henry Campbell-Bannerman</td>
<td align="right">1836</td>
<td align="right">1908</td>
<td align="right">72</td>
</tr>
<tr class="even">
<td align="left">H. H. Asquith</td>
<td align="right">1852</td>
<td align="right">1928</td>
<td align="right">76</td>
</tr>
<tr class="odd">
<td align="left">David Lloyd George</td>
<td align="right">1863</td>
<td align="right">1945</td>
<td align="right">82</td>
</tr>
<tr class="even">
<td align="left">Bonar Law</td>
<td align="right">1858</td>
<td align="right">1923</td>
<td align="right">65</td>
</tr>
<tr class="odd">
<td align="left">Stanley Baldwin</td>
<td align="right">1867</td>
<td align="right">1947</td>
<td align="right">80</td>
</tr>
<tr class="even">
<td align="left">Ramsay MacDonald</td>
<td align="right">1866</td>
<td align="right">1937</td>
<td align="right">71</td>
</tr>
<tr class="odd">
<td align="left">Neville Chamberlain</td>
<td align="right">1869</td>
<td align="right">1940</td>
<td align="right">71</td>
</tr>
<tr class="even">
<td align="left">Winston Churchill</td>
<td align="right">1874</td>
<td align="right">1965</td>
<td align="right">91</td>
</tr>
<tr class="odd">
<td align="left">Clement Attlee</td>
<td align="right">1883</td>
<td align="right">1967</td>
<td align="right">84</td>
</tr>
<tr class="even">
<td align="left">Sir Winston Churchill</td>
<td align="right">1874</td>
<td align="right">1965</td>
<td align="right">91</td>
</tr>
<tr class="odd">
<td align="left">Sir Anthony Eden</td>
<td align="right">1897</td>
<td align="right">1977</td>
<td align="right">80</td>
</tr>
<tr class="even">
<td align="left">Harold Macmillan</td>
<td align="right">1894</td>
<td align="right">1986</td>
<td align="right">92</td>
</tr>
<tr class="odd">
<td align="left">Sir Alec Douglas-Home</td>
<td align="right">1903</td>
<td align="right">1995</td>
<td align="right">92</td>
</tr>
<tr class="even">
<td align="left">Harold Wilson</td>
<td align="right">1916</td>
<td align="right">1995</td>
<td align="right">79</td>
</tr>
<tr class="odd">
<td align="left">Edward Heath</td>
<td align="right">1916</td>
<td align="right">2005</td>
<td align="right">89</td>
</tr>
<tr class="even">
<td align="left">James Callaghan</td>
<td align="right">1912</td>
<td align="right">2005</td>
<td align="right">93</td>
</tr>
<tr class="odd">
<td align="left">Margaret Thatcher</td>
<td align="right">1925</td>
<td align="right">2013</td>
<td align="right">88</td>
</tr>
<tr class="even">
<td align="left">John Major</td>
<td align="right">1943</td>
<td align="right">NA</td>
<td align="right">NA</td>
</tr>
<tr class="odd">
<td align="left">Tony Blair</td>
<td align="right">1953</td>
<td align="right">NA</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="left">Gordon Brown</td>
<td align="right">1951</td>
<td align="right">NA</td>
<td align="right">NA</td>
</tr>
<tr class="odd">
<td align="left">David Cameron</td>
<td align="right">1966</td>
<td align="right">NA</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="left">Theresa May</td>
<td align="right">1956</td>
<td align="right">NA</td>
<td align="right">NA</td>
</tr>
<tr class="odd">
<td align="left">Boris Johnson</td>
<td align="right">1964</td>
<td align="right">NA</td>
<td align="right">NA</td>
</tr>
</tbody>
</table></div>
<p>At this point we would like to make a graph that illustrates how long each prime minister lived. If they are still alive then we would like them to run to the end, but we would like to color them differently.</p>
<div class="sourceCode" id="cb292"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cleaned_data</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>still_alive <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">Died</span><span class="op">)</span>, <span class="st">"Yes"</span>, <span class="st">"No"</span><span class="op">)</span>,
         Died <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">Died</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="fl">2022</span><span class="op">)</span>, <span class="va">Died</span><span class="op">)</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Name <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/as_factor.html">as_factor</a></span><span class="op">(</span><span class="va">Name</span><span class="op">)</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Birth</span>, 
             xend <span class="op">=</span> <span class="va">Died</span>,
             y <span class="op">=</span> <span class="va">Name</span>,
             yend <span class="op">=</span> <span class="va">Name</span>, 
             color <span class="op">=</span> <span class="va">still_alive</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_segment.html">geom_segment</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Year of birth"</span>,
       y <span class="op">=</span> <span class="st">"Prime minister"</span>,
       color <span class="op">=</span> <span class="st">"PM is alive"</span>,
       title <span class="op">=</span> <span class="st">"How long each UK Prime Minister lived, by year of birth"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_color_brewer</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Set1"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="21-gather_files/figure-html/unnamed-chunk-45-1.png" width="672"></div>
</div>
<div id="case-study-downloading-multiple-files" class="section level3" number="9.3.3">
<h3>
<span class="header-section-number">9.3.3</span> Case study: Downloading multiple files<a class="anchor" aria-label="anchor" href="#case-study-downloading-multiple-files"><i class="fas fa-link"></i></a>
</h3>
<p>Considering text as data is exciting and opens up a lot of different research questions. Many guides assume that we already have a nicely formatted text dataset, but that is rarely actually the case. In this case study we will download files from a few different pages. While we have already seen two examples of web scraping, those were focused on just one page, whereas we often need many. Here we will focus on this iteration. We will use <code><a href="https://rdrr.io/r/utils/download.file.html">download.file()</a></code> to do the download, and <code>purrr</code> <span class="citation">(<a href="references-1.html#ref-citepurrr" role="doc-biblioref">Henry and Wickham 2020</a>)</span> to apply this function across multiple sites.</p>
<p>The Reserve Bank of Australia (RBA) is Australia’s central bank and sets monetary policy. It has responsibility for setting the cash rate, which is the interest rate used for loans between banks. This interest rate is an especially important one, and has a large impact on the other interest rates in the economy. Four times a year – February, May, August, and November – the RBA publishes a statement on monetary policy, and these are available as PDFs. In this example we will download the four statements published in 2021.</p>
<p>First we set-up a dataframe that has the information that we need.</p>
<div class="sourceCode" id="cb293"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>

<span class="va">statements_of_interest</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>
    address <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"https://www.rba.gov.au/publications/smp/2021/nov/pdf/00-overview.pdf"</span>,
                <span class="st">"https://www.rba.gov.au/publications/smp/2021/aug/pdf/00-overview.pdf"</span>,
                <span class="st">"https://www.rba.gov.au/publications/smp/2021/may/pdf/00-overview.pdf"</span>,
                <span class="st">"https://www.rba.gov.au/publications/smp/2021/feb/pdf/00-overview.pdf"</span>
                <span class="op">)</span>,
    local_save_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
      <span class="st">"2021-11.pdf"</span>,
      <span class="st">"2021-08.pdf"</span>,
      <span class="st">"2021-05.pdf"</span>,
      <span class="st">"2021-02.pdf"</span>
    <span class="op">)</span>
  <span class="op">)</span>

<span class="va">statements_of_interest</span>
<span class="co">#&gt; # A tibble: 4 × 2</span>
<span class="co">#&gt;   address                                    local_save_name</span>
<span class="co">#&gt;   &lt;chr&gt;                                      &lt;chr&gt;          </span>
<span class="co">#&gt; 1 https://www.rba.gov.au/publications/smp/2… 2021-11.pdf    </span>
<span class="co">#&gt; 2 https://www.rba.gov.au/publications/smp/2… 2021-08.pdf    </span>
<span class="co">#&gt; 3 https://www.rba.gov.au/publications/smp/2… 2021-05.pdf    </span>
<span class="co">#&gt; 4 https://www.rba.gov.au/publications/smp/2… 2021-02.pdf</span></code></pre></div>
<p>Then we can apply the function <code>download.files()</code> to these four</p>
<p>Then we can write a function that will download the file, let us know that it was downloaded, wait a polite amount of time, and then go get the next file.</p>
<div class="sourceCode" id="cb294"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">visit_download_and_wait</span> <span class="op">&lt;-</span>
  <span class="kw">function</span><span class="op">(</span><span class="va">the_address_to_visit</span>, <span class="va">where_to_save_it_locally</span><span class="op">)</span> <span class="op">{</span>
    
    <span class="fu"><a href="https://rdrr.io/r/utils/download.file.html">download.file</a></span><span class="op">(</span>url <span class="op">=</span> <span class="va">the_address_to_visit</span>,
                  destfile <span class="op">=</span> <span class="va">where_to_save_it_locally</span>
                  <span class="op">)</span>

    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Done with"</span>, <span class="va">the_address_to_visit</span>, <span class="st">"at"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
    
    <span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html">Sys.sleep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">5</span><span class="op">:</span><span class="fl">10</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span></code></pre></div>
<p>We now apply that function to our list of URLs.</p>
<div class="sourceCode" id="cb295"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html">walk2</a></span><span class="op">(</span><span class="va">statements_of_interest</span><span class="op">$</span><span class="va">address</span>,
      <span class="va">statements_of_interest</span><span class="op">$</span><span class="va">local_save_name</span>,
      <span class="op">~</span><span class="fu">visit_download_and_wait</span><span class="op">(</span><span class="va">.x</span>, <span class="va">.y</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>The result is that we have downloaded these four PDFs and saved them to our computer. In the next section we will build on this to discuss getting information from these PDFs.</p>
</div>
</div>
<div id="pdfs" class="section level2" number="9.4">
<h2>
<span class="header-section-number">9.4</span> PDFs<a class="anchor" aria-label="anchor" href="#pdfs"><i class="fas fa-link"></i></a>
</h2>
<p>In contrast to an API, a PDF is usually only produced for human rather than computer consumption. The nice thing about PDFs is that they are static and constant. And it is nice that they make data available at all. But the trade-off is that:</p>
<ul>
<li>It is not overly useful to do larger-scale statistical analysis.</li>
<li>We do not know how the PDF was put together so we do not know whether we can trust it.</li>
<li>We cannot manipulate the data to get results that we are interested in.</li>
</ul>
<p>Indeed, sometimes governments publish data as PDFs because they do not actually want us to be able to analyze it. Being able to get data from PDFs opens up a large number of datasets.</p>
<p>There are two important aspects to keep in mind when approaching a PDF with a mind to extracting data from it:</p>
<ol style="list-style-type: decimal">
<li>Begin with an end in mind. Planning and then literally sketching out what we want from a final dataset/graph/paper stops us wasting time and keeps us focused.</li>
<li>Start simple, then iterate. The quickest way to make a complicated model is often to first build a simple model and then complicate it. Start with just trying to get one page of the PDF working or even just one line. Then iterate from there.</li>
</ol>
<p>We will start by walking through several examples and then go through a case study where we will gather data on US Total Fertility Rate, by state.</p>
<p>Figure <a href="gather-data.html#fig:firstpdfexample">9.12</a> is a PDF that consists of just the first sentence from Jane Eyre taken from Project Gutenberg <span class="citation">(<a href="references-1.html#ref-janeeyre" role="doc-biblioref">Bronte 1847</a>)</span>.</p>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:firstpdfexample"></span>
<img src="inputs/pdfs/first_example.png" alt="First sentence of Jane Eyre" width="90%"><p class="caption">
Figure 9.12: First sentence of Jane Eyre
</p>
</div>
<p>If assume that it was saved as ‘first_example.pdf’, then we can <code>pdftools</code> <span class="citation">(<a href="references-1.html#ref-citepdftools" role="doc-biblioref">Ooms 2019a</a>)</span> to get the text from this one-page PDF into R.</p>
<div class="sourceCode" id="cb296"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/pdftools/">pdftools</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>

<span class="va">first_example</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/pdftools/reference/pdftools.html">pdf_text</a></span><span class="op">(</span><span class="st">"first_example.pdf"</span><span class="op">)</span>

<span class="va">first_example</span>

<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">first_example</span><span class="op">)</span></code></pre></div>
<p>We can see that the PDF has been correctly read in, as a character vector.</p>
<p>We will now try a slightly more complicated example that consists of the first few paragraphs of Jane Eyre (Figure <a href="gather-data.html#fig:secondpdfexample">9.13</a>). Also notice that now we have the chapter heading as well.</p>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:secondpdfexample"></span>
<img src="inputs/pdfs/second_example.png" alt="First few paragraphs of Jane Eyre" width="90%"><p class="caption">
Figure 9.13: First few paragraphs of Jane Eyre
</p>
</div>
<p>We use the same function as before.</p>
<div class="sourceCode" id="cb297"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">second_example</span> <span class="op">&lt;-</span> <span class="fu">pdftools</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/pdftools/reference/pdftools.html">pdf_text</a></span><span class="op">(</span><span class="st">"second_example.pdf"</span><span class="op">)</span>

<span class="va">second_example</span>

<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">second_example</span><span class="op">)</span></code></pre></div>
<p>Again, we have a character vector. The end of each line is signaled by ‘\n’, but other than that it looks pretty good. Finally, we consider the first two pages.</p>
<div class="sourceCode" id="cb298"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">third_example</span> <span class="op">&lt;-</span> <span class="fu">pdftools</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/pdftools/reference/pdftools.html">pdf_text</a></span><span class="op">(</span><span class="st">"third_example.pdf"</span><span class="op">)</span>

<span class="va">third_example</span>

<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">third_example</span><span class="op">)</span></code></pre></div>
<p>Notice that the first page is the first element of the character vector, and the second page is the second element. As we are most familiar with rectangular data, we will try to get it into that format as quickly as possible. And then we can use our regular <code>tidyverse</code> functions to deal with it.</p>
<p>First we want to convert the character vector into a tibble. At this point we may like to add page numbers as well.</p>
<div class="sourceCode" id="cb299"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">jane_eyre</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>raw_text <span class="op">=</span> <span class="va">third_example</span>,
                    page_number <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>We then want to separate the lines so that each line is an observation. We can do that by looking for ‘\n’ remembering that we need to escape the backslash as it is a special character.</p>
<div class="sourceCode" id="cb300"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">jane_eyre</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate_rows.html">separate_rows</a></span><span class="op">(</span><span class="va">jane_eyre</span>, <span class="va">raw_text</span>, sep <span class="op">=</span> <span class="st">"\\n"</span>, convert <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="va">jane_eyre</span>
<span class="co">#&gt; # A tibble: 93 × 2</span>
<span class="co">#&gt;    raw_text                                      page_number</span>
<span class="co">#&gt;    &lt;chr&gt;                                               &lt;int&gt;</span>
<span class="co">#&gt;  1 "CHAPTER I"                                             1</span>
<span class="co">#&gt;  2 "There was no possibility of taking a walk t…           1</span>
<span class="co">#&gt;  3 "leafless shrubbery an hour in the morning; …           1</span>
<span class="co">#&gt;  4 "company, dined early) the cold winter wind …           1</span>
<span class="co">#&gt;  5 "penetrating, that further out-door exercise…           1</span>
<span class="co">#&gt;  6 ""                                                      1</span>
<span class="co">#&gt;  7 "I was glad of it: I never liked long walks,…           1</span>
<span class="co">#&gt;  8 "coming home in the raw twilight, with nippe…           1</span>
<span class="co">#&gt;  9 "chidings of Bessie, the nurse, and humbled …           1</span>
<span class="co">#&gt; 10 "Eliza, John, and Georgiana Reed."                      1</span>
<span class="co">#&gt; # … with 83 more rows</span></code></pre></div>
<div id="case-study-gathering-data-on-the-us-total-fertility-rate" class="section level3" number="9.4.1">
<h3>
<span class="header-section-number">9.4.1</span> Case-study: Gathering data on the US Total Fertility Rate<a class="anchor" aria-label="anchor" href="#case-study-gathering-data-on-the-us-total-fertility-rate"><i class="fas fa-link"></i></a>
</h3>
<p>The US Department of Health and Human Services Vital Statistics Report provides information about the total fertility rate (the average number of births per woman if women experience the current age-specific fertility rates throughout their reproductive years) for each state for nineteen years. The US persists in only making this data available in PDFs, which hinders research. But we can use the approaches above to get the data into a nice dataset.</p>
<p>For instance, in the case of the year 2000 the table that we are interested in is on page 40 of a PDF that is available at <a href="https://www.cdc.gov/nchs/data/nvsr/nvsr50/nvsr50_05.pdf" class="uri">https://www.cdc.gov/nchs/data/nvsr/nvsr50/nvsr50_05.pdf</a>. The column of interest is labelled: “Total fertility rate” (Figure <a href="gather-data.html#fig:dhsexample">9.14</a>).</p>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:dhsexample"></span>
<img src="figures/dhs_example.png" alt="Example Vital Statistics Report, from 2000" width="90%"><p class="caption">
Figure 9.14: Example Vital Statistics Report, from 2000
</p>
</div>
<p>The first step when getting data out of a PDF is to sketch out what we eventually want. A PDF typically contains a lot of information, and so it is handy to be very clear about what you need. This helps keep you focused, and prevents scope creep, but it is also helpful when thinking about data checks. We literally write down on paper what we have in mind. In this case, what is needed is a table with a column for state, year and TFR (Figure <a href="gather-data.html#fig:tfrdesired">9.15</a>).</p>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:tfrdesired"></span>
<img src="figures/tfr_dataset_sketch.png" alt="Planned dataset of TFR for each year and US state" width="40%"><p class="caption">
Figure 9.15: Planned dataset of TFR for each year and US state
</p>
</div>
<p>There are 19 different PDFs, and we are interested in a particular column in a particular table in each of them. Unfortunately, there is nothing magical about what is coming. This first step requires working out the link for each, and the page and column name that is of interest. In the end, this looks like this.</p>
<div class="sourceCode" id="cb301"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">summary_tfr_dataset</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">page</span>, <span class="va">table</span>, <span class="va">column_name</span>, <span class="va">url</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://gt.rstudio.com/reference/gt.html">gt</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div id="bnapnipxev" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#bnapnipxev .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#bnapnipxev .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#bnapnipxev .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#bnapnipxev .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 6px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#bnapnipxev .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#bnapnipxev .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#bnapnipxev .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#bnapnipxev .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#bnapnipxev .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#bnapnipxev .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#bnapnipxev .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#bnapnipxev .gt_group_heading {
  padding: 8px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

#bnapnipxev .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#bnapnipxev .gt_from_md > :first-child {
  margin-top: 0;
}

#bnapnipxev .gt_from_md > :last-child {
  margin-bottom: 0;
}

#bnapnipxev .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#bnapnipxev .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 12px;
}

#bnapnipxev .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#bnapnipxev .gt_first_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
}

#bnapnipxev .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#bnapnipxev .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#bnapnipxev .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#bnapnipxev .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#bnapnipxev .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#bnapnipxev .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding: 4px;
}

#bnapnipxev .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#bnapnipxev .gt_sourcenote {
  font-size: 90%;
  padding: 4px;
}

#bnapnipxev .gt_left {
  text-align: left;
}

#bnapnipxev .gt_center {
  text-align: center;
}

#bnapnipxev .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#bnapnipxev .gt_font_normal {
  font-weight: normal;
}

#bnapnipxev .gt_font_bold {
  font-weight: bold;
}

#bnapnipxev .gt_font_italic {
  font-style: italic;
}

#bnapnipxev .gt_super {
  font-size: 65%;
}

#bnapnipxev .gt_footnote_marks {
  font-style: italic;
  font-weight: normal;
  font-size: 65%;
}
</style>
<div class="inline-table"><table class="gt_table">
<thead class="gt_col_headings"><tr>
<th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">year</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">page</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">table</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">column_name</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">url</th>
    </tr></thead>
<tbody class="gt_table_body">
<tr>
<td class="gt_row gt_right">2000</td>
<td class="gt_row gt_right">40</td>
<td class="gt_row gt_right">10</td>
<td class="gt_row gt_left">Total fertility rate</td>
<td class="gt_row gt_left">https://www.cdc.gov/nchs/data/nvsr/nvsr50/nvsr50_05.pdf</td>
</tr>
<tr>
<td class="gt_row gt_right">2001</td>
<td class="gt_row gt_right">41</td>
<td class="gt_row gt_right">10</td>
<td class="gt_row gt_left">Total fertility rate</td>
<td class="gt_row gt_left">https://www.cdc.gov/nchs/data/nvsr/nvsr51/nvsr51_02.pdf</td>
</tr>
<tr>
<td class="gt_row gt_right">2002</td>
<td class="gt_row gt_right">46</td>
<td class="gt_row gt_right">10</td>
<td class="gt_row gt_left">Total fertility rate</td>
<td class="gt_row gt_left">https://www.cdc.gov/nchs/data/nvsr/nvsr52/nvsr52_10.pdf</td>
</tr>
<tr>
<td class="gt_row gt_right">2003</td>
<td class="gt_row gt_right">45</td>
<td class="gt_row gt_right">10</td>
<td class="gt_row gt_left">Total fertility rate</td>
<td class="gt_row gt_left">https://www.cdc.gov/nchs/data/nvsr/nvsr54/nvsr54_02.pdf</td>
</tr>
<tr>
<td class="gt_row gt_right">2004</td>
<td class="gt_row gt_right">52</td>
<td class="gt_row gt_right">11</td>
<td class="gt_row gt_left">Total fertility rate</td>
<td class="gt_row gt_left">https://www.cdc.gov/nchs/data/nvsr/nvsr55/nvsr55_01.pdf</td>
</tr>
<tr>
<td class="gt_row gt_right">2005</td>
<td class="gt_row gt_right">52</td>
<td class="gt_row gt_right">11</td>
<td class="gt_row gt_left">Total fertility rate</td>
<td class="gt_row gt_left">https://www.cdc.gov/nchs/data/nvsr/nvsr56/nvsr56_06.pdf</td>
</tr>
<tr>
<td class="gt_row gt_right">2006</td>
<td class="gt_row gt_right">49</td>
<td class="gt_row gt_right">11</td>
<td class="gt_row gt_left">Total fertility rate</td>
<td class="gt_row gt_left">https://www.cdc.gov/nchs/data/nvsr/nvsr57/nvsr57_07.pdf</td>
</tr>
<tr>
<td class="gt_row gt_right">2007</td>
<td class="gt_row gt_right">41</td>
<td class="gt_row gt_right">11</td>
<td class="gt_row gt_left">Total fertility rate</td>
<td class="gt_row gt_left">https://www.cdc.gov/nchs/data/nvsr/nvsr58/nvsr58_24.pdf</td>
</tr>
<tr>
<td class="gt_row gt_right">2008</td>
<td class="gt_row gt_right">43</td>
<td class="gt_row gt_right">12</td>
<td class="gt_row gt_left">Total fertility rate</td>
<td class="gt_row gt_left">https://www.cdc.gov/nchs/data/nvsr/nvsr59/nvsr59_01.pdf</td>
</tr>
<tr>
<td class="gt_row gt_right">2009</td>
<td class="gt_row gt_right">43</td>
<td class="gt_row gt_right">12</td>
<td class="gt_row gt_left">Total fertility rate</td>
<td class="gt_row gt_left">https://www.cdc.gov/nchs/data/nvsr/nvsr60/nvsr60_01.pdf</td>
</tr>
<tr>
<td class="gt_row gt_right">2010</td>
<td class="gt_row gt_right">42</td>
<td class="gt_row gt_right">12</td>
<td class="gt_row gt_left">Total fertility rate</td>
<td class="gt_row gt_left">https://www.cdc.gov/nchs/data/nvsr/nvsr61/nvsr61_01.pdf</td>
</tr>
<tr>
<td class="gt_row gt_right">2011</td>
<td class="gt_row gt_right">40</td>
<td class="gt_row gt_right">12</td>
<td class="gt_row gt_left">Total fertility rate</td>
<td class="gt_row gt_left">https://www.cdc.gov/nchs/data/nvsr/nvsr62/nvsr62_01.pdf</td>
</tr>
<tr>
<td class="gt_row gt_right">2012</td>
<td class="gt_row gt_right">38</td>
<td class="gt_row gt_right">12</td>
<td class="gt_row gt_left">Total fertility rate</td>
<td class="gt_row gt_left">https://www.cdc.gov/nchs/data/nvsr/nvsr62/nvsr62_09.pdf</td>
</tr>
<tr>
<td class="gt_row gt_right">2013</td>
<td class="gt_row gt_right">37</td>
<td class="gt_row gt_right">12</td>
<td class="gt_row gt_left">Total fertility rate</td>
<td class="gt_row gt_left">https://www.cdc.gov/nchs/data/nvsr/nvsr64/nvsr64_01.pdf</td>
</tr>
<tr>
<td class="gt_row gt_right">2014</td>
<td class="gt_row gt_right">38</td>
<td class="gt_row gt_right">12</td>
<td class="gt_row gt_left">Total fertility rate</td>
<td class="gt_row gt_left">https://www.cdc.gov/nchs/data/nvsr/nvsr64/nvsr64_12.pdf</td>
</tr>
<tr>
<td class="gt_row gt_right">2015</td>
<td class="gt_row gt_right">42</td>
<td class="gt_row gt_right">12</td>
<td class="gt_row gt_left">Total fertility rate</td>
<td class="gt_row gt_left">https://www.cdc.gov/nchs/data/nvsr/nvsr66/nvsr66_01.pdf</td>
</tr>
<tr>
<td class="gt_row gt_right">2016</td>
<td class="gt_row gt_right">29</td>
<td class="gt_row gt_right">8</td>
<td class="gt_row gt_left">Total fertility rate</td>
<td class="gt_row gt_left">https://www.cdc.gov/nchs/data/nvsr/nvsr67/nvsr67_01.pdf</td>
</tr>
<tr>
<td class="gt_row gt_right">2016</td>
<td class="gt_row gt_right">30</td>
<td class="gt_row gt_right">8</td>
<td class="gt_row gt_left">Total fertility rate</td>
<td class="gt_row gt_left">https://www.cdc.gov/nchs/data/nvsr/nvsr67/nvsr67_01.pdf</td>
</tr>
<tr>
<td class="gt_row gt_right">2017</td>
<td class="gt_row gt_right">23</td>
<td class="gt_row gt_right">12</td>
<td class="gt_row gt_left">Total fertility rate</td>
<td class="gt_row gt_left">https://www.cdc.gov/nchs/data/nvsr/nvsr67/nvsr67_08-508.pdf</td>
</tr>
<tr>
<td class="gt_row gt_right">2017</td>
<td class="gt_row gt_right">24</td>
<td class="gt_row gt_right">12</td>
<td class="gt_row gt_left">Total fertility rate</td>
<td class="gt_row gt_left">https://www.cdc.gov/nchs/data/nvsr/nvsr67/nvsr67_08-508.pdf</td>
</tr>
<tr>
<td class="gt_row gt_right">2018</td>
<td class="gt_row gt_right">23</td>
<td class="gt_row gt_right">12</td>
<td class="gt_row gt_left">Total fertility rate</td>
<td class="gt_row gt_left">https://www.cdc.gov/nchs/data/nvsr/nvsr68/nvsr68_13-508.pdf</td>
</tr>
</tbody>
</table></div>
</div>
<p>The first step is to get some code that works for one of them. I’ll step through the code in a lot more detail than normal because we’re going to use these pieces a lot.</p>
<p>We will choose the year 2000. We first download and save the PDF using <code><a href="https://rdrr.io/r/utils/download.file.html">download.file()</a></code>.</p>
<div class="sourceCode" id="cb302"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/download.file.html">download.file</a></span><span class="op">(</span>url <span class="op">=</span> <span class="va">summary_tfr_dataset</span><span class="op">$</span><span class="va">url</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, 
              destfile <span class="op">=</span> <span class="st">"year_2000.pdf"</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb303"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># INTERNAL</span>
<span class="fu"><a href="https://rdrr.io/r/utils/download.file.html">download.file</a></span><span class="op">(</span>url <span class="op">=</span> <span class="va">summary_tfr_dataset</span><span class="op">$</span><span class="va">url</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, 
              destfile <span class="op">=</span> <span class="st">"inputs/pdfs/dhs/year_2000.pdf"</span><span class="op">)</span></code></pre></div>
<p>We then read the PDF in as a character vector using <code><a href="https://docs.ropensci.org/pdftools/reference/pdftools.html">pdf_text()</a></code> from <code>pdftools</code>. And then convert it to a tibble, so that we can use familiar verbs on it.</p>
<div class="sourceCode" id="cb304"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/pdftools/">pdftools</a></span><span class="op">)</span>
<span class="va">dhs_2000</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/pdftools/reference/pdftools.html">pdf_text</a></span><span class="op">(</span><span class="st">"year_2000.pdf"</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb305"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dhs_2000</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>raw_data <span class="op">=</span> <span class="va">dhs_2000</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">dhs_2000</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 × 1</span>
<span class="co">#&gt;   raw_data                                                  </span>
<span class="co">#&gt;   &lt;chr&gt;                                                     </span>
<span class="co">#&gt; 1 "Volume 50, Number 5                                     …</span>
<span class="co">#&gt; 2 "2   National Vital Statistics Report, Vol. 50, No. 5, Fe…</span>
<span class="co">#&gt; 3 "                                                        …</span>
<span class="co">#&gt; 4 "4   National Vital Statistics Report, Vol. 50, No. 5, Fe…</span>
<span class="co">#&gt; 5 "                                                        …</span>
<span class="co">#&gt; 6 "6   National Vital Statistics Report, Vol. 50, No. 5, Fe…</span></code></pre></div>
<p>Grab the page that is of interest (remembering that each page is a element of the character vector, hence a row in the tibble).</p>
<div class="sourceCode" id="cb306"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dhs_2000</span> <span class="op">&lt;-</span> 
  <span class="va">dhs_2000</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="va">summary_tfr_dataset</span><span class="op">$</span><span class="va">page</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">dhs_2000</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 1 × 1</span>
<span class="co">#&gt;   raw_data                                                  </span>
<span class="co">#&gt;   &lt;chr&gt;                                                     </span>
<span class="co">#&gt; 1 "40 National Vital Statistics Report, Vol. 50, No. 5, Rev…</span></code></pre></div>
<p>Now we want to separate the rows.</p>
<div class="sourceCode" id="cb307"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dhs_2000</span> <span class="op">&lt;-</span> 
  <span class="va">dhs_2000</span> |&gt; 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate_rows.html">separate_rows</a></span><span class="op">(</span><span class="va">raw_data</span>, sep <span class="op">=</span> <span class="st">"\\n"</span>, convert <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">dhs_2000</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 × 1</span>
<span class="co">#&gt;   raw_data                                                  </span>
<span class="co">#&gt;   &lt;chr&gt;                                                     </span>
<span class="co">#&gt; 1 "40 National Vital Statistics Report, Vol. 50, No. 5, Rev…</span>
<span class="co">#&gt; 2 ""                                                        </span>
<span class="co">#&gt; 3 "Table 10. Number of births, birth rates, fertility rates…</span>
<span class="co">#&gt; 4 "United States, each State and territory, 2000"           </span>
<span class="co">#&gt; 5 "[By place of residence. Birth rates are live births per …</span>
<span class="co">#&gt; 6 "estimated in each area; total fertility rates are sums o…</span></code></pre></div>
<p>Now we are searching for patterns that we can use. Let us look at the first ten lines of content.</p>
<div class="sourceCode" id="cb308"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dhs_2000</span><span class="op">[</span><span class="fl">13</span><span class="op">:</span><span class="fl">22</span>,<span class="op">]</span>
<span class="co">#&gt; # A tibble: 10 × 1</span>
<span class="co">#&gt;    raw_data                                                 </span>
<span class="co">#&gt;    &lt;chr&gt;                                                    </span>
<span class="co">#&gt;  1 "                                  State                …</span>
<span class="co">#&gt;  2 "                                                       …</span>
<span class="co">#&gt;  3 "                                                       …</span>
<span class="co">#&gt;  4 ""                                                       </span>
<span class="co">#&gt;  5 ""                                                       </span>
<span class="co">#&gt;  6 "United States 1 .......................................…</span>
<span class="co">#&gt;  7 ""                                                       </span>
<span class="co">#&gt;  8 "Alabama ...............................................…</span>
<span class="co">#&gt;  9 "Alaska ................................................…</span>
<span class="co">#&gt; 10 "Arizona ...............................................…</span></code></pre></div>
<p>It does not get much better than this:</p>
<ol style="list-style-type: decimal">
<li>We have dots separating the states from the data.</li>
<li>We have a space between each of the columns.</li>
</ol>
<p>So we can now separate this in to separate columns. First we want to match on when there is at least two dots (remembering that the dot is a special character and so needs to be escaped).</p>
<div class="sourceCode" id="cb309"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dhs_2000</span> <span class="op">&lt;-</span> 
  <span class="va">dhs_2000</span> |&gt; 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate.html">separate</a></span><span class="op">(</span>col <span class="op">=</span> <span class="va">raw_data</span>, 
           into <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"state"</span>, <span class="st">"data"</span><span class="op">)</span>, 
           sep <span class="op">=</span> <span class="st">"\\.{2,}"</span>, 
           remove <span class="op">=</span> <span class="cn">FALSE</span>,
           fill <span class="op">=</span> <span class="st">"right"</span>
           <span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">dhs_2000</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 × 3</span>
<span class="co">#&gt;   raw_data                                       state data </span>
<span class="co">#&gt;   &lt;chr&gt;                                          &lt;chr&gt; &lt;chr&gt;</span>
<span class="co">#&gt; 1 "40 National Vital Statistics Report, Vol. 50… "40 … &lt;NA&gt; </span>
<span class="co">#&gt; 2 ""                                             ""    &lt;NA&gt; </span>
<span class="co">#&gt; 3 "Table 10. Number of births, birth rates, fer… "Tab… &lt;NA&gt; </span>
<span class="co">#&gt; 4 "United States, each State and territory, 200… "Uni… &lt;NA&gt; </span>
<span class="co">#&gt; 5 "[By place of residence. Birth rates are live… "[By… &lt;NA&gt; </span>
<span class="co">#&gt; 6 "estimated in each area; total fertility rate… "est… &lt;NA&gt;</span></code></pre></div>
<p>We get the expected warnings about the top and the bottom as they do not have multiple dots. (Another option here is to use <code><a href="https://docs.ropensci.org/pdftools/reference/pdftools.html">pdf_data()</a></code> which would allow us to use location rather than delimiters.)</p>
<p>We can now separate the data based on spaces. There is an inconsistent number of spaces, so we first squish any example of more than one space into just one.</p>
<div class="sourceCode" id="cb310"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dhs_2000</span> <span class="op">&lt;-</span> 
  <span class="va">dhs_2000</span> |&gt;
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_trim.html">str_squish</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span> |&gt; 
  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate.html">separate</a></span><span class="op">(</span>col <span class="op">=</span> <span class="va">data</span>, 
           into <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"number_of_births"</span>, 
                    <span class="st">"birth_rate"</span>, 
                    <span class="st">"fertility_rate"</span>, 
                    <span class="st">"TFR"</span>, 
                    <span class="st">"teen_births_all"</span>, 
                    <span class="st">"teen_births_15_17"</span>, 
                    <span class="st">"teen_births_18_19"</span><span class="op">)</span>, 
           sep <span class="op">=</span> <span class="st">"\\s"</span>, 
           remove <span class="op">=</span> <span class="cn">FALSE</span>
           <span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">dhs_2000</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 × 10</span>
<span class="co">#&gt;   raw_data           state data  number_of_births birth_rate</span>
<span class="co">#&gt;   &lt;chr&gt;              &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;            &lt;chr&gt;     </span>
<span class="co">#&gt; 1 "40 National Vita… "40 … &lt;NA&gt;  &lt;NA&gt;             &lt;NA&gt;      </span>
<span class="co">#&gt; 2 ""                 ""    &lt;NA&gt;  &lt;NA&gt;             &lt;NA&gt;      </span>
<span class="co">#&gt; 3 "Table 10. Number… "Tab… &lt;NA&gt;  &lt;NA&gt;             &lt;NA&gt;      </span>
<span class="co">#&gt; 4 "United States, e… "Uni… &lt;NA&gt;  &lt;NA&gt;             &lt;NA&gt;      </span>
<span class="co">#&gt; 5 "[By place of res… "[By… &lt;NA&gt;  &lt;NA&gt;             &lt;NA&gt;      </span>
<span class="co">#&gt; 6 "estimated in eac… "est… &lt;NA&gt;  &lt;NA&gt;             &lt;NA&gt;      </span>
<span class="co">#&gt; # … with 5 more variables: fertility_rate &lt;chr&gt;, TFR &lt;chr&gt;,</span>
<span class="co">#&gt; #   teen_births_all &lt;chr&gt;, teen_births_15_17 &lt;chr&gt;,</span>
<span class="co">#&gt; #   teen_births_18_19 &lt;chr&gt;</span></code></pre></div>
<p>This is all looking fairly great. The only thing left is to clean up.</p>
<div class="sourceCode" id="cb311"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dhs_2000</span> <span class="op">&lt;-</span> 
  <span class="va">dhs_2000</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">TFR</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="fl">13</span><span class="op">:</span><span class="fl">69</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fl">2000</span><span class="op">)</span>

<span class="va">dhs_2000</span>
<span class="co">#&gt; # A tibble: 57 × 3</span>
<span class="co">#&gt;    state                                         TFR    year</span>
<span class="co">#&gt;    &lt;chr&gt;                                         &lt;chr&gt; &lt;dbl&gt;</span>
<span class="co">#&gt;  1 "                                  State    … &lt;NA&gt;   2000</span>
<span class="co">#&gt;  2 "                                           … &lt;NA&gt;   2000</span>
<span class="co">#&gt;  3 "                                           … &lt;NA&gt;   2000</span>
<span class="co">#&gt;  4 ""                                            &lt;NA&gt;   2000</span>
<span class="co">#&gt;  5 ""                                            &lt;NA&gt;   2000</span>
<span class="co">#&gt;  6 "United States 1 "                            2,13…  2000</span>
<span class="co">#&gt;  7 ""                                            &lt;NA&gt;   2000</span>
<span class="co">#&gt;  8 "Alabama "                                    2,02…  2000</span>
<span class="co">#&gt;  9 "Alaska "                                     2,43…  2000</span>
<span class="co">#&gt; 10 "Arizona "                                    2,65…  2000</span>
<span class="co">#&gt; # … with 47 more rows</span></code></pre></div>
<p>And we’re done for that year. Now we want to take these pieces, put them into a function and then run that function over all 19 years.</p>
<p>The first part is downloading each of the 19 PDFs that we need. We are going to build on the code that we used before. That code was:</p>
<div class="sourceCode" id="cb312"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/download.file.html">download.file</a></span><span class="op">(</span>url <span class="op">=</span> <span class="va">summary_tfr_dataset</span><span class="op">$</span><span class="va">url</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, destfile <span class="op">=</span> <span class="st">"year_2000.pdf"</span><span class="op">)</span></code></pre></div>
<p>To modify this we need:</p>
<ol style="list-style-type: decimal">
<li>To have it iterate through each of the lines in the dataset that contains our CSVs (i.e. where it says 1, we want 1, then 2, then 3, etc.).</li>
<li>Where it has a filename, we need it to iterate through our desired filenames (i.e. year_2000, then year_2001, then year_2002, etc).</li>
<li>We would like for it to do all of this in a way that is a little robust to errors. For instance, if one of the URLs is wrong or the internet drops out then we would like it to just move onto the next PDF, and then warn us at the end that it missed one, not to stop. (This does not really matter because it is only 19 files, but it is easy to find oneself doing this for thousands of files).</li>
</ol>
<p>We will draw on <code>purrr</code> for this <span class="citation">(<a href="references-1.html#ref-citepurrr" role="doc-biblioref">Henry and Wickham 2020</a>)</span>.</p>
<div class="sourceCode" id="cb313"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://purrr.tidyverse.org">purrr</a></span><span class="op">)</span>

<span class="va">summary_tfr_dataset</span> <span class="op">&lt;-</span> 
  <span class="va">summary_tfr_dataset</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>pdf_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"dhs/year_"</span>, <span class="va">year</span>, <span class="st">".pdf"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb314"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html">walk2</a></span><span class="op">(</span>
  <span class="va">summary_tfr_dataset</span><span class="op">$</span><span class="va">url</span>,
  <span class="va">summary_tfr_dataset</span><span class="op">$</span><span class="va">pdf_name</span>,
  <span class="fu"><a href="https://purrr.tidyverse.org/reference/safely.html">safely</a></span><span class="op">(</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/utils/download.file.html">download.file</a></span><span class="op">(</span><span class="va">.x</span> , <span class="va">.y</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>Here we take <code><a href="https://rdrr.io/r/utils/download.file.html">download.file()</a></code> and pass it two arguments: <code>.x</code> and <code>.y</code>. Then <code><a href="https://purrr.tidyverse.org/reference/map2.html">walk2()</a></code> applies that function to the inputs that we give it, in this case the URLs columns is the <code>.x</code> and the pdf_names column is the <code>.y</code>. Finally, <code><a href="https://purrr.tidyverse.org/reference/safely.html">safely()</a></code> means that if there are any failures then it just moves onto the next file instead of throwing an error.</p>
<p>We now have each of the PDFs saved and we can move onto getting the data from them.</p>
<p>Now we need to get the data from the PDFs. As before, we are going to build on the code that we used before. That code (overly condensed) was:</p>
<div class="sourceCode" id="cb315"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dhs_2000</span> <span class="op">&lt;-</span> <span class="fu">pdftools</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/pdftools/reference/pdftools.html">pdf_text</a></span><span class="op">(</span><span class="st">"year_2000.pdf"</span><span class="op">)</span>

<span class="va">dhs_2000</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>raw_data <span class="op">=</span> <span class="va">dhs_2000</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="va">summary_tfr_dataset</span><span class="op">$</span><span class="va">page</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate_rows.html">separate_rows</a></span><span class="op">(</span><span class="va">raw_data</span>, sep <span class="op">=</span> <span class="st">"\\n"</span>, convert <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate.html">separate</a></span><span class="op">(</span>
    col <span class="op">=</span> <span class="va">raw_data</span>,
    into <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"state"</span>, <span class="st">"data"</span><span class="op">)</span>,
    sep <span class="op">=</span> <span class="st">"\\.{2,}"</span>,
    remove <span class="op">=</span> <span class="cn">FALSE</span>
  <span class="op">)</span> |&gt;
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_trim.html">str_squish</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate.html">separate</a></span><span class="op">(</span>
    col <span class="op">=</span> <span class="va">data</span>,
    into <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
      <span class="st">"number_of_births"</span>,
      <span class="st">"birth_rate"</span>,
      <span class="st">"fertility_rate"</span>,
      <span class="st">"TFR"</span>,
      <span class="st">"teen_births_all"</span>,
      <span class="st">"teen_births_15_17"</span>,
      <span class="st">"teen_births_18_19"</span>
    <span class="op">)</span>,
    sep <span class="op">=</span> <span class="st">"\\s"</span>,
    remove <span class="op">=</span> <span class="cn">FALSE</span>
  <span class="op">)</span> |&gt;
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">TFR</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="fl">13</span><span class="op">:</span><span class="fl">69</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fl">2000</span><span class="op">)</span>

<span class="va">dhs_2000</span></code></pre></div>
<p>The first thing that we want to iterate is the argument to <code><a href="https://docs.ropensci.org/pdftools/reference/pdftools.html">pdf_text()</a></code>, then the number in in <code><a href="https://dplyr.tidyverse.org/reference/slice.html">slice()</a></code> will also need to change (that is doing the work to get only the page that we are interested in).</p>
<p>Two aspects are hardcoded, and these may need to be updated. In particular:</p>
<ol style="list-style-type: decimal">
<li>The separate only works if each of the tables has the same columns in the same order; and</li>
<li>the slice (which restricts the data to just the states) only works in this case.</li>
</ol>
<p>Finally, we add the year only at the end, whereas we would need to bring that up earlier in the process.</p>
<p>We will start by writing a function that will go through all the files, grab the data, get the page of interest, and then expand the rows. We will then use <code><a href="https://purrr.tidyverse.org/reference/map2.html">pmap_dfr()</a></code> from <code>purrr</code> to apply that function to all of the PDFs and to output a tibble.</p>
<div class="sourceCode" id="cb316"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">get_pdf_convert_to_tibble</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">pdf_name</span>, <span class="va">page</span>, <span class="va">year</span><span class="op">)</span><span class="op">{</span>
  
  <span class="va">dhs_table_of_interest</span> <span class="op">&lt;-</span> 
    <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>raw_data <span class="op">=</span> <span class="fu">pdftools</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/pdftools/reference/pdftools.html">pdf_text</a></span><span class="op">(</span><span class="va">pdf_name</span><span class="op">)</span><span class="op">)</span> |&gt; 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="va">page</span><span class="op">)</span> |&gt; 
    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate_rows.html">separate_rows</a></span><span class="op">(</span><span class="va">raw_data</span>, sep <span class="op">=</span> <span class="st">"\\n"</span>, convert <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> |&gt; 
    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate.html">separate</a></span><span class="op">(</span>col <span class="op">=</span> <span class="va">raw_data</span>, 
             into <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"state"</span>, <span class="st">"data"</span><span class="op">)</span>, 
             sep <span class="op">=</span> <span class="st">"[�|\\.]\\s+(?=[[:digit:]])"</span>, 
             remove <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> |&gt; 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
      data <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_trim.html">str_squish</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>,
      year_of_data <span class="op">=</span> <span class="va">year</span><span class="op">)</span>

  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Done with"</span>, <span class="va">year</span><span class="op">)</span><span class="op">)</span>
  
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">dhs_table_of_interest</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">raw_dhs_data</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html">pmap_dfr</a></span><span class="op">(</span><span class="va">summary_tfr_dataset</span> |&gt; <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">pdf_name</span>, <span class="va">page</span>, <span class="va">year</span><span class="op">)</span>,
                                <span class="va">get_pdf_convert_to_tibble</span><span class="op">)</span>
<span class="co">#&gt; [1] "Done with 2000"</span>
<span class="co">#&gt; [1] "Done with 2001"</span>
<span class="co">#&gt; [1] "Done with 2002"</span>
<span class="co">#&gt; [1] "Done with 2003"</span>
<span class="co">#&gt; [1] "Done with 2004"</span>
<span class="co">#&gt; [1] "Done with 2005"</span>
<span class="co">#&gt; [1] "Done with 2006"</span>
<span class="co">#&gt; [1] "Done with 2007"</span>
<span class="co">#&gt; [1] "Done with 2008"</span>
<span class="co">#&gt; [1] "Done with 2009"</span>
<span class="co">#&gt; [1] "Done with 2010"</span>
<span class="co">#&gt; [1] "Done with 2011"</span>
<span class="co">#&gt; [1] "Done with 2012"</span>
<span class="co">#&gt; [1] "Done with 2013"</span>
<span class="co">#&gt; [1] "Done with 2014"</span>
<span class="co">#&gt; [1] "Done with 2015"</span>
<span class="co">#&gt; [1] "Done with 2016"</span>
<span class="co">#&gt; [1] "Done with 2016"</span>
<span class="co">#&gt; [1] "Done with 2017"</span>
<span class="co">#&gt; [1] "Done with 2017"</span>
<span class="co">#&gt; [1] "Done with 2018"</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">raw_dhs_data</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 × 4</span>
<span class="co">#&gt;   raw_data                          state data  year_of_data</span>
<span class="co">#&gt;   &lt;chr&gt;                             &lt;chr&gt; &lt;chr&gt;        &lt;dbl&gt;</span>
<span class="co">#&gt; 1 "40 National Vital Statistics Re… "40 … 50, …         2000</span>
<span class="co">#&gt; 2 ""                                ""    &lt;NA&gt;          2000</span>
<span class="co">#&gt; 3 "Table 10. Number of births, bir… "Tab… &lt;NA&gt;          2000</span>
<span class="co">#&gt; 4 "United States, each State and t… "Uni… &lt;NA&gt;          2000</span>
<span class="co">#&gt; 5 "[By place of residence. Birth r… "[By… &lt;NA&gt;          2000</span>
<span class="co">#&gt; 6 "estimated in each area; total f… "est… &lt;NA&gt;          2000</span></code></pre></div>
<p>Now we need to clean up the state names and then filter on them.</p>
<div class="sourceCode" id="cb317"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">states</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Alabama"</span>, <span class="st">"Alaska"</span>, <span class="st">"Arizona"</span>, <span class="st">"Arkansas"</span>, <span class="st">"California"</span>, <span class="st">"Colorado"</span>, 
            <span class="st">"Connecticut"</span>, <span class="st">"Delaware"</span>, <span class="st">"Florida"</span>, <span class="st">"Georgia"</span>, <span class="st">"Hawaii"</span>, <span class="st">"Idaho"</span>, 
            <span class="st">"Illinois"</span>, <span class="st">"Indiana"</span>, <span class="st">"Iowa"</span>, <span class="st">"Kansas"</span>, <span class="st">"Kentucky"</span>, <span class="st">"Louisiana"</span>, 
            <span class="st">"Maine"</span>, <span class="st">"Maryland"</span>, <span class="st">"Massachusetts"</span>, <span class="st">"Michigan"</span>, <span class="st">"Minnesota"</span>, 
            <span class="st">"Mississippi"</span>, <span class="st">"Missouri"</span>, <span class="st">"Montana"</span>, <span class="st">"Nebraska"</span>, <span class="st">"Nevada"</span>, 
            <span class="st">"New Hampshire"</span>, <span class="st">"New Jersey"</span>, <span class="st">"New Mexico"</span>, <span class="st">"New York"</span>, <span class="st">"North Carolina"</span>, 
            <span class="st">"North Dakota"</span>, <span class="st">"Ohio"</span>, <span class="st">"Oklahoma"</span>, <span class="st">"Oregon"</span>, <span class="st">"Pennsylvania"</span>, 
            <span class="st">"Rhode Island"</span>, <span class="st">"South Carolina"</span>, <span class="st">"South Dakota"</span>, <span class="st">"Tennessee"</span>, <span class="st">"Texas"</span>, 
            <span class="st">"Utah"</span>, <span class="st">"Vermont"</span>, <span class="st">"Virginia"</span>, <span class="st">"Washington"</span>, <span class="st">"West Virginia"</span>, <span class="st">"Wisconsin"</span>, 
            <span class="st">"Wyoming"</span>, <span class="st">"District of Columbia"</span><span class="op">)</span>

<span class="va">raw_dhs_data</span> <span class="op">&lt;-</span> 
  <span class="va">raw_dhs_data</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>state <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove_all</a></span><span class="op">(</span><span class="va">state</span>, <span class="st">"\\."</span><span class="op">)</span>,
         state <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove_all</a></span><span class="op">(</span><span class="va">state</span>, <span class="st">"�"</span><span class="op">)</span>,
         state <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove_all</a></span><span class="op">(</span><span class="va">state</span>, <span class="st">"\u0008"</span><span class="op">)</span>,
         state <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op">(</span><span class="va">state</span>, <span class="st">"United States 1"</span>, <span class="st">"United States"</span><span class="op">)</span>,
         state <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op">(</span><span class="va">state</span>, <span class="st">"United States1"</span>, <span class="st">"United States"</span><span class="op">)</span>,
         state <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op">(</span><span class="va">state</span>, <span class="st">"United States 2"</span>, <span class="st">"United States"</span><span class="op">)</span>,
         state <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op">(</span><span class="va">state</span>, <span class="st">"United States2"</span>, <span class="st">"United States"</span><span class="op">)</span>,
         state <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op">(</span><span class="va">state</span>, <span class="st">"United States²"</span>, <span class="st">"United States"</span><span class="op">)</span>,
         <span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>state <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_trim.html">str_squish</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">state</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">states</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">raw_dhs_data</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 × 4</span>
<span class="co">#&gt;   raw_data                          state data  year_of_data</span>
<span class="co">#&gt;   &lt;chr&gt;                             &lt;chr&gt; &lt;chr&gt;        &lt;dbl&gt;</span>
<span class="co">#&gt; 1 Alabama ........................… Alab… 63,2…         2000</span>
<span class="co">#&gt; 2 Alaska .........................… Alas… 9,97…         2000</span>
<span class="co">#&gt; 3 Arizona ........................… Ariz… 85,2…         2000</span>
<span class="co">#&gt; 4 Arkansas .......................… Arka… 37,7…         2000</span>
<span class="co">#&gt; 5 California .....................… Cali… 531,…         2000</span>
<span class="co">#&gt; 6 Colorado .......................… Colo… 65,4…         2000</span></code></pre></div>
<p>The next step is to separate the data and get the correct column from it. We are going to separate based on spaces once it is cleaned up.</p>
<div class="sourceCode" id="cb318"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">raw_dhs_data</span> <span class="op">&lt;-</span> 
  <span class="va">raw_dhs_data</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove_all</a></span><span class="op">(</span><span class="va">data</span>, <span class="st">"\\*"</span><span class="op">)</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate.html">separate</a></span><span class="op">(</span><span class="va">data</span>, into <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"col_1"</span>, <span class="st">"col_2"</span>, <span class="st">"col_3"</span>, <span class="st">"col_4"</span>, <span class="st">"col_5"</span>, 
                          <span class="st">"col_6"</span>, <span class="st">"col_7"</span>, <span class="st">"col_8"</span>, <span class="st">"col_9"</span>, <span class="st">"col_10"</span><span class="op">)</span>, 
           sep <span class="op">=</span> <span class="st">" "</span>,
           remove <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">raw_dhs_data</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 × 14</span>
<span class="co">#&gt;   raw_data   state data  col_1 col_2 col_3 col_4 col_5 col_6</span>
<span class="co">#&gt;   &lt;chr&gt;      &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;</span>
<span class="co">#&gt; 1 Alabama .… Alab… 63,2… 63,2… 14.4  65.0  2,02… 62.9  37.9 </span>
<span class="co">#&gt; 2 Alaska ..… Alas… 9,97… 9,974 16.0  74.6  2,43… 42.4  23.6 </span>
<span class="co">#&gt; 3 Arizona .… Ariz… 85,2… 85,2… 17.5  84.4  2,65… 69.1  41.1 </span>
<span class="co">#&gt; 4 Arkansas … Arka… 37,7… 37,7… 14.7  69.1  2,14… 68.5  36.7 </span>
<span class="co">#&gt; 5 Californi… Cali… 531,… 531,… 15.8  70.7  2,18… 48.5  28.6 </span>
<span class="co">#&gt; 6 Colorado … Colo… 65,4… 65,4… 15.8  73.1  2,35… 49.2  28.6 </span>
<span class="co">#&gt; # … with 5 more variables: col_7 &lt;chr&gt;, col_8 &lt;chr&gt;,</span>
<span class="co">#&gt; #   col_9 &lt;chr&gt;, col_10 &lt;chr&gt;, year_of_data &lt;dbl&gt;</span></code></pre></div>
<p>We can now grab the correct column.</p>
<div class="sourceCode" id="cb319"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tfr_data</span> <span class="op">&lt;-</span> 
  <span class="va">raw_dhs_data</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>TFR <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">year_of_data</span> <span class="op">&lt;</span> <span class="fl">2008</span>, <span class="va">col_4</span>, <span class="va">col_3</span><span class="op">)</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">year_of_data</span>, <span class="va">TFR</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>year <span class="op">=</span> <span class="va">year_of_data</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">tfr_data</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 × 3</span>
<span class="co">#&gt;   state       year TFR    </span>
<span class="co">#&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;chr&gt;  </span>
<span class="co">#&gt; 1 Alabama     2000 2,021.0</span>
<span class="co">#&gt; 2 Alaska      2000 2,437.0</span>
<span class="co">#&gt; 3 Arizona     2000 2,652.5</span>
<span class="co">#&gt; 4 Arkansas    2000 2,140.0</span>
<span class="co">#&gt; 5 California  2000 2,186.0</span>
<span class="co">#&gt; 6 Colorado    2000 2,356.5</span></code></pre></div>
<p>Finally, we need to convert the case.</p>
<div class="sourceCode" id="cb320"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">tfr_data</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 × 3</span>
<span class="co">#&gt;   state       year TFR    </span>
<span class="co">#&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;chr&gt;  </span>
<span class="co">#&gt; 1 Alabama     2000 2,021.0</span>
<span class="co">#&gt; 2 Alaska      2000 2,437.0</span>
<span class="co">#&gt; 3 Arizona     2000 2,652.5</span>
<span class="co">#&gt; 4 Arkansas    2000 2,140.0</span>
<span class="co">#&gt; 5 California  2000 2,186.0</span>
<span class="co">#&gt; 6 Colorado    2000 2,356.5</span>

<span class="va">tfr_data</span> <span class="op">&lt;-</span> 
  <span class="va">tfr_data</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>TFR <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove_all</a></span><span class="op">(</span><span class="va">TFR</span>, <span class="st">","</span><span class="op">)</span>,
         TFR <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">TFR</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">tfr_data</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 × 3</span>
<span class="co">#&gt;   state       year   TFR</span>
<span class="co">#&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co">#&gt; 1 Alabama     2000 2021 </span>
<span class="co">#&gt; 2 Alaska      2000 2437 </span>
<span class="co">#&gt; 3 Arizona     2000 2652.</span>
<span class="co">#&gt; 4 Arkansas    2000 2140 </span>
<span class="co">#&gt; 5 California  2000 2186 </span>
<span class="co">#&gt; 6 Colorado    2000 2356.</span></code></pre></div>
<p>And run some checks.</p>
<div class="sourceCode" id="cb321"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tfr_data</span><span class="op">$</span><span class="va">state</span> <span class="op"><a href="https://purrr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://purrr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="op">)</span> <span class="op">==</span> <span class="fl">51</span>
<span class="co">#&gt; [1] TRUE</span>

<span class="va">tfr_data</span><span class="op">$</span><span class="va">year</span> <span class="op"><a href="https://purrr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://purrr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="op">)</span> <span class="op">==</span> <span class="fl">19</span>
<span class="co">#&gt; [1] TRUE</span></code></pre></div>
<p>In particular we want for there to be 51 states and for there to be 19 years.</p>
<p>And we are done (Table <a href="gather-data.html#tab:tfrforthewin">9.3</a>)!</p>
<div class="sourceCode" id="cb322"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tfr_data</span> |&gt;
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span> |&gt;
  <span class="fu">knitr</span><span class="fu">::</span> <span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span>
    caption <span class="op">=</span> <span class="st">"First ten rows of a dataset of TFR by US state, 2000-2019"</span>,
    col.names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"State"</span>, <span class="st">"Year"</span>, <span class="st">"TFR"</span><span class="op">)</span>,
    digits <span class="op">=</span> <span class="fl">0</span>,
    booktabs <span class="op">=</span> <span class="cn">TRUE</span>, 
    linesep <span class="op">=</span> <span class="st">""</span>,
    format.args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>big.mark <span class="op">=</span> <span class="st">","</span><span class="op">)</span>
  <span class="op">)</span></code></pre></div>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:tfrforthewin">Table 9.3: </span>First ten rows of a dataset of TFR by US state, 2000-2019</caption>
<thead><tr class="header">
<th align="left">State</th>
<th align="right">Year</th>
<th align="right">TFR</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Alabama</td>
<td align="right">2,000</td>
<td align="right">2,021</td>
</tr>
<tr class="even">
<td align="left">Alaska</td>
<td align="right">2,000</td>
<td align="right">2,437</td>
</tr>
<tr class="odd">
<td align="left">Arizona</td>
<td align="right">2,000</td>
<td align="right">2,652</td>
</tr>
<tr class="even">
<td align="left">Arkansas</td>
<td align="right">2,000</td>
<td align="right">2,140</td>
</tr>
<tr class="odd">
<td align="left">California</td>
<td align="right">2,000</td>
<td align="right">2,186</td>
</tr>
<tr class="even">
<td align="left">Colorado</td>
<td align="right">2,000</td>
<td align="right">2,356</td>
</tr>
<tr class="odd">
<td align="left">Connecticut</td>
<td align="right">2,000</td>
<td align="right">1,932</td>
</tr>
<tr class="even">
<td align="left">Delaware</td>
<td align="right">2,000</td>
<td align="right">2,014</td>
</tr>
<tr class="odd">
<td align="left">District of Columbia</td>
<td align="right">2,000</td>
<td align="right">1,976</td>
</tr>
<tr class="even">
<td align="left">Florida</td>
<td align="right">2,000</td>
<td align="right">2,158</td>
</tr>
</tbody>
</table></div>
<!-- ## Semi-structured --><!-- ### JSON and XML --><!-- @benoit2020text --><!-- Text data is all around us, and in many cases is some of the earliest types of data that we are exposed to. Recent increases in computational power, the development of new methods, and the enormous availability of text, means that there has been a great deal of interest in using text as data. Initial methods tend to focus, essentially, on converting text into numbers and then analyzing them using traditional methods. More recent methods have begun to take advantage of the structure that is inherent in text, to draw additional meaning. The difference is perhaps akin to a child who can group similar colors, compared with a child who knows what objects are; although both crocodiles and trees are green, and you can do something with that knowledge, you can do more by knowing that a crocodile could eat you, and a tree probably won't. --><!-- Here we cover a variety of techniques designed to equip you with the basics of using text as data. One of the great things about text data is that it is typically not generated for the purposes of our analysis. That is great because it removes one of the unobservable variables that we typically have to worry about. The trade-off is that we typically have to do a bunch more work to get it into a form that we can work with. -->
</div>
<div id="optical-character-recognition" class="section level3" number="9.4.2">
<h3>
<span class="header-section-number">9.4.2</span> Optical Character Recognition<a class="anchor" aria-label="anchor" href="#optical-character-recognition"><i class="fas fa-link"></i></a>
</h3>
<p>All of the above is predicated on having a PDF that is already ‘digitized’. But what if it is images? In that case we need to first use Optical Character Recognition (OCR) using <code>tesseract</code> <span class="citation">(<a href="references-1.html#ref-citetesseract" role="doc-biblioref">Ooms 2019c</a>)</span>. This is a R wrapper around the Tesseract open-source OCR engine.</p>
<p>Let us see an example with a scan from the first page of Jane Eyre (Figure <a href="gather-data.html#fig:janescan">9.16</a>).</p>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:janescan"></span>
<img src="figures/jane_scan.png" alt="Scan of first page of Jane Eyre" width="90%"><p class="caption">
Figure 9.16: Scan of first page of Jane Eyre
</p>
</div>
<div class="sourceCode" id="cb323"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/tesseract/">tesseract</a></span><span class="op">)</span>

<span class="va">text</span> <span class="op">&lt;-</span> <span class="fu">tesseract</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/tesseract/reference/ocr.html">ocr</a></span><span class="op">(</span><span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"jane_scan.png"</span><span class="op">)</span>, engine <span class="op">=</span> <span class="fu"><a href="https://docs.ropensci.org/tesseract/reference/tesseract.html">tesseract</a></span><span class="op">(</span><span class="st">"eng"</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="va">text</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="exercises-and-tutorial-8" class="section level2" number="9.5">
<h2>
<span class="header-section-number">9.5</span> Exercises and tutorial<a class="anchor" aria-label="anchor" href="#exercises-and-tutorial-8"><i class="fas fa-link"></i></a>
</h2>
<div id="exercises-8" class="section level3" number="9.5.1">
<h3>
<span class="header-section-number">9.5.1</span> Exercises<a class="anchor" aria-label="anchor" href="#exercises-8"><i class="fas fa-link"></i></a>
</h3>
<ol style="list-style-type: decimal">
<li>What are some types of probability sampling, and in what circumstances might you want to implement them (write two or three pages)?</li>
<li>There have been some substantial political polling ‘misses’ in recent years (Trump and Brexit come to mind). To what extent do you think non-response bias was the cause of this (write a page or two, being sure to ground your writing with citations)?</li>
<li>It seems like a lot of businesses have closed since the pandemic. To investigate this, we walk along some blocks downtown and count the number of businesses that are closed and open. To decide which blocks to walk, we open a map, start at the lake, and then pick every 10th street. This type of sampling is (pick one)?
<ol style="list-style-type: lower-alpha">
<li>Cluster sampling.</li>
<li>Systematic sampling.</li>
<li>Stratified sampling.</li>
<li>Convenience sampling.</li>
</ol>
</li>
<li>Please name some reasons why you may wish to use cluster sampling (select all)?
<ol style="list-style-type: lower-alpha">
<li>Balance in responses.</li>
<li>Administrative convenience.</li>
<li>Efficiency in terms of money.</li>
<li>Underlying systematic concerns.</li>
<li>Estimation of sub-populations.</li>
</ol>
</li>
<li>Please consider Beaumont, 2020, ‘Are probability surveys bound to disappear for the production of official statistics?’. With reference to that paper, do you think that probability surveys will disappear, and why or why not (please write a paragraph or two)?</li>
<li>In your own words, what is an API (write a paragraph or two)?</li>
<li>Find two APIs and discuss how you could use them to tell interesting stories (write a paragraph or two for each)?</li>
<li>Find two APIs that have an R packages written around them. How could you use these to tell interesting stories (write a paragraph or two)?</li>
<li>What is the main argument to <code><a href="https://httr.r-lib.org/reference/GET.html">httr::GET()</a></code> (pick one)?
<ol style="list-style-type: lower-alpha">
<li>‘url’</li>
<li>‘website’</li>
<li>‘domain’</li>
<li>‘location’</li>
</ol>
</li>
<li>What are three reasons why we should be respectful when getting scraping data from websites (write a paragraph or two)?</li>
<li>What features of a website do we typically take advantage of when we parse the code (pick on)?
<ol style="list-style-type: lower-alpha">
<li>HTML/CSS mark-up.</li>
<li>Cookies.</li>
<li>Facebook beacons.</li>
<li>Code comments.</li>
</ol>
</li>
<li>What are three advantages and three disadvantages of scraping compared with using an API (write a paragraph or two)?</li>
<li>What are three delimiters that could be useful when trying to bring order to the PDF that you read in as a character vector (write a paragraph or two)?</li>
<li>Which of the following, used as part of a regular expression, would match a full stop (hint: see the ‘strings’ cheat sheet) (pick one)?
<ol style="list-style-type: lower-alpha">
<li>‘.’</li>
<li>‘.’</li>
<li>‘\.’</li>
<li>‘\.’</li>
</ol>
</li>
<li>Name three reasons for sketching out what you want before starting to try to extract data from a PDF (write a paragraph or two for each)?</li>
<li>What are three checks that we might like to use for demographic data, such as the number of births in a country in a particular year (write a paragraph or two for check)?</li>
<li>What are three checks that we might like to use for economic data, such as GDP for a particular country in a particular year (write a paragraph or two for check)?</li>
<li>What does the <code>purrr</code> package do (select all that apply)?
<ol style="list-style-type: lower-alpha">
<li>Enhances R’s functional programming toolkit.</li>
<li>Makes loops easier to code and read.</li>
<li>Checks the consistency of datasets.</li>
<li>Identifies issues in data structures and proposes replacements.</li>
</ol>
</li>
<li>Which of these are functions from the <code>purrr</code> package (select all that apply)?
<ol style="list-style-type: lower-alpha">
<li><code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code></li>
<li><code><a href="https://purrr.tidyverse.org/reference/map.html">walk()</a></code></li>
<li><code>run()</code></li>
<li><code><a href="https://purrr.tidyverse.org/reference/safely.html">safely()</a></code></li>
</ol>
</li>
<li>What are some principles to follow when scraping (select all that apply)?
<ol style="list-style-type: lower-alpha">
<li>Avoid it if possible</li>
<li>Follow the site’s guidance</li>
<li>Slow down</li>
<li>Use a scalpel not an axe.<br>
</li>
</ol>
</li>
<li>What is a robots.txt file (pick one)?
<ol style="list-style-type: lower-alpha">
<li>The instructions that Frankenstein followed.</li>
<li>Notes that web scrapers should follow when scraping.</li>
</ol>
</li>
<li>What is the html tag for an item in list (pick one)?
<ol style="list-style-type: lower-alpha">
<li><code>li</code></li>
<li><code>body</code></li>
<li><code>b</code></li>
<li><code>em</code></li>
</ol>
</li>
<li>Which function should we use if we have the following text data: ‘rohan_alexander’ in a column called ‘names’ and want to split it into first name and surname based on the underbar (pick one)?
<ol style="list-style-type: lower-alpha">
<li><code><a href="https://tidyr.tidyverse.org/reference/separate.html">separate()</a></code></li>
<li><code><a href="https://dplyr.tidyverse.org/reference/slice.html">slice()</a></code></li>
<li><code>spacing()</code></li>
<li><code>text_to_columns()</code></li>
</ol>
</li>
</ol>
</div>
<div id="tutorial-8" class="section level3" number="9.5.2">
<h3>
<span class="header-section-number">9.5.2</span> Tutorial<a class="anchor" aria-label="anchor" href="#tutorial-8"><i class="fas fa-link"></i></a>
</h3>
<p>Please redo the web scraping example, but for one of: <a href="https://en.wikipedia.org/wiki/List_of_prime_ministers_of_Australia">Australia</a>, <a href="https://en.wikipedia.org/wiki/List_of_prime_ministers_of_Canada">Canada</a>, <a href="https://en.wikipedia.org/wiki/List_of_prime_ministers_of_India">India</a>, or <a href="https://en.wikipedia.org/wiki/List_of_prime_ministers_of_New_Zealand">New Zealand</a>.</p>
<p>Plan, gather, and clean the data, and then use it to create a similar table to the one created above. Write a few paragraphs about your findings. Then write a few paragraphs about the data source, what you gathered, and how you went about it. What took longer than you expected? When did it become fun? What would you do differently next time you do this? Your submission should be at least two pages and likely more.</p>
<p>Please submit a link to a PDF produced using R Markdown that includes a link to the GitHub repo.</p>

</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="farm-data.html"><span class="header-section-number">8</span> Farm data</a></div>
<div class="next"><a href="hunt-data.html"><span class="header-section-number">10</span> Hunt data</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#gather-data"><span class="header-section-number">9</span> Gather data</a></li>
<li><a class="nav-link" href="#introduction-6"><span class="header-section-number">9.1</span> Introduction</a></li>
<li>
<a class="nav-link" href="#apis"><span class="header-section-number">9.2</span> APIs</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#case-study-gathering-data-from-arxiv-nasa-and-dataverse"><span class="header-section-number">9.2.1</span> Case study: Gathering data from arXiv, NASA, and Dataverse</a></li>
<li><a class="nav-link" href="#case-study-gathering-data-from-twitter"><span class="header-section-number">9.2.2</span> Case study: Gathering data from Twitter</a></li>
<li><a class="nav-link" href="#case-study-gathering-data-from-spotify"><span class="header-section-number">9.2.3</span> Case study: Gathering data from Spotify</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#web-scraping"><span class="header-section-number">9.3</span> Web scraping</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#case-study-web-scraping-book-information"><span class="header-section-number">9.3.1</span> Case study: Web scraping book information</a></li>
<li><a class="nav-link" href="#case-study-web-scraping-uk-prime-ministers-from-wikipedia"><span class="header-section-number">9.3.2</span> Case study: Web scraping UK Prime Ministers from Wikipedia</a></li>
<li><a class="nav-link" href="#case-study-downloading-multiple-files"><span class="header-section-number">9.3.3</span> Case study: Downloading multiple files</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#pdfs"><span class="header-section-number">9.4</span> PDFs</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#case-study-gathering-data-on-the-us-total-fertility-rate"><span class="header-section-number">9.4.1</span> Case-study: Gathering data on the US Total Fertility Rate</a></li>
<li><a class="nav-link" href="#optical-character-recognition"><span class="header-section-number">9.4.2</span> Optical Character Recognition</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#exercises-and-tutorial-8"><span class="header-section-number">9.5</span> Exercises and tutorial</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#exercises-8"><span class="header-section-number">9.5.1</span> Exercises</a></li>
<li><a class="nav-link" href="#tutorial-8"><span class="header-section-number">9.5.2</span> Tutorial</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/rstudio/bookdown-demo/blob/master/21-gather.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/rstudio/bookdown-demo/edit/master/21-gather.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Telling Stories With Data</strong>" was written by Rohan Alexander. It was last built on 20 March, 2022.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
